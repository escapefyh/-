# 图片识别分类接口文档（前端版）

## 概述

商品发布时，上传第一张图片后自动调用此接口识别商品分类，系统会推荐分类ID和名称，商家可以接受推荐或手动修改。

---

## 接口信息

### 图片识别接口

**接口地址：** `http://localhost:3000/recognize`

**请求方法：** `POST`

**Content-Type：** `multipart/form-data`

**说明：** 上传商品图片，系统自动识别并返回推荐的商品分类

---

## 请求参数

### 表单数据

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| image | File | 是 | 商品图片文件（第一张上传的图片） |

### 请求限制

- **支持的图片格式：** JPG、JPEG、PNG
- **文件大小限制：** 最大 10MB
- **图片尺寸建议：** 不超过 4096x4096 像素

---

## 响应格式

### 成功响应

```json
{
  "category_id": 1,
  "category_name": "美食生鲜",
  "confidence": 0.95
}
```

#### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| category_id | Integer | 商品分类ID（1-13） |
| category_name | String | 商品分类名称 |
| confidence | Float | 识别置信度（0-1之间，可选） |

### 错误响应

#### 错误1：图片格式不支持

```json
{
  "error": "图片格式不支持",
  "message": "仅支持 JPG、PNG 格式的图片"
}
```

#### 错误2：图片大小超限

```json
{
  "error": "图片格式不支持",
  "message": "图片大小超过限制（最大10MB）"
}
```

#### 错误3：识别失败

```json
{
  "error": "图片识别失败",
  "message": "无法识别图片内容，请手动选择分类"
}
```

#### 错误4：识别服务不可用

```json
{
  "error": "图片识别失败",
  "message": "识别服务不可用，请稍后重试或手动选择分类"
}
```

---

## 商品分类列表

识别接口返回的 `category_id` 和 `category_name` 对应关系如下：

| category_id | category_name |
|-------------|---------------|
| 1 | 美食生鲜 |
| 2 | 美妆个护 |
| 3 | 家居百货 |
| 4 | 数码家电 |
| 5 | 服饰鞋包 |
| 6 | 母婴用品 |
| 7 | 运动户外 |
| 8 | 图书文娱 |
| 9 | 宠物用品 |
| 10 | 食品保健 |
| 11 | 汽车用品 |
| 12 | 办公文具 |
| 13 | 其他用品 |

---

## 前端调用示例

### 微信小程序调用示例

#### 方式一：使用 wx.uploadFile（推荐）

```javascript
/**
 * 识别商品分类
 * @param {string} filePath 本地图片文件路径
 * @returns {Promise<Object>} 返回识别结果 {category_id, category_name, confidence}
 */
const recognizeCategory = (filePath) => {
  return new Promise((resolve, reject) => {
    wx.uploadFile({
      url: 'http://localhost:3000/recognize',
      filePath: filePath,
      name: 'image', // 表单字段名，必须为 'image'
      success: (res) => {
        try {
          const result = JSON.parse(res.data);
          
          // 检查是否有错误
          if (result.error) {
            reject(new Error(result.message || result.error));
            return;
          }
          
          // 返回识别结果
          resolve({
            category_id: result.category_id,
            category_name: result.category_name,
            confidence: result.confidence
          });
        } catch (e) {
          reject(new Error('解析识别结果失败：' + e.message));
        }
      },
      fail: (err) => {
        reject(new Error('网络请求失败：' + (err.errMsg || '未知错误')));
      }
    });
  });
};
```

#### 使用示例

```javascript
// 在商品发布页面使用
Page({
  data: {
    selectedCategoryId: null,
    selectedCategoryName: '',
    categoryList: [
      { category_id: 1, name: '美食生鲜' },
      { category_id: 2, name: '美妆个护' },
      // ... 其他分类
    ]
  },

  /**
   * 选择图片后自动识别分类
   */
  async chooseImage() {
    const that = this;
    
    wx.chooseImage({
      count: 1,
      success: async (res) => {
        const tempFilePath = res.tempFilePaths[0];
        
        // 如果已经有分类了，不自动识别
        if (that.data.selectedCategoryId) {
          return;
        }

        // 显示加载提示
        wx.showLoading({
          title: '正在识别商品分类...',
          mask: true
        });

        try {
          // 调用识别接口
          const result = await recognizeCategory(tempFilePath);
          
          wx.hideLoading();

          // 自动填充分类
          const categoryIndex = that.data.categoryList.findIndex(
            cat => cat.category_id === result.category_id
          );

          that.setData({
            selectedCategoryId: result.category_id,
            selectedCategoryName: result.category_name,
            categoryIndex: categoryIndex >= 0 ? categoryIndex : -1,
            autoDetectedCategory: true // 标记为自动识别
          });

          // 显示识别成功提示
          wx.showToast({
            title: `已识别为：${result.category_name}`,
            icon: 'success',
            duration: 2000
          });
        } catch (error) {
          wx.hideLoading();
          console.error('图片识别失败:', error);
          
          // 显示识别失败提示（不影响用户继续操作）
          wx.showToast({
            title: error.message || '识别失败，请手动选择分类',
            icon: 'none',
            duration: 2000
          });
        }
      }
    });
  },

  /**
   * 用户手动选择分类（清除自动识别标记）
   */
  selectCategory(e) {
    const category = e.currentTarget.dataset.category;
    this.setData({
      selectedCategoryId: category.category_id,
      selectedCategoryName: category.name,
      autoDetectedCategory: false // 清除自动识别标记
    });
  }
});
```

### 方式二：使用 uni.uploadFile（uni-app）

```javascript
/**
 * 识别商品分类（uni-app版本）
 */
const recognizeCategory = (filePath) => {
  return new Promise((resolve, reject) => {
    uni.uploadFile({
      url: 'http://localhost:3000/recognize',
      filePath: filePath,
      name: 'image',
      success: (res) => {
        try {
          const result = JSON.parse(res.data);
          if (result.error) {
            reject(new Error(result.message || result.error));
            return;
          }
          resolve({
            category_id: result.category_id,
            category_name: result.category_name,
            confidence: result.confidence
          });
        } catch (e) {
          reject(new Error('解析识别结果失败：' + e.message));
        }
      },
      fail: (err) => {
        reject(new Error('网络请求失败：' + err.errMsg));
      }
    });
  });
};
```

### 方式三：使用 axios（H5/React/Vue）

```javascript
import axios from 'axios';
import FormData from 'form-data';

/**
 * 识别商品分类（H5版本）
 * @param {File} imageFile 图片文件对象
 */
const recognizeCategory = async (imageFile) => {
  const formData = new FormData();
  formData.append('image', imageFile);

  try {
    const response = await axios.post('http://localhost:3000/recognize', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      },
      timeout: 30000 // 30秒超时
    });

    const result = response.data;
    
    if (result.error) {
      throw new Error(result.message || result.error);
    }

    return {
      category_id: result.category_id,
      category_name: result.category_name,
      confidence: result.confidence
    };
  } catch (error) {
    if (error.response && error.response.data) {
      throw new Error(error.response.data.message || error.response.data.error);
    }
    throw new Error('网络请求失败：' + error.message);
  }
};
```

---

## 完整的前端实现流程

### 1. 触发时机

- 用户上传第一张图片时，自动触发识别
- 如果用户已经手动选择了分类，不再自动识别
- 如果识别失败，不影响用户继续操作

### 2. 识别流程

```
用户上传图片
    ↓
检查是否已有分类？
    ↓ 否
显示"正在识别商品分类..."
    ↓
调用识别API（POST /recognize）
    ↓
解析识别结果
    ↓
自动填充分类
    ↓
显示"已识别为：XXX"提示
    ↓
标记为自动识别（显示"已自动识别"标签）
```

### 3. 用户修改

- 用户可以点击分类区域手动修改
- 用户手动选择后，清除"已自动识别"标记
- 用户修改分类不影响已上传的图片

### 4. 错误处理

- **识别失败：** 显示"识别失败，请手动选择分类"提示
- **网络错误：** 显示"网络请求失败"提示
- **无法匹配分类：** 显示"未能识别分类，请手动选择"提示
- **所有错误都不应阻塞用户继续操作**

---

## 注意事项

### 1. 网络配置

- **开发环境：** 接口地址为 `http://localhost:3000/recognize`
- **生产环境：** 需要将 `localhost:3000` 替换为实际的服务器地址
- **微信小程序：** 需要在微信公众平台配置合法域名，或使用开发工具的网络代理

### 2. 跨域问题

- 接口已配置 CORS，支持跨域请求
- 如果遇到跨域问题，检查服务器 CORS 配置

### 3. 性能优化

- 识别过程可能需要几秒钟，前端应显示加载提示
- 建议对图片进行压缩后再上传，减少传输时间
- 可以考虑异步识别，不阻塞用户继续操作

### 4. 用户体验

- **识别失败不应影响用户继续发布商品**
- **自动识别的分类应该明显标记**，让用户知道可以修改
- **用户手动修改分类后，应清除自动识别标记**
- **建议显示识别置信度**，让用户了解识别准确度

### 5. 错误处理建议

- **网络错误：** 提示用户检查网络连接
- **识别失败：** 提示用户手动选择分类（不影响继续操作）
- **无法匹配分类：** 提示用户手动选择分类
- **所有错误都应优雅处理，不中断用户流程**

---

## 测试建议

### 1. 功能测试

- ✅ 测试上传不同类别的商品图片
- ✅ 测试识别准确率
- ✅ 测试识别失败的情况
- ✅ 测试用户修改分类的功能

### 2. 边界测试

- ✅ 测试超大图片（接近10MB）
- ✅ 测试不支持的图片格式（GIF、WEBP等）
- ✅ 测试网络超时
- ✅ 测试识别服务不可用的情况

### 3. 用户体验测试

- ✅ 测试识别速度
- ✅ 测试提示信息是否清晰
- ✅ 测试修改分类的流程
- ✅ 测试错误处理是否友好

---

## 常见问题

### Q1: 识别服务返回的格式是什么？

A: 识别服务可能返回三种格式之一：
- `{category_id, category_name, confidence}` - 完整格式
- `{category_id, confidence}` - 只有ID
- `{category, confidence}` - 只有名称

接口会自动处理并统一返回 `{category_id, category_name, confidence}` 格式。

### Q2: 识别失败怎么办？

A: 识别失败时，接口会返回错误信息，前端应提示用户手动选择分类，但不影响用户继续发布商品。

### Q3: 识别服务不可用怎么办？

A: 如果识别服务连接失败，接口会返回相应错误，前端应提示用户手动选择分类。

### Q4: 如何判断识别结果是否可靠？

A: 可以通过 `confidence` 字段判断，值越高表示识别越可靠。建议 `confidence < 0.5` 时提示用户确认。

### Q5: 用户修改分类后，是否还需要识别？

A: 如果用户已经手动选择了分类，建议不再自动识别，避免覆盖用户的选择。

---

## 更新日志

- **2024-XX-XX**：初始版本，添加图片识别分类功能接口文档

---

## 联系方式

如有疑问，请联系后端开发团队。













