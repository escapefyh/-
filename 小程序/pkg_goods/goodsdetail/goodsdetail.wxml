<!--pages/goodsdetail/goodsdetail.wxml-->
<view class="goods-detail-page">
  <view wx:if="{{loading}}" class="loading-container">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="content">
    <!-- å•†å“å›¾ç‰‡è½®æ’­ï¼ˆæœ€é¡¶éƒ¨ï¼‰ -->
    <view class="image-section">
      <t-swiper
        wx:if="{{goods.images && goods.images.length > 0}}"
        list="{{goods.images}}"
        navigation="{{ { type: 'dots-bar' } }}"
        autoplay="{{false}}"
      />
    </view>

    <!-- å•†å“ä¿¡æ¯ï¼šä»·æ ¼ã€æ ‡é¢˜ã€æè¿° -->
    <view class="goods-info">
      <view class="price-section">
        <text class="price">Â¥{{goods.price}}</text>
        <view wx:if="{{goods.group_buy_enabled}}" class="group-buy-tag">
          <text>æ‹¼å›¢{{groupBuyDiscountText}}æŠ˜</text>
        </view>
      </view>
      
      <view class="description">{{goods.description}}</view>
      
      <view class="meta-info">
        <view class="meta-item">
          <text class="label">å‘å¸ƒæ—¶é—´ï¼š</text>
          <text class="value">{{createTime}}</text>
        </view>
        <view class="meta-item" wx:if="{{goods.sales_count !== undefined && goods.sales_count !== null}}">
          <text class="label">é”€é‡ï¼š</text>
          <text class="value sales-value">å·²å”®{{goods.sales_count}}ä»¶</text>
        </view>
      </view>
    </view>

    <!-- æ‹¼å›¢ä¿¡æ¯ï¼ˆä»…åœ¨å¼€å¯æ‹¼å›¢æ—¶æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{goods.group_buy_enabled}}" class="group-buy-info-section">
      <view class="group-buy-info-header">
        <text class="group-buy-info-title">æ‹¼å›¢ä¿¡æ¯</text>
      </view>
      <!-- æœ‰æ­£åœ¨æ‹¼å›¢çš„è®¢å• -->
      <view wx:if="{{groupBuyInfo && groupBuyCurrentCount > 0}}" class="group-buy-info-content">
        <view class="group-buy-status">
          <text class="group-buy-status-text">æ­£åœ¨æ‹¼å•ä¸­</text>
          <text class="group-buy-count-text">{{groupBuyCurrentCount}}/{{groupBuyRequiredCount}}äºº</text>
        </view>
        <view class="group-buy-remaining">
          <text class="group-buy-remaining-text">è¿˜å·® {{groupBuyRemainingCount}} äººæ‹¼å•æˆåŠŸ</text>
        </view>
        <!-- æ‹¼å›¢å€’è®¡æ—¶ -->
        <view wx:if="{{groupBuyInfo.expire_time}}" class="group-buy-timer">
          <text class="timer-label">å‰©ä½™æ—¶é—´ï¼š</text>
          <text class="timer-value">{{groupBuyInfo.expire_time_text || ''}}</text>
        </view>
      </view>
      <!-- æ²¡æœ‰æ­£åœ¨æ‹¼å›¢çš„è®¢å• -->
      <view wx:else class="group-buy-info-empty">
        <text class="group-buy-empty-text">æš‚æ— äººåœ¨æ‹¼å•ï¼Œå¿«æ¥å‘èµ·é¦–å•å§</text>
      </view>
    </view>

    <!-- å–å®¶ä¿¡æ¯ -->
    <view class="seller-section">
      <view class="seller-header">
        <image 
          class="seller-avatar" 
          src="{{seller.avatar || '/assets/default_avatar.png'}}" 
          mode="aspectFill"
          binderror="onAvatarError"
          bind:tap="onSellerAvatarClick"
        />
        <text class="seller-name">{{seller.nickname || seller.name || 'æœªè®¾ç½®æ˜µç§°'}}</text>
        <!-- å…³æ³¨æŒ‰é’®ï¼ˆéè‡ªå·±æ—¶æ˜¾ç¤ºï¼‰ -->
        <view wx:if="{{!isOwner}}" class="follow-btn-wrapper">
          <view 
            class="follow-btn {{isFollowed ? 'followed' : ''}}"
            bind:tap="onFollowClick"
          >
            <text class="follow-btn-text">{{isFollowed ? 'å·²å…³æ³¨' : '+ å…³æ³¨'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è¯„è®ºåŒº -->
    <view class="comment-section">
      <view class="comment-header">
        <text class="comment-title">å•†å“è¯„ä»·ï¼ˆ{{commentCount}}ï¼‰</text>
        <view wx:if="{{canComment}}" class="comment-tip" bind:tap="onShowCommentModal">
          <text class="comment-tip-text">ğŸ’¬ å»è¯„ä»·</text>
        </view>
      </view>

      <!-- è¯„ä»·æé†’ï¼ˆå·²å®Œæˆäº¤æ˜“ä½†æœªè¯„ä»·ï¼‰ -->
      <view wx:if="{{showCommentReminder}}" class="comment-reminder">
        <text class="reminder-text">æ‚¨å·²å®Œæˆè¯¥å•†å“çš„äº¤æ˜“ï¼Œå¿«æ¥è¯„ä»·ä¸€ä¸‹å§~</text>
        <view class="reminder-btn" bind:tap="onShowCommentModal">
          <text>ç«‹å³è¯„ä»·</text>
        </view>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view wx:if="{{commentList.length > 0}}" class="comment-list">
        <view 
          wx:for="{{commentList}}" 
          wx:key="comment_id"
          wx:for-item="comment"
          class="comment-item"
        >
          <view class="comment-user-info">
            <image 
              class="comment-avatar" 
              src="{{comment.user_avatar || '/assets/default_avatar.png'}}" 
              mode="aspectFill"
            />
            <view class="comment-user-detail">
              <text class="comment-user-name">{{comment.user_nickname || 'åŒ¿åç”¨æˆ·'}}</text>
              <text class="comment-time">{{comment.create_time_formatted}}</text>
            </view>
            <view class="comment-rating">
              <text wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:for-item="starIndex" class="star {{comment.rating >= starIndex ? 'star-filled' : 'star-empty'}}">â˜…</text>
            </view>
          </view>
          <view class="comment-content">{{comment.content}}</view>
          <view wx:if="{{comment.images && comment.images.length > 0}}" class="comment-images">
            <image 
              wx:for="{{comment.images}}" 
              wx:key="index"
              wx:for-item="img"
              class="comment-image" 
              src="{{img}}" 
              mode="aspectFill"
              bind:tap="onPreviewCommentImage"
              data-url="{{img}}"
              data-urls="{{comment.images}}"
            />
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:else class="comment-empty">
        <text>æš‚æ— è¯„ä»·ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªè¯„ä»·çš„äººå§~</text>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{commentHasMore && commentList.length > 0}}" class="comment-load-more" bind:tap="loadMoreComments">
        <text>åŠ è½½æ›´å¤š</text>
      </view>
    </view>

  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-action-bar">
    <!-- æ¶ˆæ¯å›¾æ ‡ï¼ˆæ˜¾ç¤ºè¯„è®ºæ•°ï¼‰ -->
    <view class="action-item" bind:tap="onCommentClick">
      <image class="action-icon" src="/assets/message.png" mode="aspectFit" />
      <text class="action-count">{{commentCount}}</text>
    </view>
    
    <!-- æ”¶è—å›¾æ ‡ï¼ˆæ˜¾ç¤ºæ”¶è—æ•°ï¼‰ -->
    <view class="action-item" bind:tap="onFavoriteClick">
      <image 
        class="action-icon" 
        src="{{isFavorited ? '/assets/Collection_filled.png' : '/assets/Collection.png'}}" 
        mode="aspectFit" 
      />
      <text class="action-count">{{favoriteCount}}</text>
    </view>

    <!-- èŠä¸€èŠæŒ‰é’® -->
    <view class="chat-btn" bind:tap="onChatClick">
      <text class="chat-text">èŠä¸€èŠ</text>
    </view>

    <!-- è´­ä¹°æŒ‰é’®åŒºåŸŸ -->
    <!-- å¦‚æœæ˜¯å•†å®¶è‡ªå·±ï¼Œæ˜¾ç¤ºç®¡ç†æŒ‰é’® -->
    <view wx:if="{{isOwner}}" class="manage-btn-wrapper">
      <view class="buy-btn manage-btn" bind:tap="onManageClick">
        <text class="buy-label">ç®¡ç†</text>
      </view>
    </view>
    
    <!-- å¦‚æœæ˜¯å…¶ä»–ç”¨æˆ·ï¼Œæ˜¾ç¤ºè´­ä¹°æŒ‰é’® -->
    <view wx:else class="buy-buttons">
      <!-- æœªå¼€å¯æ‹¼å›¢ï¼šåªæ˜¾ç¤ºç›´æ¥ä¹° -->
      <view wx:if="{{!goods.group_buy_enabled}}" class="buy-btn gray-btn" bind:tap="onBuyClick">
        <text class="buy-price">Â¥{{goods.price}}</text>
        <text class="buy-label">ç›´æ¥ä¹°</text>
      </view>

      <!-- å¼€å¯æ‹¼å›¢ï¼šæ˜¾ç¤ºä¸¤ä¸ªè´­ä¹°é€‰é¡¹ -->
      <view wx:else class="buy-buttons-group">
        <view class="buy-btn gray-btn" bind:tap="onBuyClick">
          <text class="buy-price">Â¥{{goods.price}}</text>
          <text class="buy-label">ç›´æ¥ä¹°</text>
        </view>
        <view class="buy-btn yellow-btn" bind:tap="onGroupBuyClick">
          <text class="buy-price">Â¥{{groupBuyPrice}}</text>
          <text class="buy-label">{{goods.group_buy_count}}äººå°åˆ€</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è´­ä¹°å¼¹çª— -->
  <view wx:if="{{showBuyModal}}" class="buy-modal-mask" bind:tap="onCloseBuyModal">
    <view class="buy-modal-content" catch:tap="stopPropagation">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="buy-modal-header">
        <text class="buy-modal-title">ç¡®è®¤è®¢å•</text>
        <view class="buy-modal-close" bind:tap="onCloseBuyModal">Ã—</view>
      </view>

      <!-- ç”¨æˆ·ä¿¡æ¯å’Œåœ°å€ -->
      <view class="buy-modal-section">
        <view class="user-info-row">
          <text class="user-name">{{userInfo.nickname}}</text>
        </view>
        <view class="address-row" bind:tap="onSelectAddress">
          <text class="address-label">æ”¶è´§åœ°å€ï¼š</text>
          <text class="address-text" wx:if="{{selectedAddress}}">
            {{selectedAddress.province}}{{selectedAddress.city}}{{selectedAddress.district}}{{selectedAddress.detail}}
          </text>
          <text class="address-text address-placeholder" wx:else>è¯·é€‰æ‹©æ”¶è´§åœ°å€</text>
          <text class="address-arrow">></text>
        </view>
      </view>

      <!-- å•†å“ä¿¡æ¯ -->
      <view class="buy-modal-section">
        <view class="goods-info-row">
          <image class="goods-thumb" src="{{goods.images && goods.images[0] ? goods.images[0] : ''}}" mode="aspectFill" />
          <view class="goods-info-content">
            <text class="goods-name">{{goods.description}}</text>
            <view class="goods-price-row">
              <text class="goods-price">Â¥{{buyType === 'group' ? groupBuyPrice : goods.price}}</text>
              <text class="goods-original-price" wx:if="{{buyType === 'group'}}">Â¥{{goods.price}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- è§„æ ¼é€‰æ‹© -->
      <view class="buy-modal-section" wx:if="{{goods.spec_enabled && goods.specs && goods.specs.length > 0}}">
        <view class="spec-label">é€‰æ‹©è§„æ ¼ï¼š</view>
        <view class="spec-list">
          <view 
            wx:for="{{goods.specs}}" 
            wx:key="index"
            class="spec-item {{selectedSpec && selectedSpec._index === index ? 'spec-item-active' : ''}}"
            data-index="{{index}}"
            bind:tap="onSelectSpec"
          >
            <text class="spec-name">{{item.name}}</text>
            <text class="spec-price">Â¥{{item.price}}</text>
            <text class="spec-stock" wx:if="{{item.stock !== undefined && item.stock !== null}}">åº“å­˜ï¼š{{item.stock}}</text>
          </view>
        </view>
      </view>

      <!-- æ•°é‡é€‰æ‹© -->
      <view class="buy-modal-section">
        <view class="quantity-row">
          <text class="quantity-label">è´­ä¹°æ•°é‡ï¼š</text>
          <view class="quantity-control">
            <view class="quantity-btn" bind:tap="onDecreaseQuantity">-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view class="quantity-btn" bind:tap="onIncreaseQuantity">+</view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨è´­ä¹°æŒ‰é’® -->
      <view class="buy-modal-footer">
        <view class="price-summary">
          <text class="total-label">åˆè®¡ï¼š</text>
          <text class="total-price">Â¥{{totalPrice}}</text>
        </view>
        <view class="confirm-btn" bind:tap="onConfirmBuy">
          <text class="confirm-btn-text">{{buyType === 'group' ? 'æ‹¼å›¢è´­ä¹°' : 'ç«‹å³è´­ä¹°'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ”¯ä»˜å¼¹çª— -->
  <view wx:if="{{showPayModal}}" class="pay-modal-mask" bind:tap="onClosePayModal">
    <view class="pay-modal-content" catch:tap="stopPropagation">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="pay-modal-header">
        <text class="pay-modal-title">ç¡®è®¤æ”¯ä»˜</text>
        <view class="pay-modal-close" bind:tap="onClosePayModal">Ã—</view>
      </view>

      <!-- æ”¯ä»˜ä¿¡æ¯ -->
      <view class="pay-modal-body">
        <!-- æ”¯ä»˜æ–¹å¼ï¼ˆæ¨¡æ‹Ÿï¼‰ -->
        <view class="pay-method-section">
          <view class="pay-method-item pay-method-active">
            <image class="pay-method-icon" src="/assets/wechat_pay.png" mode="aspectFit" />
            <text class="pay-method-name">å¾®ä¿¡æ”¯ä»˜</text>
            <text class="pay-method-check">âœ“</text>
          </view>
        </view>

        <!-- æ”¯ä»˜é‡‘é¢ -->
        <view class="pay-amount-section">
          <text class="pay-amount-label">æ”¯ä»˜é‡‘é¢</text>
          <text class="pay-amount-value">Â¥{{payAmountFormatted}}</text>
        </view>

        <!-- ä½™é¢ä¿¡æ¯ -->
        <view class="balance-info-section">
          <text class="balance-label">è´¦æˆ·ä½™é¢ï¼š</text>
          <text class="balance-value">Â¥{{walletBalanceFormatted}}</text>
        </view>

        <!-- ä½™é¢ä¸è¶³æç¤º -->
        <view wx:if="{{walletBalance < payAmount}}" class="balance-warning">
          <text>âš ï¸ ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼</text>
        </view>
      </view>

      <!-- å¼¹çª—åº•éƒ¨ -->
      <view class="pay-modal-footer">
        <view class="pay-total">
          <text class="pay-total-label">åˆè®¡ï¼š</text>
          <text class="pay-total-value">Â¥{{payAmountFormatted}}</text>
        </view>
        <view 
          class="pay-confirm-btn {{walletBalance < payAmount ? 'pay-confirm-btn-disabled' : ''}}" 
          bind:tap="onConfirmPay"
        >
          <text class="pay-confirm-btn-text">ç¡®è®¤æ”¯ä»˜</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç®¡ç†å¼¹çª— -->
  <view wx:if="{{showManageModal}}" class="manage-modal-mask" bind:tap="onCloseManageModal">
    <view class="manage-modal-content" catch:tap="stopPropagationManage">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="manage-modal-header">
        <text class="manage-modal-title">ç®¡ç†å•†å“</text>
        <view class="manage-modal-close" bind:tap="onCloseManageModal">Ã—</view>
      </view>

      <!-- å¼¹çª—å†…å®¹ -->
      <view class="manage-modal-body">
        <!-- æç¤ºä¿¡æ¯ -->
        <view class="manage-tip">
          <text>æç¤ºï¼šå¦‚éœ€è¿›ä¸€æ­¥ä¿®æ”¹ï¼Œè¯·ä¸‹æ¶åé‡æ–°å‘å¸ƒ</text>
        </view>

        <!-- å•†å“æè¿° -->
        <view class="manage-form-item">
          <text class="manage-label">å•†å“æè¿°ï¼š</text>
          <textarea 
            class="manage-textarea" 
            placeholder="è¯·è¾“å…¥å•†å“æè¿°"
            value="{{newDescription}}"
            bindinput="onDescriptionInput"
            maxlength="500"
            auto-height
          />
        </view>

        <!-- å•†å“ä»·æ ¼ -->
        <view class="manage-form-item price-item">
          <text class="manage-label">å•†å“ä»·æ ¼ï¼š</text>
          <input 
            class="manage-input" 
            type="digit" 
            placeholder="è¯·è¾“å…¥ä»·æ ¼"
            value="{{newPrice}}"
            bindinput="onPriceInputManage"
          />
          <text class="manage-unit">å…ƒ</text>
        </view>
      </view>

      <!-- å¼¹çª—åº•éƒ¨ -->
      <view class="manage-modal-footer">
        <view class="manage-btn-cancel" bind:tap="onCloseManageModal">å–æ¶ˆ</view>
        <view class="manage-btn-confirm" bind:tap="onConfirmManage">ç¡®è®¤</view>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºå¼¹çª— -->
  <view wx:if="{{showCommentModal}}" class="comment-modal-mask" bind:tap="onCloseCommentModal">
    <view class="comment-modal-content" catch:tap="stopPropagation">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="comment-modal-header">
        <text class="comment-modal-title">å•†å“è¯„ä»·</text>
        <view class="comment-modal-close" bind:tap="onCloseCommentModal">Ã—</view>
      </view>

      <!-- å¼¹çª—å†…å®¹ -->
      <view class="comment-modal-body">
        <!-- è¯„ä»·æ˜Ÿçº§ -->
        <view class="comment-rating-section">
          <text class="comment-rating-label">è¯„åˆ†ï¼š</text>
          <view class="comment-rating-stars">
            <view 
              wx:for="{{[1,2,3,4,5]}}" 
              wx:key="*this"
              class="comment-star {{commentRating >= item ? 'comment-star-filled' : 'comment-star-empty'}}"
              data-rating="{{item}}"
              bind:tap="onSelectRating"
            >
              â˜…
            </view>
          </view>
        </view>

        <!-- è¯„ä»·å†…å®¹ -->
        <view class="comment-content-section">
          <textarea 
            class="comment-textarea" 
            placeholder="è¯·è¾“å…¥è¯„ä»·å†…å®¹ï¼ˆå¿…å¡«ï¼‰"
            value="{{commentContent}}"
            bindinput="onCommentContentInput"
            maxlength="500"
            auto-height
          />
        </view>

        <!-- è¯„ä»·å›¾ç‰‡ -->
        <view class="comment-images-section">
          <view class="comment-images-label">ä¸Šä¼ å›¾ç‰‡ï¼ˆæœ€å¤š3å¼ ï¼Œå¯é€‰ï¼‰</view>
          <view class="comment-images-list">
            <view 
              wx:for="{{commentImages}}" 
              wx:key="index"
              class="comment-image-item"
            >
              <image 
                class="comment-image-preview" 
                src="{{item}}" 
                mode="aspectFill"
                bind:tap="onPreviewCommentImage"
                data-url="{{item}}"
                data-urls="{{commentImages}}"
              />
              <view 
                class="comment-image-delete" 
                bind:tap="onDeleteCommentImage"
                data-index="{{index}}"
              >
                Ã—
              </view>
            </view>
            <view 
              wx:if="{{commentImages.length < 3}}"
              class="comment-image-upload" 
              bind:tap="onSelectCommentImages"
            >
              <text class="upload-icon">+</text>
              <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å¼¹çª—åº•éƒ¨ -->
      <view class="comment-modal-footer">
        <view 
          class="comment-submit-btn {{submittingComment ? 'comment-submit-btn-disabled' : ''}}" 
          bind:tap="onSubmitComment"
        >
          <text class="comment-submit-btn-text">{{submittingComment ? 'æäº¤ä¸­...' : 'æäº¤è¯„ä»·'}}</text>
        </view>
      </view>
    </view>
  </view>
</view>


