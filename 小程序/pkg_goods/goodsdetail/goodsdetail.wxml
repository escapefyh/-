<!--pages/goodsdetail/goodsdetail.wxml-->
<view class="goods-detail-page">
  <view wx:if="{{loading}}" class="loading-container">
    <text>加载中...</text>
  </view>

  <view wx:else class="content">
    <!-- 卖家信息（顶部） -->
    <view class="seller-header">
      <image 
        class="seller-avatar" 
        src="{{seller.avatar || '/assets/default_avatar.png'}}" 
        mode="aspectFill"
        binderror="onAvatarError"
      />
      <text class="seller-name-header">{{seller.nickname || seller.name || '未设置昵称'}}</text>
    </view>

    <!-- 商品图片轮播 -->
    <view class="image-section">
      <t-swiper
        wx:if="{{goods.images && goods.images.length > 0}}"
        list="{{goods.images}}"
        navigation="{{ { type: 'dots-bar' } }}"
        autoplay="{{false}}"
      />
    </view>

    <!-- 商品信息 -->
    <view class="goods-info">
      <view class="price-section">
        <text class="price">¥{{goods.price}}</text>
        <view wx:if="{{goods.group_buy_enabled}}" class="group-buy-tag">
          <text>拼团{{groupBuyDiscountText}}折</text>
        </view>
      </view>
      
      <view class="description">{{goods.description}}</view>
      
      <view class="meta-info">
        <view class="meta-item">
          <text class="label">发布时间：</text>
          <text class="value">{{createTime}}</text>
        </view>
        <view class="meta-item" wx:if="{{goods.sales_count !== undefined && goods.sales_count !== null}}">
          <text class="label">销量：</text>
          <text class="value sales-value">已售{{goods.sales_count}}件</text>
        </view>
      </view>
    </view>

  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-action-bar">
    <!-- 消息图标（显示评论数） -->
    <view class="action-item" bind:tap="onCommentClick">
      <image class="action-icon" src="/assets/message.png" mode="aspectFit" />
      <text class="action-count">{{commentCount}}</text>
    </view>
    
    <!-- 收藏图标（显示收藏数） -->
    <view class="action-item" bind:tap="onFavoriteClick">
      <image 
        class="action-icon" 
        src="{{isFavorited ? '/assets/Collection_filled.png' : '/assets/Collection.png'}}" 
        mode="aspectFit" 
      />
      <text class="action-count">{{favoriteCount}}</text>
    </view>

    <!-- 聊一聊按钮 -->
    <view class="chat-btn" bind:tap="onChatClick">
      <text class="chat-text">聊一聊</text>
    </view>

    <!-- 购买按钮区域 -->
    <view class="buy-buttons">
      <!-- 未开启拼团：只显示直接买 -->
      <view wx:if="{{!goods.group_buy_enabled}}" class="buy-btn gray-btn" bind:tap="onBuyClick">
        <text class="buy-price">¥{{goods.price}}</text>
        <text class="buy-label">直接买</text>
      </view>

      <!-- 开启拼团：显示两个购买选项 -->
      <view wx:else class="buy-buttons-group">
        <view class="buy-btn gray-btn" bind:tap="onBuyClick">
          <text class="buy-price">¥{{goods.price}}</text>
          <text class="buy-label">直接买</text>
        </view>
        <view class="buy-btn yellow-btn" bind:tap="onGroupBuyClick">
          <text class="buy-price">¥{{groupBuyPrice}}</text>
          <text class="buy-label">{{goods.group_buy_count}}人小刀</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 购买弹窗 -->
  <view wx:if="{{showBuyModal}}" class="buy-modal-mask" bind:tap="onCloseBuyModal">
    <view class="buy-modal-content" catch:tap="stopPropagation">
      <!-- 弹窗头部 -->
      <view class="buy-modal-header">
        <text class="buy-modal-title">确认订单</text>
        <view class="buy-modal-close" bind:tap="onCloseBuyModal">×</view>
      </view>

      <!-- 用户信息和地址 -->
      <view class="buy-modal-section">
        <view class="user-info-row">
          <text class="user-name">{{userInfo.nickname}}</text>
        </view>
        <view class="address-row" bind:tap="onSelectAddress">
          <text class="address-label">收货地址：</text>
          <text class="address-text" wx:if="{{selectedAddress}}">
            {{selectedAddress.province}}{{selectedAddress.city}}{{selectedAddress.district}}{{selectedAddress.detail}}
          </text>
          <text class="address-text address-placeholder" wx:else>请选择收货地址</text>
          <text class="address-arrow">></text>
        </view>
      </view>

      <!-- 商品信息 -->
      <view class="buy-modal-section">
        <view class="goods-info-row">
          <image class="goods-thumb" src="{{goods.images && goods.images[0] ? goods.images[0] : ''}}" mode="aspectFill" />
          <view class="goods-info-content">
            <text class="goods-name">{{goods.description}}</text>
            <view class="goods-price-row">
              <text class="goods-price">¥{{buyType === 'group' ? groupBuyPrice : goods.price}}</text>
              <text class="goods-original-price" wx:if="{{buyType === 'group'}}">¥{{goods.price}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 规格选择 -->
      <view class="buy-modal-section" wx:if="{{goods.spec_enabled && goods.specs && goods.specs.length > 0}}">
        <view class="spec-label">选择规格：</view>
        <view class="spec-list">
          <view 
            wx:for="{{goods.specs}}" 
            wx:key="index"
            class="spec-item {{selectedSpec && selectedSpec._index === index ? 'spec-item-active' : ''}}"
            data-index="{{index}}"
            bind:tap="onSelectSpec"
          >
            <text class="spec-name">{{item.name}}</text>
            <text class="spec-price">¥{{item.price}}</text>
            <text class="spec-stock" wx:if="{{item.stock !== undefined && item.stock !== null}}">库存：{{item.stock}}</text>
          </view>
        </view>
      </view>

      <!-- 数量选择 -->
      <view class="buy-modal-section">
        <view class="quantity-row">
          <text class="quantity-label">购买数量：</text>
          <view class="quantity-control">
            <view class="quantity-btn" bind:tap="onDecreaseQuantity">-</view>
            <text class="quantity-value">{{quantity}}</text>
            <view class="quantity-btn" bind:tap="onIncreaseQuantity">+</view>
          </view>
        </view>
      </view>

      <!-- 底部购买按钮 -->
      <view class="buy-modal-footer">
        <view class="price-summary">
          <text class="total-label">合计：</text>
          <text class="total-price">¥{{totalPrice}}</text>
        </view>
        <view class="confirm-btn" bind:tap="onConfirmBuy">
          <text class="confirm-btn-text">{{buyType === 'group' ? '拼团购买' : '立即购买'}}</text>
        </view>
      </view>
    </view>
  </view>
</view>


