<!--pages/order/order.wxml-->
<view class="order-page">
  <!-- 状态筛选栏 -->
  <view class="status-tabs">
    <view 
      wx:for="{{statusTabs}}" 
      wx:key="key"
      class="status-tab {{activeStatus === item.key ? 'status-tab-active' : ''}}"
      data-status="{{item.key}}"
      bind:tap="onStatusTabChange"
    >
      <text>{{item.label}}</text>
    </view>
  </view>

  <!-- 加载中状态 -->
  <view wx:if="{{loading && orderList.length === 0}}" class="loading-container">
    <text>加载中...</text>
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{isEmpty}}" class="empty-container">
    <text class="empty-text">暂无订单</text>
    <text class="empty-tip">快去购买你喜欢的商品吧~</text>
  </view>

  <!-- 订单列表 -->
  <view wx:else class="order-list">
    <view 
      class="order-item" 
      wx:for="{{orderList}}" 
      wx:key="order_id"
      bind:tap="onViewDetail"
      data-order-id="{{item.order_id}}"
    >
      <!-- 订单头部：订单编号和状态 -->
      <view class="order-header">
        <view class="order-header-left">
          <text class="order-no">订单号：{{item.order_no || item.order_id}}</text>
          <!-- 拼团标签 -->
          <view wx:if="{{item.is_group_buy}}" class="group-buy-badge">
            <text>拼团</text>
          </view>
        </view>
        <text class="order-status order-status-{{item.status}}">{{item.status_text}}</text>
      </view>
      
      <!-- 拼团状态提示（仅在拼团订单且状态为paid时显示） -->
      <view wx:if="{{item.is_group_buy && item.status === 'paid' && item.group_buy_status}}" class="group-buy-status-tip">
        <text wx:if="{{item.group_buy_status === 'pending' && item.group_buy_remaining_count > 0}}" class="group-buy-tip-text">
          还差 {{item.group_buy_remaining_count}} 人成团
        </text>
        <text wx:elif="{{item.group_buy_status === 'success'}}" class="group-buy-tip-text group-buy-tip-success">
          拼团成功，等待卖家发货
        </text>
        <text wx:elif="{{item.group_buy_status === 'failed'}}" class="group-buy-tip-text group-buy-tip-failed">
          拼团失败，请处理退款
        </text>
      </view>

      <!-- 订单内容：商品信息 -->
      <view class="order-content">
        <!-- 商品图片 -->
        <view class="order-goods-image">
          <image 
            wx:if="{{item.goods_image && item.goods_image.length > 0}}"
            class="goods-image" 
            src="{{item.goods_image[0]}}" 
            mode="aspectFill"
            lazy-load="{{true}}"
          />
          <image 
            wx:else
            class="goods-image" 
            src="/assets/default_goods.png" 
            mode="aspectFill"
          />
        </view>

        <!-- 商品信息 -->
        <view class="order-goods-info">
          <view class="goods-description">{{item.goods_description || '商品描述'}}</view>
          <view class="goods-spec" wx:if="{{item.spec_name}}">
            <text>规格：{{item.spec_name}}</text>
          </view>
          <view class="goods-quantity">
            <text>数量：{{item.quantity || 1}}</text>
          </view>
          <view class="goods-price">
            <text>¥{{item.total_price_formatted || '0.00'}}</text>
          </view>
        </view>
      </view>

      <!-- 订单底部：时间和操作按钮 -->
      <view class="order-footer">
        <text class="order-time">{{item.create_time_formatted || ''}}</text>
        <view class="order-actions">
          <!-- 我买到的页面操作按钮 -->
          <block wx:if="{{pageType === 'bought'}}">
            <!-- 待付款：取消订单、去付款 -->
            <view 
              wx:if="{{item.status === 'pending'}}"
              class="action-btn action-btn-secondary"
              catch:tap="onCancelOrder"
              data-order-id="{{item.order_id}}"
            >
              <text>取消订单</text>
            </view>
            <view 
              wx:if="{{item.status === 'pending'}}"
              class="action-btn action-btn-primary"
              catch:tap="onPayOrder"
              data-order-id="{{item.order_id}}"
            >
              <text>去付款</text>
            </view>

            <!-- 待发货：取消订单 -->
            <view 
              wx:if="{{item.status === 'paid'}}"
              class="action-btn action-btn-secondary"
              catch:tap="onCancelOrder"
              data-order-id="{{item.order_id}}"
            >
              <text>取消订单</text>
            </view>

            <!-- 待收货：确认收货 -->
            <view 
              wx:if="{{item.status === 'shipped'}}"
              class="action-btn action-btn-primary"
              catch:tap="onConfirmReceive"
              data-order-id="{{item.order_id}}"
            >
              <text>确认收货</text>
            </view>

            <!-- 待评价：去评价 -->
            <view 
              wx:if="{{item.status === 'review'}}"
              class="action-btn action-btn-primary"
              catch:tap="onReviewOrder"
              data-order-id="{{item.order_id}}"
            >
              <text>去评价</text>
            </view>
          </block>

          <!-- 我卖出的页面操作按钮 -->
          <block wx:if="{{pageType === 'sold'}}">
            <!-- 待发货：发货（仅当可以发货时显示，拼团订单需要成团后才能发货） -->
            <view 
              wx:if="{{item.status === 'paid' && item.can_ship}}"
              class="action-btn action-btn-primary"
              catch:tap="onShipOrder"
              data-order-id="{{item.order_id}}"
            >
              <text>发货</text>
            </view>
            
            <!-- 拼团中：等待成团（拼团订单未成团时显示） -->
            <view 
              wx:if="{{item.status === 'paid' && item.is_group_buy && !item.can_ship}}"
              class="action-btn action-btn-disabled"
            >
              <text>等待成团</text>
            </view>

            <!-- 待收货：等待买家确认收货（无操作按钮，显示提示） -->
            <view 
              wx:if="{{item.status === 'shipped'}}"
              class="action-btn action-btn-disabled"
            >
              <text>等待买家确认收货</text>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载更多提示 -->
  <view wx:if="{{loading && orderList.length > 0}}" class="loading-more">
    <text>加载中...</text>
  </view>
  <view wx:if="{{!hasMore && orderList.length > 0}}" class="no-more">
    <text>没有更多了</text>
  </view>

  <!-- 支付弹窗 -->
  <view wx:if="{{showPayModal}}" class="pay-modal-mask" bind:tap="onClosePayModal">
    <view class="pay-modal-content" catch:tap="stopPropagation">
      <!-- 弹窗头部 -->
      <view class="pay-modal-header">
        <text class="pay-modal-title">确认支付</text>
        <view class="pay-modal-close" bind:tap="onClosePayModal">×</view>
      </view>

      <!-- 支付信息 -->
      <view class="pay-modal-body">
        <!-- 支付方式（模拟） -->
        <view class="pay-method-section">
          <view class="pay-method-item pay-method-active">
            <image class="pay-method-icon" src="/assets/wechat_pay.png" mode="aspectFit" />
            <text class="pay-method-name">微信支付</text>
            <text class="pay-method-check">✓</text>
          </view>
        </view>

        <!-- 支付金额 -->
        <view class="pay-amount-section">
          <text class="pay-amount-label">支付金额</text>
          <text class="pay-amount-value">¥{{payAmountFormatted}}</text>
        </view>

        <!-- 余额信息 -->
        <view class="balance-info-section">
          <text class="balance-label">账户余额：</text>
          <text class="balance-value">¥{{walletBalanceFormatted}}</text>
        </view>

        <!-- 余额不足提示 -->
        <view wx:if="{{walletBalance < (currentPayOrder.total_price || 0)}}" class="balance-warning">
          <text>⚠️ 余额不足，请先充值</text>
        </view>
      </view>

      <!-- 弹窗底部 -->
      <view class="pay-modal-footer">
        <view class="pay-total">
          <text class="pay-total-label">合计：</text>
          <text class="pay-total-value">¥{{payAmountFormatted}}</text>
        </view>
        <view 
          class="pay-confirm-btn {{walletBalance < (currentPayOrder.total_price || 0) ? 'pay-confirm-btn-disabled' : ''}}" 
          bind:tap="onConfirmPay"
        >
          <text class="pay-confirm-btn-text">确认支付</text>
        </view>
      </view>
    </view>
  </view>
</view>
