<!--pages/sellgoods/sellgoods.wxml-->
<view class="sellgoods-page">
  <!-- 顶部导航栏 -->
  <view class="header">
    <view class="close-btn" bind:tap="onClose">
      <text class="close-icon">×</text>
    </view>
    <view class="header-title">发闲置</view>
    <view class="publish-btn" bind:tap="onPublish">
      <text>发布</text>
    </view>
  </view>

  <!-- 内容区域 -->
  <view class="content">
    <!-- 图片上传区域 -->
    <view class="upload-section">
      <view class="upload-box" bind:tap="onUploadImage">
        <view class="upload-icon">+</view>
        <view class="upload-text">
          <text>添加优质</text>
          <text>首图更吸引人~</text>
        </view>
      </view>
      <view class="image-preview" wx:if="{{images.length > 0}}">
        <view 
          wx:for="{{images}}" 
          wx:key="index" 
          class="preview-image-wrapper"
        >
          <image 
            class="preview-image" 
            src="{{item}}" 
            mode="aspectFill"
            bind:tap="onPreviewImage"
            data-index="{{index}}"
          />
          <view 
            class="delete-image-btn" 
            catchtap="onDeleteImage"
            data-index="{{index}}"
          >
            <text class="delete-icon">×</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 描述输入框 -->
    <view class="description-section">
      <t-textarea 
        placeholder="描述一下宝贝的品牌型号、货品来源..." 
        value="{{description}}"
        bind:change="onDescriptionChange"
        maxlength="{{500}}"
        auto-height
      />
    </view>

    <!-- 分类选择 -->
    <view class="category-section" catchtap="onCategoryClick">
      <view class="category-label">分类</view>
      <view class="category-value">
        <view class="category-text-wrapper">
          <text class="category-text {{!selectedCategoryName ? 'placeholder' : ''}}">{{selectedCategoryName || '请选择商品分类'}}</text>
          <text class="auto-detected-tag" wx:if="{{autoDetectedCategory}}">（已自动识别）</text>
        </view>
        <text class="category-arrow">›</text>
      </view>
    </view>

    <!-- 分类选择弹窗 -->
    <view class="category-modal {{showCategoryModal ? 'show' : ''}}" catchtap="onCloseCategoryModal">
      <view class="category-modal-content" catchtap="stopPropagation">
        <view class="category-modal-header">
          <text class="category-modal-title">选择商品分类</text>
          <text class="category-modal-close" catchtap="onCloseCategoryModal">×</text>
        </view>
        <view class="category-modal-body">
          <view 
            class="category-item {{selectedCategoryId === item.category_id ? 'active' : ''}}"
            wx:for="{{categoryList}}" 
            wx:key="category_id"
            catchtap="onSelectCategory"
            data-category-id="{{item.category_id}}"
            data-category-name="{{item.name}}"
            data-index="{{index}}"
          >
            <text class="category-item-text">{{item.name}}</text>
            <text class="category-item-check" wx:if="{{selectedCategoryId === item.category_id}}">✓</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 价格选择 -->
    <view class="price-section" bind:tap="onPriceClick">
      <view class="price-label">价格</view>
      <view class="price-value">
        <text class="price-amount">¥{{price || '0.00'}}</text>
        <text class="price-arrow">›</text>
      </view>
    </view>

    <!-- 拼团选项 -->
    <view class="group-buy-section">
      <view class="group-buy-label">
        <text>是否开启拼团购买</text>
      </view>
      <t-switch value="{{groupBuyEnabled}}" bind:change="onGroupBuyChange" />
    </view>

    <!-- 拼团设置（仅在开启拼团时显示） -->
    <view wx:if="{{groupBuyEnabled}}" class="group-buy-settings">
      <!-- 拼单人数选择 -->
      <view class="group-buy-setting-item">
        <view class="setting-label">拼单人数</view>
        <view class="setting-value">
          <view 
            class="group-count-option {{groupBuyCount === item ? 'active' : ''}}"
            wx:for="{{[2,3,4,5]}}" 
            wx:key="*this"
            bind:tap="onSelectGroupCount"
            data-count="{{item}}"
          >
            <text>{{item}}人</text>
          </view>
        </view>
      </view>

      <!-- 折扣设置 -->
      <view class="group-buy-setting-item">
        <view class="setting-label">拼团折扣</view>
        <view class="setting-value">
          <input 
            class="discount-input" 
            type="digit" 
            placeholder="请输入折扣（0-1之间）"
            value="{{groupBuyDiscount}}"
            bindinput="onDiscountInput"
          />
          <text class="discount-tip">折（例如：0.9表示9折）</text>
        </view>
        <view class="setting-desc">折扣范围：0 小于 折扣 小于 1（不能等于0或1）</view>
      </view>
    </view>

    <!-- 规格选项 -->
    <view class="spec-section">
      <view class="spec-label">
        <text>是否开启规格</text>
      </view>
      <t-switch value="{{specEnabled}}" bind:change="onSpecChange" />
    </view>

    <!-- 规格设置（仅在开启规格时显示） -->
    <view wx:if="{{specEnabled}}" class="spec-settings">
      <!-- 提示文字 -->
      <view class="spec-tip">
        <text>请添加商品规格选项，每个选项需填写名称、价格和库存</text>
      </view>

      <!-- SKU选项列表 -->
      <view class="spec-options">
        <view 
          class="spec-option-item"
          wx:for="{{specOptions}}"
          wx:key="index"
        >
          <view class="spec-option-header">
            <text class="spec-option-number">选项 {{index + 1}}</text>
            <view class="spec-option-delete" bindtap="onDeleteSpecOption" data-index="{{index}}">
              <text>删除</text>
            </view>
          </view>
          
          <view class="spec-option-content">
            <view class="spec-option-field">
              <text class="spec-option-label">规格名称：</text>
              <input 
                class="spec-option-input"
                type="text"
                placeholder="如：【2件】黑色/全新***"
                value="{{item.name}}"
                bindinput="onSpecOptionNameInput"
                data-index="{{index}}"
              />
            </view>
            
            <view class="spec-option-field">
              <text class="spec-option-label">价格：</text>
              <input 
                class="spec-option-input spec-option-price"
                type="digit"
                placeholder="请输入价格"
                value="{{item.price}}"
                bindinput="onSpecOptionPriceInput"
                data-index="{{index}}"
              />
              <text class="spec-option-unit">元</text>
            </view>
            
            <view class="spec-option-field">
              <text class="spec-option-label">库存：</text>
              <input 
                class="spec-option-input spec-option-stock"
                type="number"
                placeholder="请输入库存数量"
                value="{{item.stock}}"
                bindinput="onSpecOptionStockInput"
                data-index="{{index}}"
              />
              <text class="spec-option-unit">件</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 添加新选项按钮 -->
      <view class="spec-add-option-btn" bindtap="onAddSpecOption">
        <text>+ 添加新选项</text>
      </view>
    </view>
  </view>
</view>
