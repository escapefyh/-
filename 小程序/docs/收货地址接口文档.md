# 收货地址管理接口文档

## 概述

本文档描述了收货地址管理相关的接口，包括地址列表查询、地址详情查询、添加地址、更新地址、删除地址等功能。

## 接口列表

1. [获取地址列表](#1-获取地址列表)
2. [获取地址详情](#2-获取地址详情)
3. [添加收货地址](#3-添加收货地址)
4. [更新收货地址](#4-更新收货地址)
5. [删除收货地址](#5-删除收货地址)
6. [设置默认地址](#6-设置默认地址)

---

## 1. 获取地址列表

**接口地址：** `/address/list`

**请求方法：** `GET`

**Content-Type：** `application/json`

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | Integer | 是 | 用户ID |

### 请求示例

```
GET /address/list?user_id=123
```

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "address_id": 1,
        "user_id": 123,
        "contact_name": "淘宝用户",
        "phone": "13140400073",
        "region": "河南省 郑州市 中原区",
        "province": "河南省",
        "city": "郑州市",
        "district": "中原区",
        "street": "枫杨街道",
        "detail_address": "河南工业大学学校医院菜鸟驿站",
        "is_default": 1,
        "created_at": "2024-01-01 10:00:00",
        "updated_at": "2024-01-01 10:00:00"
      }
    ],
    "total": 1
  }
}
```

#### 错误响应

```json
{
  "msg": "error",
  "error": "用户未登录"
}
```

---

## 2. 获取地址详情

**接口地址：** `/address/detail`

**请求方法：** `GET`

**Content-Type：** `application/json`

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| address_id | Integer | 是 | 地址ID |
| user_id | Integer | 是 | 用户ID（用于验证地址归属） |

### 请求示例

```
GET /address/detail?address_id=1&user_id=123
```

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "address_id": 1,
    "user_id": 123,
    "contact_name": "淘宝用户",
    "phone": "13140400073",
    "region": "河南省 郑州市 中原区",
    "province": "河南省",
    "city": "郑州市",
    "district": "中原区",
    "street": "枫杨街道",
    "detail_address": "河南工业大学学校医院菜鸟驿站",
    "is_default": 1,
    "created_at": "2024-01-01 10:00:00",
    "updated_at": "2024-01-01 10:00:00"
  }
}
```

#### 错误响应

```json
{
  "msg": "error",
  "error": "地址不存在或无权访问"
}
```

---

## 3. 添加收货地址

**接口地址：** `/address/add`

**请求方法：** `POST`

**Content-Type：** `application/json`

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | Integer | 是 | 用户ID |
| contact_name | String | 是 | 联系人姓名（1-20个字符） |
| phone | String | 是 | 手机号（11位，格式：1[3-9]xxxxxxxxx） |
| region | String | 是 | 所在地区（格式：省 市 区，用空格分隔） |
| province | String | 是 | 省份 |
| city | String | 是 | 城市 |
| district | String | 是 | 区/县 |
| street | String | 否 | 街道 |
| detail_address | String | 是 | 详细地址（1-100个字符） |
| is_default | Integer | 否 | 是否设为默认地址（0-否，1-是），默认：0 |

### 请求示例

```json
{
  "user_id": 123,
  "contact_name": "淘宝用户",
  "phone": "13140400073",
  "region": "河南省 郑州市 中原区",
  "province": "河南省",
  "city": "郑州市",
  "district": "中原区",
  "street": "枫杨街道",
  "detail_address": "河南工业大学学校医院菜鸟驿站",
  "is_default": 1
}
```

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "address_id": 1,
    "message": "地址添加成功"
  }
}
```

#### 错误响应

```json
{
  "msg": "error",
  "error": "联系人姓名不能为空"
}
```

```json
{
  "msg": "error",
  "error": "手机号格式不正确"
}
```

```json
{
  "msg": "error",
  "error": "详细地址不能为空"
}
```

---

## 4. 更新收货地址

**接口地址：** `/address/update`

**请求方法：** `POST`

**Content-Type：** `application/json`

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| address_id | Integer | 是 | 地址ID |
| user_id | Integer | 是 | 用户ID（用于验证地址归属） |
| contact_name | String | 是 | 联系人姓名（1-20个字符） |
| phone | String | 是 | 手机号（11位，格式：1[3-9]xxxxxxxxx） |
| region | String | 是 | 所在地区（格式：省 市 区，用空格分隔） |
| province | String | 是 | 省份 |
| city | String | 是 | 城市 |
| district | String | 是 | 区/县 |
| street | String | 否 | 街道 |
| detail_address | String | 是 | 详细地址（1-100个字符） |
| is_default | Integer | 否 | 是否设为默认地址（0-否，1-是） |

### 请求示例

```json
{
  "address_id": 1,
  "user_id": 123,
  "contact_name": "淘宝用户",
  "phone": "13140400073",
  "region": "河南省 郑州市 中原区",
  "province": "河南省",
  "city": "郑州市",
  "district": "中原区",
  "street": "枫杨街道",
  "detail_address": "河南工业大学学校医院菜鸟驿站",
  "is_default": 1
}
```

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "message": "地址更新成功"
  }
}
```

#### 错误响应

```json
{
  "msg": "error",
  "error": "地址不存在或无权访问"
}
```

---

## 5. 删除收货地址

**接口地址：** `/address/delete`

**请求方法：** `POST`

**Content-Type：** `application/json`

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| address_id | Integer | 是 | 地址ID |
| user_id | Integer | 是 | 用户ID（用于验证地址归属） |

### 请求示例

```json
{
  "address_id": 1,
  "user_id": 123
}
```

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "message": "地址删除成功"
  }
}
```

#### 错误响应

```json
{
  "msg": "error",
  "error": "地址不存在或无权访问"
}
```

```json
{
  "msg": "error",
  "error": "无法删除默认地址，请先设置其他地址为默认"
}
```

### 业务逻辑说明

1. **删除验证**
   - 必须验证 `user_id`，确保用户只能删除自己的地址
   - 如果 `address_id` 和 `user_id` 不匹配，应返回错误

2. **默认地址删除**
   - 如果删除的是默认地址，可以选择：
     - **方案一（推荐）**：允许删除默认地址，删除后用户没有默认地址，需要重新设置
     - **方案二**：不允许删除默认地址，返回错误提示"无法删除默认地址，请先设置其他地址为默认"

3. **删除后的处理**
   - 删除成功后，前端会刷新地址列表
   - 如果删除的是默认地址，建议提示用户设置新的默认地址

---

## 6. 设置默认地址

**接口地址：** `/address/setDefault`

**请求方法：** `POST`

**Content-Type：** `application/json`

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| address_id | Integer | 是 | 地址ID |
| user_id | Integer | 是 | 用户ID（用于验证地址归属） |

### 请求示例

```json
{
  "address_id": 1,
  "user_id": 123
}
```

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "message": "默认地址设置成功"
  }
}
```

#### 错误响应

```json
{
  "msg": "error",
  "error": "地址不存在或无权访问"
}
```

**注意：** 设置某个地址为默认地址时，应该将该用户的其他地址的 `is_default` 字段设置为 0。

---

## 数据验证规则

### 1. 联系人姓名（contact_name）

- 必填
- 类型：String
- 长度：1-20 个字符
- 不能为空或仅包含空格

### 2. 手机号（phone）

- 必填
- 类型：String
- 格式：11 位数字
- 正则表达式：`/^1[3-9]\d{9}$/`
- 示例：`13140400073`

### 3. 所在地区（region）

- 必填
- 类型：String
- 格式：省、市、区，用空格分隔
- 示例：`河南省 郑州市 中原区`
- 长度：不超过 50 个字符

### 4. 省份（province）

- 必填
- 类型：String
- 示例：`河南省`

### 5. 城市（city）

- 必填
- 类型：String
- 示例：`郑州市`

### 6. 区/县（district）

- 必填
- 类型：String
- 示例：`中原区`

### 7. 街道（street）

- 可选
- 类型：String
- 示例：`枫杨街道`

### 8. 详细地址（detail_address）

- 必填
- 类型：String
- 长度：1-100 个字符
- 不能为空或仅包含空格
- 示例：`河南工业大学学校医院菜鸟驿站`

### 9. 是否默认地址（is_default）

- 可选
- 类型：Integer
- 取值：0（否）或 1（是）
- 默认值：0
- 注意：每个用户只能有一个默认地址

---

## 数据库设计建议

### 地址表（addresses）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| address_id | Integer | 地址ID（主键，自增） |
| user_id | Integer | 用户ID（外键） |
| contact_name | String(20) | 联系人姓名 |
| phone | String(11) | 手机号 |
| region | String(50) | 所在地区（省 市 区） |
| province | String(20) | 省份 |
| city | String(20) | 城市 |
| district | String(20) | 区/县 |
| street | String(50) | 街道（可选） |
| detail_address | String(100) | 详细地址 |
| is_default | Integer | 是否默认地址（0-否，1-是） |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 索引建议

- `user_id` 字段建议添加索引，便于查询某个用户的所有地址
- `address_id` 字段为主键，自动创建索引
- `is_default` 和 `user_id` 联合索引，便于查询用户的默认地址

### 数据库关系

```
users (1) ----< (N) addresses
```

---

## 业务逻辑说明

### 1. 默认地址管理

- 每个用户只能有一个默认地址
- 当设置某个地址为默认地址时，需要将该用户的其他地址的 `is_default` 字段设置为 0
- 如果用户没有默认地址，第一个添加的地址可以自动设为默认地址（可选）

### 2. 地址归属验证

- 所有地址相关的操作都需要验证 `user_id`，确保用户只能操作自己的地址
- 如果 `address_id` 和 `user_id` 不匹配，应返回错误

### 3. 地址删除

- 删除地址时，需要验证地址归属
- 如果删除的是默认地址，可以选择：
  - **方案一（推荐）**：允许删除默认地址，删除后用户没有默认地址，需要重新设置
  - **方案二**：不允许删除默认地址，返回错误提示"无法删除默认地址，请先设置其他地址为默认"
- 删除成功后，前端会刷新地址列表

### 4. 地址列表排序

- 建议按以下顺序排序：
  1. 默认地址排在第一位
  2. 其他地址按创建时间倒序排列（最新的在前）

---

## 前端实现说明

### 1. 地址列表页面

- 显示用户的所有收货地址
- 默认地址有特殊标识（如"默认"标签）
- 可以点击地址项进入编辑页面
- 底部有"管理"和"添加收货地址"按钮
- **管理模式**：
  - 点击"管理"按钮进入管理模式
  - 管理模式中，每个地址项显示"删除"按钮
  - 点击"删除"按钮会弹出确认对话框
  - 确认删除后调用删除接口
  - 点击"完成"按钮退出管理模式
  - 管理模式中，点击地址项不会进入编辑页面

### 2. 添加/编辑地址页面

- 表单字段：
  - 联系人（必填）
  - 手机号（必填，带国家代码 +86）
  - 所在地区（必填，使用微信小程序原生地区选择器）
  - 详细地址（必填）
  - 默认地址开关（可选）
- 保存按钮：提交表单数据

### 3. 数据格式

前端提交的数据格式：

```javascript
{
  user_id: 123,
  contact_name: "淘宝用户",
  phone: "13140400073",
  region: "河南省 郑州市 中原区",
  province: "河南省",
  city: "郑州市",
  district: "中原区",
  street: "枫杨街道",
  detail_address: "河南工业大学学校医院菜鸟驿站",
  is_default: 1
}
```

---

## 注意事项

1. **安全性**
   - 所有接口都需要验证用户身份
   - 确保用户只能操作自己的地址
   - 建议对敏感信息进行加密传输

2. **数据完整性**
   - 地区信息建议同时保存 `region`（显示用）和 `province`、`city`、`district`（查询用）
   - 便于后续的地区筛选和统计

3. **默认地址**
   - 确保每个用户只有一个默认地址
   - 设置新默认地址时，需要取消其他地址的默认状态

4. **数据验证**
   - 前端进行基础验证，后端进行完整验证
   - 手机号格式验证必须严格

5. **错误处理**
   - 提供清晰的错误提示信息
   - 网络错误时给出友好提示

---

## 更新日志

- **2024-XX-XX**：初始版本，添加收货地址管理接口文档

---

## 联系方式

如有疑问，请联系后端开发团队。


