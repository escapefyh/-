# 注册接口文档

## 概述

本文档描述了用户注册功能的接口规范。用户注册时需要填写姓名、手机号、账号和密码，其中手机号必须是11位数字。

## 快速参考

### 接口地址
`POST /register`

### 关键验证规则
- **手机号**：必须是11位数字（1开头，第二位3-9），必须唯一
- **账号**：至少6个字符，必须唯一
- **密码**：6-20个字符

### 关键错误响应
- **手机号已注册**：`{"msg": "error", "error": "该手机号已被注册"}` ⚠️ **必须返回此错误信息**
- **账号已注册**：`{"msg": "registered", "error": "该账号已注册"}`

---

## 接口信息

### 用户注册接口

**接口地址：** `POST /register`

**请求方法：** `POST`

**Content-Type：** `application/json`

---

## 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | String | 是 | 用户姓名 |
| phone | String | 是 | 手机号（必须是11位数字，以1开头，第二位为3-9） |
| account | String | 是 | 用户账号（登录时使用，至少6个字符） |
| password | String | 是 | 用户密码（6-20个字符，至少6个字符） |

### 请求示例

```json
{
  "name": "张三",
  "phone": "13800138000",
  "account": "zhangsan",
  "password": "password123"
}
```

---

## 响应格式

### 成功响应

```json
{
  "msg": "success",
  "data": {
    "user_id": 123,
    "message": "注册成功"
  }
}
```

### 错误响应

**账号已注册：**
```json
{
  "msg": "registered",
  "error": "该账号已注册"
}
```

**手机号已注册：**
```json
{
  "msg": "error",
  "error": "该手机号已被注册"
}
```

**手机号格式不正确：**
```json
{
  "msg": "error",
  "error": "手机号必须是11位数字"
}
```

**账号长度不足：**
```json
{
  "msg": "error",
  "error": "账号长度不能少于6位"
}
```

**密码长度不足：**
```json
{
  "msg": "error",
  "error": "密码长度不能少于6位"
}
```

**密码格式不正确：**
```json
{
  "msg": "error",
  "error": "密码长度应在6-20个字符之间"
}
```

**服务器错误：**
```json
{
  "msg": "error",
  "error": "服务器出错"
}
```

---

## 字段说明

### 请求参数

| 字段名 | 类型 | 说明 |
|--------|------|------|
| name | String | 用户姓名，不能为空 |
| phone | String | 手机号，必须是11位数字，格式：1[3-9]xxxxxxxxx |
| account | String | 用户账号，用于登录，不能为空 |
| password | String | 用户密码，长度6-20个字符 |

### 响应字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态，"success" 表示成功，"registered" 表示账号已注册，"error" 表示失败 |
| error | String | 错误信息（仅在失败时返回） |
| data | Object | 响应数据（仅在成功时返回） |
| data.user_id | Number | 新注册用户的ID（可选） |
| data.message | String | 成功消息 |

---

## 业务规则

### 1. 手机号验证规则

- **格式要求：**
  - 必须是11位数字
  - 必须以1开头
  - 第二位数字必须是3-9
  - 正则表达式：`/^1[3-9]\d{9}$/`
  - **验证顺序：先检查格式，再检查唯一性**

- **唯一性要求：**
  - 手机号在系统中必须唯一
  - **如果手机号已被注册，必须返回 `msg: "error"` 和错误信息 "该手机号已被注册"**
  - 前端会根据此错误信息显示给用户
  - 建议在数据库中对 `phone` 字段设置唯一索引，防止重复数据

- **示例：**
  - ✅ 正确：`13800138000`、`15912345678`、`18600000000`
  - ❌ 错误：`12345678901`（第二位不是3-9）、`1380013800`（只有10位）、`138001380001`（超过11位）

- **错误响应示例：**
  ```json
  {
    "msg": "error",
    "error": "该手机号已被注册"
  }
  ```

### 2. 账号验证规则

- **格式要求：**
  - 账号不能为空
  - **账号长度至少6个字符**（必填要求）
  - 建议限制最大长度（如20个字符）
  - 建议只允许字母、数字、下划线

- **唯一性要求：**
  - 账号在系统中必须唯一
  - 如果账号已注册，应返回 `msg: "registered"` 和错误信息 "该账号已注册"
  - **注意：账号唯一性检查应在格式验证之后进行**

- **长度验证：**
  - 如果账号长度少于6个字符，应返回错误 "账号长度不能少于6位"
  - 验证顺序：先检查是否为空，再检查长度，最后检查唯一性

### 3. 密码验证规则

- **长度要求：**
  - **密码长度至少6个字符**（必填要求）
  - 密码长度不能超过20个字符
  - 不能为空

- **验证规则：**
  - 如果密码长度少于6个字符，应返回错误 "密码长度不能少于6位"
  - 如果密码长度超过20个字符，应返回错误 "密码长度应在6-20个字符之间"

- **安全性要求：**
  - 密码在传输过程中应进行加密处理（HTTPS）
  - 后端应对密码进行哈希加密存储（如 bcrypt、argon2）
  - 不应存储明文密码
  - 建议对密码强度进行验证（包含字母和数字等）

### 4. 姓名验证规则

- **格式要求：**
  - 姓名不能为空
  - 建议限制长度（如1-50个字符）
  - 建议允许中文、英文、数字等常见字符

---

## 错误处理

### 错误响应格式

所有错误响应都遵循以下格式：

```json
{
  "msg": "error" | "registered",
  "error": "错误描述信息"
}
```

### 错误响应类型说明

#### 1. 账号已注册（特殊错误类型）

当账号已存在时，使用特殊的 `msg: "registered"` 来区分：

```json
{
  "msg": "registered",
  "error": "该账号已注册"
}
```

**说明：**
- 使用 `msg: "registered"` 而不是 `msg: "error"`，便于前端区分处理
- 前端可以针对此错误类型提供特殊提示（如引导用户直接登录）

#### 2. 其他错误（通用错误类型）

所有其他错误都使用 `msg: "error"`，通过 `error` 字段区分具体错误：

```json
{
  "msg": "error",
  "error": "具体错误信息"
}
```

### 完整错误列表

| 错误信息 | msg值 | 说明 | 前端处理建议 | HTTP状态码建议 |
|---------|-------|------|------------|--------------|
| 该账号已注册 | "registered" | 账号已存在 | 提示用户该账号已被使用，建议更换账号或直接登录 | 200 |
| 该手机号已被注册 | "error" | 手机号已存在 | **提示用户该手机号已被注册，建议更换手机号或找回密码** | 200 |
| 手机号必须是11位数字 | "error" | 手机号格式不正确 | 提示用户输入正确的11位手机号 | 200 |
| 手机号格式不正确 | "error" | 手机号格式不符合要求 | 提示用户输入正确的11位手机号（以1开头，第二位3-9） | 200 |
| 账号长度不能少于6位 | "error" | 账号长度不足 | 提示用户账号至少需要6个字符 | 200 |
| 账号不能为空 | "error" | 账号字段缺失 | 提示用户输入账号 | 200 |
| 密码长度不能少于6位 | "error" | 密码长度不足 | 提示用户密码至少需要6个字符 | 200 |
| 密码长度应在6-20个字符之间 | "error" | 密码长度不符合要求 | 提示用户输入符合长度要求的密码 | 200 |
| 密码不能为空 | "error" | 密码字段缺失 | 提示用户输入密码 | 200 |
| 姓名不能为空 | "error" | 姓名字段缺失 | 提示用户输入姓名 | 200 |
| 服务器出错 | "error" | 服务器内部错误 | 提示用户稍后重试 | 500 |

### 错误处理优先级

后端应按以下优先级进行验证和返回错误：

1. **必填字段验证**（最高优先级）
   - 检查所有必填字段是否存在
   - 如果缺失，立即返回相应错误

2. **格式验证**
   - 手机号格式验证
   - 账号长度验证
   - 密码长度验证

3. **唯一性验证**
   - 检查账号是否已存在
   - 检查手机号是否已注册

4. **业务逻辑验证**
   - 其他业务规则验证

### 前端错误处理示例

```javascript
// 注册接口调用后的错误处理
const result = await ajax('/register', 'POST', params);

if (result?.msg === 'success') {
  // 注册成功
  wx.showToast({
    title: '注册成功',
    icon: 'success'
  });
} else if (result?.msg === 'registered') {
  // 账号已注册（特殊处理）
  wx.showToast({
    title: result?.error || '该账号已注册',
    icon: 'none',
    duration: 2000
  });
  // 可以引导用户去登录页面
} else if (result?.msg === 'error') {
  // 其他错误（包括手机号已注册）
  const errorMsg = result?.error || '注册失败';
  wx.showToast({
    title: errorMsg,
    icon: 'none',
    duration: 2000
  });
  
  // 如果是手机号已注册，可以引导用户找回密码
  if (errorMsg.includes('手机号') && errorMsg.includes('注册')) {
    // 可以显示"忘记密码"的提示
  }
} else {
  // 未知错误
  wx.showToast({
    title: '注册失败，请重试',
    icon: 'none'
  });
}
```

---

## 接口调用示例

### 前端调用注册接口（微信小程序）

```javascript
import { ajax } from '../../utils/index'

// 用户注册
async function register(name, phone, account, password) {
  try {
    // 前端验证
    if (!name || !name.trim()) {
      wx.showToast({
        title: '请输入姓名',
        icon: 'none'
      });
      return false;
    }

    if (!phone || !phone.trim()) {
      wx.showToast({
        title: '请输入手机号',
        icon: 'none'
      });
      return false;
    }

    // 验证手机号格式（11位数字）
    const phoneRegex = /^1[3-9]\d{9}$/;
    if (!phoneRegex.test(phone.trim())) {
      wx.showToast({
        title: '手机号必须是11位数字',
        icon: 'none'
      });
      return false;
    }

    if (!account || !account.trim()) {
      wx.showToast({
        title: '请输入账号',
        icon: 'none'
      });
      return false;
    }

    if (!password || !password.trim()) {
      wx.showToast({
        title: '请输入密码',
        icon: 'none'
      });
      return false;
    }

    // 验证密码长度
    if (password.length < 6 || password.length > 20) {
      wx.showToast({
        title: '密码长度应在6-20个字符之间',
        icon: 'none'
      });
      return false;
    }

    // 调用注册接口
    const result = await ajax('/register', 'POST', {
      name: name.trim(),
      phone: phone.trim(),
      account: account.trim(),
      password: password.trim()
    });
    
    if (result?.msg === 'success') {
      wx.showToast({
        title: '注册成功',
        icon: 'success'
      });
      return true;
    } else if (result?.msg === 'registered') {
      // 账号已注册
      wx.showToast({
        title: result?.error || '该账号已注册',
        icon: 'none',
        duration: 2000
      });
      return false;
    } else if (result?.msg === 'error') {
      // 其他错误（包括手机号已注册、格式错误等）
      // 显示后端返回的具体错误信息
      const errorMsg = result?.error || '注册失败';
      wx.showToast({
        title: errorMsg,
        icon: 'none',
        duration: 2000
      });
      
      // 如果是手机号已注册，可以引导用户
      if (errorMsg.includes('手机号') && errorMsg.includes('注册')) {
        // 可以显示"忘记密码"的提示或跳转链接
      }
      
      return false;
    } else {
      // 未知错误
      wx.showToast({
        title: result?.error || '注册失败，请重试',
        icon: 'none',
        duration: 2000
      });
      return false;
    }
  } catch (error) {
    console.error('注册失败:', error);
    wx.showToast({
      title: '网络请求失败',
      icon: 'none'
    });
    return false;
  }
}
```

---

## 测试用例

### 测试用例1：正常注册

**请求：**
```json
POST /register
{
  "name": "张三",
  "phone": "13800138000",
  "account": "zhangsan",
  "password": "password123"
}
```

**预期结果：**
- 返回 `msg: "success"`
- 返回新用户的 `user_id`
- 数据库中新增一条用户记录

### 测试用例2：账号已注册

**请求：**
```json
POST /register
{
  "name": "李四",
  "phone": "13900139000",
  "account": "zhangsan",
  "password": "password456"
}
```

**说明：** 使用已存在的账号 "zhangsan"

**预期结果：**
- 返回 `msg: "registered"`
- 返回错误信息 "该账号已注册"
- 不创建新用户

### 测试用例3：手机号已注册

**请求：**
```json
POST /register
{
  "name": "王五",
  "phone": "13800138000",
  "account": "wangwu",
  "password": "password789"
}
```

**说明：** 使用已存在的手机号 "13800138000"

**预期结果：**
- 返回 `msg: "error"`
- 返回错误信息 **"该手机号已被注册"**（必须包含此错误信息）
- 前端会显示此错误提示给用户
- 不创建新用户
- 建议前端可以引导用户去"忘记密码"页面

### 测试用例4：手机号格式错误（位数不对）

**请求：**
```json
POST /register
{
  "name": "赵六",
  "phone": "1380013800",
  "account": "zhaoliu",
  "password": "password123"
}
```

**说明：** 手机号只有10位

**预期结果：**
- 返回 `msg: "error"`
- 返回错误信息 "手机号必须是11位数字"
- 不创建新用户

### 测试用例5：手机号格式错误（第二位不是3-9）

**请求：**
```json
POST /register
{
  "name": "孙七",
  "phone": "12800138000",
  "account": "sunqi",
  "password": "password123"
}
```

**说明：** 手机号第二位是2，不符合要求

**预期结果：**
- 返回 `msg: "error"`
- 返回错误信息 "手机号必须是11位数字"
- 不创建新用户

### 测试用例6：账号长度不足

**请求：**
```json
POST /register
{
  "name": "周八",
  "phone": "13800138001",
  "account": "abc",
  "password": "password123"
}
```

**说明：** 账号只有3个字符，少于6位

**预期结果：**
- 返回 `msg: "error"`
- 返回错误信息 "账号长度不能少于6位"
- 不创建新用户

### 测试用例7：密码长度不足

**请求：**
```json
POST /register
{
  "name": "吴九",
  "phone": "13800138002",
  "account": "wujiu",
  "password": "12345"
}
```

**说明：** 密码只有5个字符，少于6位

**预期结果：**
- 返回 `msg: "error"`
- 返回错误信息 "密码长度不能少于6位"
- 不创建新用户

### 测试用例8：密码长度过长

**请求：**
```json
POST /register
{
  "name": "郑十",
  "phone": "13800138003",
  "account": "zhengshi",
  "password": "123456789012345678901"
}
```

**说明：** 密码超过20个字符

**预期结果：**
- 返回 `msg: "error"`
- 返回错误信息 "密码长度应在6-20个字符之间"
- 不创建新用户

### 测试用例9：必填字段缺失

**请求：**
```json
POST /register
{
  "name": "郑十",
  "phone": "13800138003",
  "account": "zhengshi"
}
```

**说明：** 缺少 `password` 字段

**预期结果：**
- 返回 `msg: "error"`
- 返回错误信息 "密码不能为空" 或类似提示
- 不创建新用户

---

## 安全注意事项

1. **数据验证：**
   - 前端应进行基础验证（格式、长度等）
   - 后端应进行完整验证和安全检查
   - 前后端验证规则应保持一致
   - 后端不应信任前端验证，必须进行二次验证

2. **密码安全：**
   - 密码在传输过程中应使用 HTTPS 加密
   - 后端应对密码进行哈希加密存储（推荐使用 bcrypt、argon2）
   - 不应存储明文密码
   - 建议对密码强度进行验证

3. **手机号安全：**
   - 手机号格式必须严格验证
   - 手机号在系统中必须唯一
   - 建议记录注册操作日志

4. **账号安全：**
   - 账号在系统中必须唯一
   - 建议对账号格式进行限制（如只允许字母、数字、下划线）
   - 建议限制账号长度

5. **防重复注册：**
   - 检查账号是否已存在
   - **检查手机号是否已注册（必须检查，并返回明确的错误信息）**
   - 防止并发注册导致的数据重复
   - 建议使用数据库唯一约束 + 应用层检查的双重保障

6. **错误信息规范：**
   - **手机号已注册的错误信息必须为："该手机号已被注册"**（与前端显示保持一致）
   - 所有错误信息应清晰明确，便于用户理解
   - 建议统一错误信息格式，便于前端统一处理

---

## 数据库设计建议

### 用户表字段

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| user_id | INT/BIGINT | 用户ID | 主键，自增 |
| name | VARCHAR(50) | 用户姓名 | 非空 |
| phone | VARCHAR(11) | 手机号 | 非空，唯一索引 |
| account | VARCHAR(50) | 账号 | 非空，唯一索引 |
| password | VARCHAR(255) | 密码（哈希值） | 非空 |
| create_time | DATETIME | 创建时间 | 默认当前时间 |
| update_time | DATETIME | 更新时间 | 自动更新 |

### 索引建议

- 在 `phone` 字段上创建唯一索引（**必须**，用于快速检查手机号是否已注册）
- 在 `account` 字段上创建唯一索引（**必须**，用于快速检查账号是否已注册）
- 在 `user_id` 字段上创建主键索引

### 后端实现建议

#### 1. 验证顺序

建议按以下顺序进行验证：

```javascript
// 伪代码示例
function register(name, phone, account, password) {
  // 1. 必填字段验证
  if (!name || !name.trim()) {
    return { msg: 'error', error: '姓名不能为空' };
  }
  if (!phone || !phone.trim()) {
    return { msg: 'error', error: '手机号不能为空' };
  }
  if (!account || !account.trim()) {
    return { msg: 'error', error: '账号不能为空' };
  }
  if (!password || !password.trim()) {
    return { msg: 'error', error: '密码不能为空' };
  }

  // 2. 格式验证
  const phoneRegex = /^1[3-9]\d{9}$/;
  if (!phoneRegex.test(phone.trim())) {
    return { msg: 'error', error: '手机号必须是11位数字' };
  }
  
  if (account.trim().length < 6) {
    return { msg: 'error', error: '账号长度不能少于6位' };
  }
  
  if (password.trim().length < 6) {
    return { msg: 'error', error: '密码长度不能少于6位' };
  }
  
  if (password.trim().length > 20) {
    return { msg: 'error', error: '密码长度应在6-20个字符之间' };
  }

  // 3. 唯一性验证（必须在格式验证之后）
  if (accountExists(account.trim())) {
    return { msg: 'registered', error: '该账号已注册' };
  }
  
  if (phoneExists(phone.trim())) {
    return { msg: 'error', error: '该手机号已被注册' }; // 关键：必须返回此错误信息
  }

  // 4. 业务逻辑处理
  // ... 创建用户
}
```

#### 2. 手机号已注册检查

**必须实现：**

```javascript
// 检查手机号是否已注册
function phoneExists(phone) {
  // 查询数据库中是否存在该手机号
  // 返回 true 或 false
}

// 在注册接口中调用
if (phoneExists(phone.trim())) {
  return {
    msg: 'error',
    error: '该手机号已被注册'  // 错误信息必须与此一致
  };
}
```

#### 3. 错误信息规范

所有错误信息应遵循以下规范：

| 错误类型 | 错误信息 | 说明 |
|---------|---------|------|
| 手机号已注册 | "该手机号已被注册" | **必须使用此错误信息** |
| 账号已注册 | "该账号已注册" | 使用 msg: "registered" |
| 手机号格式错误 | "手机号必须是11位数字" | 格式验证失败 |
| 账号长度不足 | "账号长度不能少于6位" | 长度验证失败 |
| 密码长度不足 | "密码长度不能少于6位" | 长度验证失败 |
| 密码长度过长 | "密码长度应在6-20个字符之间" | 长度验证失败 |

---

## 后端实现检查清单

### 必须实现的验证

- [ ] 手机号格式验证（11位数字，1开头，第二位3-9）
- [ ] **手机号唯一性检查（必须实现）**
- [ ] **手机号已注册时返回错误："该手机号已被注册"**（必须，错误信息必须与此完全一致）
- [ ] 账号长度验证（至少6个字符）
- [ ] 账号唯一性检查
- [ ] 账号已注册时返回 `msg: "registered"` 和错误："该账号已注册"
- [ ] 密码长度验证（6-20个字符）
- [ ] 所有必填字段验证

### 错误响应检查

- [ ] 手机号已注册时，`msg` 必须为 `"error"`
- [ ] **手机号已注册时，`error` 必须为 `"该手机号已被注册"`**（必须，前端依赖此错误信息）
- [ ] 账号已注册时，`msg` 必须为 `"registered"`
- [ ] 所有错误响应都包含 `error` 字段
- [ ] 错误信息使用中文，便于用户理解

### 数据库检查

- [ ] `phone` 字段设置了唯一索引
- [ ] `account` 字段设置了唯一索引
- [ ] 数据库约束可以防止重复数据插入

---

## 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0.0 | 2024-XX-XX | 初始版本，添加注册接口文档，明确手机号必须是11位数字的验证规则 |
| 1.1.0 | 2024-XX-XX | 完善错误处理说明，明确手机号已注册的错误响应格式，添加账号和密码长度验证规则 |
| 1.2.0 | 2024-XX-XX | 完善错误处理细节，添加前端错误处理示例，明确错误信息规范 |
| 1.3.0 | 2024-XX-XX | 添加后端实现建议、验证顺序说明、错误信息规范和后端实现检查清单 |

---

## 注意事项

1. **用户体验：**
   - 手机号输入框应限制为11位数字（使用 `type="number"` 和 `maxlength="11"`）
   - 密码输入框应使用 `type="password"` 隐藏输入内容
   - 注册成功后，应提示用户跳转到登录页面
   - 如果账号已注册，应提示用户直接登录
   - **如果手机号已注册，应明确提示用户，并可以引导用户去"忘记密码"页面**

2. **错误提示：**
   - 错误提示应清晰明确，帮助用户理解问题
   - **必须区分"账号已注册"和"手机号已注册"的不同错误**
   - 前端应显示后端返回的具体错误信息（`result?.error`），而不是通用的"服务器出错"
   - 不要泄露敏感信息

3. **数据一致性：**
   - 确保账号和手机号的唯一性
   - 使用数据库唯一约束防止重复数据
   - 处理并发注册的情况
   - **手机号唯一性检查必须在注册时进行，如果已存在必须返回明确的错误信息**

4. **性能优化：**
   - 对手机号和账号字段建立索引，提高查询速度
   - 使用数据库事务确保数据一致性

5. **错误信息规范：**
   - **手机号已注册的错误信息必须为："该手机号已被注册"**（与接口文档保持一致）
   - 前端会根据此错误信息显示给用户
   - 建议后端统一错误信息格式，便于前端处理

---

## 关键要点总结

### ⚠️ 必须实现的功能

1. **手机号唯一性检查**
   - 必须检查手机号是否已注册
   - 如果已注册，必须返回：`{"msg": "error", "error": "该手机号已被注册"}`
   - 错误信息必须与此完全一致，前端依赖此信息显示给用户

2. **账号唯一性检查**
   - 必须检查账号是否已注册
   - 如果已注册，返回：`{"msg": "registered", "error": "该账号已注册"}`

3. **格式验证**
   - 手机号：11位数字，1开头，第二位3-9
   - 账号：至少6个字符
   - 密码：6-20个字符

### 📋 验证顺序

1. 必填字段验证
2. 格式验证（手机号、账号、密码）
3. 唯一性验证（账号、手机号）
4. 业务逻辑处理

### 🔍 错误响应格式

- **账号已注册**：`msg: "registered"`
- **其他所有错误**：`msg: "error"`，通过 `error` 字段区分具体错误
- **手机号已注册**：`msg: "error"`，`error: "该手机号已被注册"`


