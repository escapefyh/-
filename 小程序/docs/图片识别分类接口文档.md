# 图片识别分类接口文档

## 概述

本文档描述了商品图片识别分类功能的接口规范。商家在上传商品图片时，系统会自动识别第一张图片并推荐商品分类，商家可以接受推荐或手动修改。

## 接口信息

### 图片识别接口

**接口地址：** `http://localhost:3000/recognize`

**请求方法：** `POST`

**Content-Type：** `multipart/form-data`

---

## 请求参数

### 表单数据

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| image | File | 是 | 商品图片文件（第一张上传的图片） |

### 请求示例

**前端调用方式（微信小程序）：**

```javascript
wx.uploadFile({
  url: 'http://localhost:5000/recognize',
  filePath: '/path/to/image.jpg', // 本地图片路径
  name: 'image', // 表单字段名
  success: (res) => {
    const result = JSON.parse(res.data);
    // 处理识别结果
  }
});
```

---

## 响应格式

### 成功响应

#### 方案一：返回分类ID和名称

```json
{
  "category_id": 1,
  "category_name": "美食生鲜",
  "confidence": 0.95
}
```

#### 方案二：只返回分类名称（前端根据名称匹配ID）

```json
{
  "category": "美食生鲜",
  "confidence": 0.95
}
```

#### 方案三：返回分类ID（前端根据ID查找名称）

```json
{
  "category_id": 1,
  "confidence": 0.95
}
```

### 字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| category_id | Integer | 商品分类ID（可选，如果提供，前端直接使用） |
| category_name | String | 商品分类名称（可选，如果提供，前端直接使用） |
| category | String | 商品分类名称（与category_name等价，二选一） |
| confidence | Float | 识别置信度（0-1之间，可选） |

### 错误响应

```json
{
  "error": "图片识别失败",
  "message": "无法识别图片内容，请手动选择分类"
}
```

或

```json
{
  "status": "error",
  "error": "图片格式不支持",
  "message": "仅支持 JPG、PNG 格式的图片"
}
```

---

## 商品分类列表

前端使用的分类列表如下，识别API返回的分类名称或ID应该与以下列表匹配：

| category_id | category_name |
|-------------|---------------|
| 1 | 水果蔬菜 |
| 2 | 美妆个护 |
| 3 | 家居百货 |
| 4 | 数码家电 |
| 5 | 服饰鞋包 |
| 6 | 母婴用品 |
| 7 | 运动户外 |
| 8 | 图书文娱 |
| 9 | 宠物用品 |
| 10 | 食品保健 |
| 11 | 汽车用品 |
| 12 | 办公文具 |
| 13 | 其他用品 |

---

## 前端实现逻辑

### 1. 触发时机

- 用户上传第一张图片时，自动触发识别
- 如果用户已经手动选择了分类，不再自动识别
- 如果识别失败，不影响用户继续操作

### 2. 识别流程

```
用户上传图片
    ↓
检查是否已有分类？
    ↓ 否
显示"正在识别商品分类..."
    ↓
调用识别API（POST /recognize）
    ↓
解析识别结果
    ↓
匹配分类ID和名称
    ↓
自动填充分类
    ↓
显示"已识别为：XXX"提示
    ↓
标记为自动识别（显示"已自动识别"标签）
```

### 3. 用户修改

- 用户可以点击分类区域手动修改
- 用户手动选择后，清除"已自动识别"标记
- 用户修改分类不影响已上传的图片

### 4. 错误处理

- 识别失败：显示"识别失败，请手动选择分类"提示
- 网络错误：显示"网络请求失败"提示
- 无法匹配分类：显示"未能识别分类，请手动选择"提示

---

## 请求示例

### cURL 示例

```bash
curl -X POST http://localhost:5000/recognize \
  -F "image=@/path/to/product_image.jpg"
```

### Python 示例

```python
import requests

url = "http://localhost:5000/recognize"
files = {'image': open('product_image.jpg', 'rb')}
response = requests.post(url, files=files)
result = response.json()
print(result)
```

### JavaScript (Node.js) 示例

```javascript
const FormData = require('form-data');
const fs = require('fs');
const axios = require('axios');

const form = new FormData();
form.append('image', fs.createReadStream('product_image.jpg'));

axios.post('http://localhost:5000/recognize', form, {
  headers: form.getHeaders()
})
.then(response => {
  console.log(response.data);
})
.catch(error => {
  console.error(error);
});
```

---

## 数据验证规则

### 1. 图片格式

- 支持的格式：JPG、JPEG、PNG
- 文件大小限制：建议不超过 10MB
- 图片尺寸：建议不超过 4096x4096 像素

### 2. 识别结果验证

- `category_id` 必须在 1-13 之间（如果提供）
- `category_name` 必须与分类列表中的名称匹配（如果提供）
- `confidence` 应该在 0-1 之间（如果提供）

### 3. 错误处理

- 如果图片无法识别，返回错误信息
- 如果识别结果不在分类列表中，前端应提示用户手动选择

---

## 前端代码示例

### 识别函数（utils/index.js）

```javascript
/**
 * 调用图片识别API识别商品分类
 * @param {string} filePath 本地图片文件路径
 * @returns {Promise<Object>} 返回识别结果
 */
const recognizeImage = (filePath) => {
  const base_url = 'http://localhost:3000';
  return new Promise((resolve, reject) => {
    wx.uploadFile({
      url: `${base_url}/recognize`,
      filePath: filePath,
      name: 'image',
      success: (uploadRes) => {
        try {
          const result = JSON.parse(uploadRes.data);
          if (result.error) {
            reject(new Error(result.message || result.error));
            return;
          }
          resolve({
            category_id: result.category_id,
            category_name: result.category_name,
            confidence: result.confidence
          });
        } catch (e) {
          reject(new Error('识别失败：' + e.message));
        }
      },
      fail: (err) => {
        reject(new Error('网络请求失败：' + (err.errMsg || '未知错误')));
      }
    });
  });
};
```

### 调用识别（pages/sellgoods/sellgoods.js）

```javascript
/**
 * 识别商品分类
 */
async recognizeCategory(imagePath) {
  // 如果已经有分类了，不自动识别
  if (this.data.selectedCategoryId) {
    return;
  }

  this.setData({ isRecognizing: true });

  try {
    wx.showLoading({
      title: '正在识别商品分类...',
      mask: true
    });

    const result = await recognizeImage(imagePath);
    wx.hideLoading();

    // 解析识别结果
    let categoryId = result.category_id;
    let categoryName = result.category_name || result.category;

    // 如果没有直接返回category_id，根据category_name查找
    if (!categoryId && categoryName) {
      const matchedCategory = this.data.categoryList.find(
        cat => cat.name === categoryName || 
              cat.name.includes(categoryName) || 
              categoryName.includes(cat.name)
      );
      if (matchedCategory) {
        categoryId = matchedCategory.category_id;
        categoryName = matchedCategory.name;
      }
    }

    if (categoryId && categoryName) {
      const categoryIndex = this.data.categoryList.findIndex(
        cat => cat.category_id === categoryId
      );

      this.setData({
        selectedCategoryId: categoryId,
        selectedCategoryName: categoryName,
        categoryIndex: categoryIndex >= 0 ? categoryIndex : -1,
        autoDetectedCategory: true
      });

      wx.showToast({
        title: `已识别为：${categoryName}`,
        icon: 'success',
        duration: 2000
      });
    } else {
      wx.showToast({
        title: '未能识别分类，请手动选择',
        icon: 'none',
        duration: 2000
      });
    }
  } catch (error) {
    wx.hideLoading();
    console.error('图片识别失败:', error);
    wx.showToast({
      title: '识别失败，请手动选择分类',
      icon: 'none',
      duration: 2000
    });
  } finally {
    this.setData({ isRecognizing: false });
  }
}
```

---

## 注意事项

### 1. 网络配置

- **开发环境：** 接口地址为 `http://localhost:3000/recognize`
- **生产环境：** 需要将 `localhost:3000` 替换为实际的服务器地址
- **微信小程序：** 需要在微信公众平台配置合法域名，或使用开发工具的网络代理

### 2. 跨域问题

- 如果遇到跨域问题，需要在识别API服务器端设置CORS头：
  ```
  Access-Control-Allow-Origin: *
  Access-Control-Allow-Methods: POST, OPTIONS
  Access-Control-Allow-Headers: Content-Type
  ```

### 3. 性能优化

- 识别过程可能需要几秒钟，前端应显示加载提示
- 建议对图片进行压缩后再上传，减少传输时间
- 可以考虑异步识别，不阻塞用户继续操作

### 4. 用户体验

- 识别失败不应影响用户继续发布商品
- 自动识别的分类应该明显标记，让用户知道可以修改
- 用户手动修改分类后，应清除自动识别标记

### 5. 错误处理

- 网络错误：提示用户检查网络连接
- 识别失败：提示用户手动选择分类
- 无法匹配分类：提示用户手动选择分类

---

## 测试建议

### 1. 功能测试

- 测试上传不同类别的商品图片
- 测试识别准确率
- 测试识别失败的情况
- 测试用户修改分类的功能

### 2. 边界测试

- 测试超大图片
- 测试不支持的图片格式
- 测试网络超时
- 测试识别API不可用的情况

### 3. 用户体验测试

- 测试识别速度
- 测试提示信息是否清晰
- 测试修改分类的流程

---

## 更新日志

- **2024-XX-XX**：初始版本，添加图片识别分类功能接口文档

---

## 联系方式

如有疑问，请联系后端开发团队。


