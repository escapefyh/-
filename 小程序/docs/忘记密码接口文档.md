# 忘记密码接口文档

## 概述

本文档描述了忘记密码功能的接口规范。用户可以通过注册时填写的手机号来重置密码，只需验证手机号匹配即可修改密码。

---

## 通过手机号重置密码接口

### 接口信息

**接口地址：** `POST /user/resetPasswordByPhone`

**请求方法：** `POST`

**Content-Type：** `application/json`

---

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| phone | String | 是 | 用户注册时填写的手机号（11位数字） |
| new_password | String | 是 | 新密码（6-20个字符） |

### 请求示例

```json
{
  "phone": "13800138000",
  "new_password": "newPassword123"
}
```

---

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "message": "密码重置成功"
  }
}
```

#### 错误响应

**手机号未注册：**
```json
{
  "msg": "error",
  "error": "该手机号未注册"
}
```

**新密码格式不正确：**
```json
{
  "msg": "error",
  "error": "新密码长度应在6-20个字符之间"
}
```

**新密码与原密码相同：**
```json
{
  "msg": "error",
  "error": "新密码不能与原密码相同"
}
```

---

### 字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态，"success" 表示成功，"error" 表示失败 |
| error | String | 错误信息（仅在失败时返回） |
| data | Object | 响应数据（仅在成功时返回） |

---

### 业务规则

1. **手机号验证：**
   - 手机号必须在系统中已注册
   - 手机号格式必须正确（11位数字，以1开头，第二位为3-9）
   - 如果手机号未注册，应返回错误提示

2. **密码验证：**
   - 新密码长度必须在 6-20 个字符之间
   - 新密码不能与原密码相同
   - 建议对密码强度进行验证（包含字母和数字等）

4. **安全性要求：**
   - 新密码在传输过程中应进行加密处理
   - 后端应对新密码进行哈希加密存储
   - 建议记录密码重置操作日志
   - 密码重置成功后，建议使该用户的所有登录会话失效

3. **错误处理：**
   - 如果手机号未注册，返回 "该手机号未注册"
   - 如果手机号格式不正确，返回 "手机号格式不正确"
   - 如果新密码格式不正确，返回相应的错误提示
   - 如果新密码与原密码相同，返回 "新密码不能与原密码相同"

---

## 接口调用示例

### 前端调用重置密码接口（微信小程序）

```javascript
import { ajax } from '../../utils/index'

// 通过手机号重置密码
async function resetPasswordByPhone(phone, newPassword) {
  try {
    // 验证手机号格式
    const phoneRegex = /^1[3-9]\d{9}$/;
    if (!phoneRegex.test(phone)) {
      wx.showToast({
        title: '请输入正确的手机号',
        icon: 'none'
      });
      return false;
    }

    const result = await ajax('/user/resetPasswordByPhone', 'POST', {
      phone: phone,
      new_password: newPassword
    });
    
    if (result?.msg === 'success') {
      wx.showToast({
        title: '密码重置成功',
        icon: 'success'
      });
      return true;
    } else {
      wx.showToast({
        title: result?.error || '密码重置失败',
        icon: 'none'
      });
      return false;
    }
  } catch (error) {
    console.error('重置密码失败:', error);
    wx.showToast({
      title: '网络请求失败',
      icon: 'none'
    });
    return false;
  }
}
```

---

## 错误码说明

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| 该手机号未注册 | 提供的手机号在系统中不存在 | 提示用户检查手机号是否正确，或引导用户注册 |
| 手机号格式不正确 | 手机号格式不符合要求 | 提示用户输入正确的11位手机号 |
| 新密码长度应在6-20个字符之间 | 新密码长度不符合要求 | 提示用户输入符合长度要求的密码 |
| 新密码不能与原密码相同 | 新密码与原密码相同 | 提示用户输入不同的新密码 |
| 网络请求失败 | 网络连接问题 | 提示用户检查网络连接后重试 |

---

## 安全注意事项

1. **手机号验证：**
   - 必须验证手机号是否在系统中已注册
   - 手机号格式必须正确（11位数字）
   - 建议记录密码重置操作日志，监控异常行为

2. **密码安全：**
   - 新密码在传输过程中应使用 HTTPS 加密
   - 后端应对新密码进行哈希加密存储（如 bcrypt）
   - 不应存储明文密码
   - 建议对密码强度进行验证

3. **操作日志：**
   - 记录所有密码重置操作
   - 记录操作时间、IP地址等信息
   - 便于追踪和审计

4. **会话管理：**
   - 密码重置成功后，建议使该用户的所有登录会话失效
   - 要求用户使用新密码重新登录

---

## 测试用例

### 测试用例1：正常流程

- 请求：`POST /user/resetPasswordByPhone`，`{"phone": "13800138000", "new_password": "newPass123"}`
- 预期：返回成功，密码已更新

### 测试用例2：手机号未注册

- 请求：`POST /user/resetPasswordByPhone`，`{"phone": "13999999999", "new_password": "newPass123"}`
- 预期：返回错误 "该手机号未注册"

### 测试用例3：手机号格式错误

- 请求：`POST /user/resetPasswordByPhone`，`{"phone": "123456789", "new_password": "newPass123"}`
- 预期：返回错误 "手机号格式不正确"

### 测试用例4：新密码格式错误

- 请求：`POST /user/resetPasswordByPhone`，`{"phone": "13800138000", "verify_code": "123456", "new_password": "123"}`
- 预期：返回错误 "新密码长度应在6-20个字符之间"

---

## 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0.0 | 2024-XX-XX | 初始版本，添加忘记密码接口文档 |

---

## 注意事项

1. **用户体验：**
   - 手机号输入框应限制为11位数字
   - 密码输入框应使用 `type="password"` 隐藏输入内容
   - 重置成功后，应提示用户使用新密码登录
   - 如果手机号未注册，应给出明确的错误提示

2. **错误提示：**
   - 错误提示应清晰明确，帮助用户理解问题
   - 不要泄露敏感信息（如验证码、密码等）

3. **数据验证：**
   - 前端应进行基础验证（格式、长度等）
   - 后端应进行完整验证和安全检查
   - 前后端验证规则应保持一致

4. **安全建议：**
   - 虽然简化了流程，但仍需确保手机号验证的准确性
   - 建议对密码重置操作进行频率限制（如每天最多3次）
   - 建议记录所有密码重置操作，便于安全审计

