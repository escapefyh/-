# 聊天功能接口文档

## 概述

本文档描述了小程序聊天功能的接口规范，包括发送消息、获取聊天记录、获取聊天列表等功能。

---

## 1. 发送消息

### 接口地址
`POST /chat/send`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| sender_id | Integer | 是 | 发送者用户ID |
| receiver_id | Integer | 是 | 接收者用户ID |
| content | String | 是 | 消息内容（1-500个字符） |
| goods_id | Integer | 否 | 关联的商品ID（可选，用于标识聊天来源） |

### 请求示例

```json
{
  "sender_id": 123,
  "receiver_id": 456,
  "content": "你好，请问这个商品还有货吗？",
  "goods_id": 789
}
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态："success" 或错误信息 |
| data | Object | 响应数据 |
| data.message_id | Integer | 消息ID |
| data.create_time | String | 消息创建时间（ISO 8601格式） |

### 响应示例

**成功：**
```json
{
  "msg": "success",
  "data": {
    "message_id": 1001,
    "create_time": "2024-01-15T10:30:00Z"
  }
}
```

**失败：**
```json
{
  "msg": "error",
  "error": "消息内容不能为空"
}
```

### 错误码说明

| 错误码 | 说明 |
|--------|------|
| "error" | 通用错误（具体错误信息在 error 字段中） |
| "senderNotFound" | 发送者不存在 |
| "receiverNotFound" | 接收者不存在 |
| "contentEmpty" | 消息内容为空 |
| "contentTooLong" | 消息内容超过500字符 |

### 业务规则

1. **商家不能和自己聊天**：前端在点击"聊一聊"时会检查 `seller.user_id != current_user_id`，后端也应该进行验证。
2. **消息内容验证**：
   - 不能为空
   - 长度限制：1-500个字符
   - 不能包含敏感词（后端自行实现）
3. **自动创建聊天会话**：如果发送者和接收者之间还没有聊天会话，系统应自动创建一个新的聊天会话。

---

## 2. 获取聊天记录

### 接口地址
`GET /chat/messages`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | Integer | 是 | 当前用户ID |
| target_user_id | Integer | 是 | 聊天对象用户ID |
| page | Integer | 否 | 页码（默认1） |
| pageSize | Integer | 否 | 每页数量（默认20，最大100） |

### 请求示例

```
GET /chat/messages?user_id=123&target_user_id=456&page=1&pageSize=20
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态："success" 或错误信息 |
| data | Object | 响应数据 |
| data.list | Array | 消息列表 |
| data.list[].message_id | Integer | 消息ID |
| data.list[].sender_id | Integer | 发送者用户ID |
| data.list[].receiver_id | Integer | 接收者用户ID |
| data.list[].content | String | 消息内容 |
| data.list[].create_time | String | 消息创建时间（ISO 8601格式） |
| data.total | Integer | 消息总数 |

### 响应示例

**成功：**
```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "message_id": 1001,
        "sender_id": 123,
        "receiver_id": 456,
        "content": "你好，请问这个商品还有货吗？",
        "create_time": "2024-01-15T10:30:00Z"
      },
      {
        "message_id": 1002,
        "sender_id": 456,
        "receiver_id": 123,
        "content": "有的，还有库存",
        "create_time": "2024-01-15T10:31:00Z"
      }
    ],
    "total": 50
  }
}
```

**失败：**
```json
{
  "msg": "error",
  "error": "用户不存在"
}
```

### 业务规则

1. **权限验证**：只能获取当前用户参与的聊天记录。
2. **排序规则**：按 `create_time` 升序排列（最早的在前）。
3. **分页**：支持分页加载历史消息。

---

## 3. 标记消息为已读

### 接口地址
`POST /chat/markRead`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | Integer | 是 | 当前用户ID（接收者） |
| target_user_id | Integer | 是 | 聊天对象用户ID（发送者） |

### 请求示例

```json
{
  "user_id": 123,
  "target_user_id": 456
}
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态："success" 或错误信息 |
| data | Object | 响应数据（可选） |

### 响应示例

**成功：**
```json
{
  "msg": "success",
  "data": {}
}
```

**失败：**
```json
{
  "msg": "error",
  "error": "用户不存在"
}
```

### 业务规则

1. **权限验证**：只能标记当前用户作为接收者的消息为已读。
2. **批量标记**：标记该聊天会话中所有来自 `target_user_id` 且接收者为 `user_id` 的未读消息为已读。
3. **自动调用时机**：
   - 用户进入聊天详情页面时自动调用
   - 用户每次显示聊天详情页面时自动调用（`onShow` 生命周期）
4. **未读消息数更新**：标记成功后，消息列表页面的 `unread_count` 应该自动更新为 0。

### SQL更新示例

```sql
-- 标记用户123接收到的来自用户456的所有未读消息为已读
UPDATE chat_messages 
SET is_read = true 
WHERE receiver_id = 123 
  AND sender_id = 456 
  AND is_read = false;
```

---

## 4. 获取未读消息总数

### 接口地址
`GET /chat/unreadCount`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | Integer | 是 | 当前用户ID |

### 请求示例

```
GET /chat/unreadCount?user_id=123
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态："success" 或错误信息 |
| data | Object | 响应数据 |
| data.unread_count | Integer | 未读消息总数 |

### 响应示例

**成功：**
```json
{
  "msg": "success",
  "data": {
    "unread_count": 4
  }
}
```

**失败：**
```json
{
  "msg": "error",
  "error": "用户不存在"
}
```

### 业务规则

1. **统计范围**：统计当前用户作为接收者的所有未读消息总数（跨所有聊天会话）。
2. **实时性**：该接口用于在首页和消息列表页面显示 tabBar 角标，应实时反映最新的未读消息数。
3. **调用时机**：
   - 首页加载时（`onLoad`）
   - 首页显示时（`onShow`）
   - 消息列表页面显示时（`onShow`）
   - 聊天详情页面标记消息为已读后
4. **角标显示规则**：
   - 未读消息数 > 0 时，在 tabBar 的"消息"图标上显示角标
   - 未读消息数 > 99 时，角标显示 "99+"
   - 未读消息数 = 0 时，清除角标

### SQL查询示例

```sql
-- 统计用户123的所有未读消息总数
SELECT COUNT(*) AS unread_count
FROM chat_messages
WHERE receiver_id = 123
  AND is_read = false;
```

---

## 5. 获取聊天列表

### 接口地址
`GET /chat/list`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | Integer | 是 | 当前用户ID |

### 请求示例

```
GET /chat/list?user_id=123
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态："success" 或错误信息 |
| data | Object | 响应数据 |
| data.list | Array | 聊天列表 |
| data.list[].chat_id | Integer | 聊天会话ID |
| data.list[].user | Object | 当前用户信息（可选） |
| data.list[].target_user | Object | 聊天对象用户信息 |
| data.list[].target_user.user_id | Integer | 用户ID |
| data.list[].target_user.nickname | String | 用户昵称 |
| data.list[].target_user.avatar | String | 用户头像URL |
| data.list[].last_message | String | 最后一条消息内容 |
| data.list[].last_message_time | String | 最后一条消息时间（ISO 8601格式） |
| data.list[].unread_count | Integer | 未读消息数 |
| data.list[].goods_id | Integer | 关联的商品ID（可选） |

### 响应示例

**成功：**
```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "chat_id": 501,
        "target_user": {
          "user_id": 456,
          "nickname": "商家A",
          "avatar": "https://example.com/avatar1.jpg"
        },
        "last_message": "好的，我明天发货",
        "last_message_time": "2024-01-15T14:30:00Z",
        "unread_count": 2,
        "goods_id": 789
      },
      {
        "chat_id": 502,
        "target_user": {
          "user_id": 789,
          "nickname": "用户B",
          "avatar": "https://example.com/avatar2.jpg"
        },
        "last_message": "谢谢！",
        "last_message_time": "2024-01-14T16:20:00Z",
        "unread_count": 0,
        "goods_id": null
      }
    ]
  }
}
```

**失败：**
```json
{
  "msg": "error",
  "error": "用户不存在"
}
```

### 业务规则

1. **排序规则**：按 `last_message_time` 降序排列（最新的在前）。
2. **未读消息数**：统计当前用户作为接收者的未读消息数。
3. **聊天对象确定**：返回的 `target_user` 应该是聊天对象（不是当前用户）。

---

## 6. 获取用户信息（用于聊天）

### 接口地址
`GET /user/info`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | Integer | 是 | 用户ID |

### 请求示例

```
GET /user/info?user_id=456
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态："success" 或错误信息 |
| data | Object | 用户信息 |
| data.user_id | Integer | 用户ID |
| data.nickname | String | 用户昵称 |
| data.avatar | String | 用户头像URL（完整HTTP/HTTPS URL） |

### 响应示例

**成功：**
```json
{
  "msg": "success",
  "data": {
    "user_id": 456,
    "nickname": "商家A",
    "avatar": "https://example.com/avatar1.jpg"
  }
}
```

**失败：**
```json
{
  "msg": "error",
  "error": "用户不存在"
}
```

---

## 数据库设计建议

### 聊天会话表（chat_sessions）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| chat_id | Integer | 主键，聊天会话ID |
| user1_id | Integer | 用户1的ID（较小的user_id） |
| user2_id | Integer | 用户2的ID（较大的user_id） |
| goods_id | Integer | 关联的商品ID（可选） |
| last_message_id | Integer | 最后一条消息ID |
| last_message_time | DateTime | 最后一条消息时间 |
| create_time | DateTime | 创建时间 |
| update_time | DateTime | 更新时间 |

**索引建议：**
- `(user1_id, user2_id)` 唯一索引
- `last_message_time` 索引（用于排序）

### 消息表（chat_messages）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| message_id | Integer | 主键，消息ID |
| chat_id | Integer | 聊天会话ID（外键） |
| sender_id | Integer | 发送者用户ID |
| receiver_id | Integer | 接收者用户ID |
| content | Text | 消息内容 |
| is_read | Boolean | 是否已读（默认false） |
| create_time | DateTime | 创建时间 |

**索引建议：**
- `chat_id` 索引
- `(sender_id, receiver_id)` 索引
- `create_time` 索引（用于排序）
- `is_read` 索引（用于统计未读数）

---

## 前端实现说明

### 1. 商品详情页面跳转

在商品详情页面点击"聊一聊"按钮时：

```javascript
onChatClick() {
  const user_id = wx.getStorageSync('user_id');
  const sellerId = this.data.seller?.user_id;
  
  // 检查商家不能和自己聊天
  if (sellerId == user_id) {
    wx.showToast({ title: '不能和自己聊天', icon: 'none' });
    return;
  }
  
  // 跳转到聊天页面
  wx.navigateTo({
    url: `/pages/chat/chat?target_user_id=${sellerId}&goods_id=${goodsId}`
  });
}
```

### 2. 聊天页面功能

- **加载聊天记录**：调用 `GET /chat/messages` 获取历史消息
- **发送消息**：调用 `POST /chat/send` 发送新消息
- **标记消息为已读**：进入页面时自动调用 `POST /chat/markRead` 标记消息为已读
- **自动刷新**：页面显示时自动刷新最新消息并标记为已读

### 3. 消息列表页面功能

- **加载聊天列表**：调用 `GET /chat/list` 获取所有聊天会话
- **点击跳转**：点击聊天项跳转到对应的聊天详情页面
- **未读消息显示**：显示每个聊天会话的未读消息数（`unread_count > 0` 时显示红色角标）
- **自动刷新**：从聊天详情页面返回时自动刷新列表，未读消息数会更新为 0
- **更新tabBar角标**：页面显示时调用 `GET /chat/unreadCount` 更新 tabBar 角标

### 4. TabBar角标功能

- **显示未读消息数**：在首页 tabBar 的"消息"图标上显示未读消息数角标
- **更新时机**：
  - 首页加载和显示时
  - 消息列表页面显示时
  - 聊天详情页面标记已读后
- **角标样式**：
  - 未读消息数 > 0 时显示橙色圆形角标
  - 未读消息数 > 99 时显示 "99+"
  - 未读消息数 = 0 时清除角标

---

## 注意事项

1. **商家不能和自己聊天**：前端和后端都应该进行验证。
2. **消息内容安全**：后端应对消息内容进行敏感词过滤和长度验证。
3. **未读消息统计**：在获取聊天列表时，应准确统计未读消息数。
4. **标记已读时机**：用户进入聊天详情页面时，应自动标记该会话的所有未读消息为已读。
5. **未读消息数更新**：标记已读后，消息列表的 `unread_count` 应该立即更新为 0，tabBar 角标也应该同步更新。
6. **TabBar角标**：首页和消息列表页面应实时显示未读消息总数，通过 `GET /chat/unreadCount` 接口获取。
7. **时间格式**：所有时间字段使用 ISO 8601 格式（如：`2024-01-15T10:30:00Z`）。
8. **头像URL**：用户头像应返回完整的HTTP/HTTPS URL，避免返回示例URL或相对路径。
9. **分页加载**：聊天记录支持分页加载，方便加载历史消息。

---

## 更新日志

- 2024-01-15：初始版本，包含发送消息、获取聊天记录、获取聊天列表等接口。
- 2024-01-15：新增标记消息为已读接口，实现进入聊天详情页面时自动标记未读消息为已读。
- 2024-01-15：新增获取未读消息总数接口，实现在首页 tabBar 的"消息"图标上显示未读消息数角标。




