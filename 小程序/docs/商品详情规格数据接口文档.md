# 商品详情规格数据接口文档

## 1. 商品详情接口规格数据格式说明

### 1.1 接口信息

- **接口路径**: `/goods/detail`
- **请求方法**: `GET`
- **接口描述**: 获取商品详情信息，包括商品规格数据

### 1.2 请求参数

#### Query 参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| goods_id | string/number | 是 | 商品ID |

#### 请求示例
```
GET /goods/detail?goods_id=456
```

### 1.3 响应参数

#### 成功响应

**状态码**: `200`

**响应体（JSON）**

```json
{
  "msg": "success",
  "data": {
    "goods": {
      "goods_id": "456",
      "description": "商品描述",
      "price": 99.99,
      "stock": 100,
      "spec_enabled": true,
      "specs": [
        {
          "spec_id": "101",
          "name": "规格名称1",
          "price": 99.99,
          "stock": 50
        },
        {
          "spec_id": "102",
          "name": "规格名称2",
          "price": 129.99,
          "stock": 30
        }
      ],
      "group_buy_enabled": true,
      "group_buy_discount": 0.8,
      "group_buy_count": 2,
      "images": ["https://example.com/image1.jpg"]
    },
    "seller": {
      "user_id": "789",
      "nickname": "卖家昵称",
      "avatar": "https://example.com/avatar.jpg"
    }
  }
}
```

### 1.4 规格数据字段说明

#### goods 对象中的规格相关字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| spec_enabled | boolean | 是 | 是否开启规格功能。`true` 表示商品有规格，`false` 表示商品无规格 |
| specs | array | 否 | 规格列表。当 `spec_enabled` 为 `true` 时，此字段必填且不能为空数组；当 `spec_enabled` 为 `false` 时，此字段应为 `null` 或空数组 `[]` |

#### specs 数组中每个规格对象的字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| spec_id | string/number | 是 | 规格ID，用于唯一标识该规格。**重要**：如果后端没有为规格生成ID，可以使用索引值（如 `"spec_0"`, `"spec_1"`）或数据库自增ID |
| name | string | 是 | 规格名称，如 "红色", "大号", "500ml" 等 |
| price | number | 是 | 该规格的价格（保留2位小数） |
| stock | number | 是 | 该规格的库存数量（整数，>= 0） |

### 1.5 规格数据格式要求

#### 1.5.1 spec_enabled 字段

- **类型要求**: 必须是布尔值 `true` 或 `false`
- **兼容性**: 如果后端返回的是数字（`1` 表示开启，`0` 表示关闭）或字符串（`"1"` 表示开启，`"0"` 表示关闭），前端会自动转换
- **业务逻辑**: 
  - `spec_enabled = true`: 商品有规格，用户购买时必须选择规格
  - `spec_enabled = false`: 商品无规格，用户购买时使用商品的基础价格

#### 1.5.2 specs 数组

- **当 `spec_enabled = true` 时**:
  - `specs` 必须是一个非空数组
  - 数组长度至少为 1
  - 每个元素必须包含 `spec_id`, `name`, `price`, `stock` 字段

- **当 `spec_enabled = false` 时**:
  - `specs` 应为 `null` 或空数组 `[]`
  - 前端不会显示规格选择界面

#### 1.5.3 spec_id 字段

- **唯一性**: 每个规格的 `spec_id` 必须在同一商品内唯一
- **生成方式**: 
  - 推荐：使用数据库自增ID或UUID
  - 备选：如果后端没有生成ID，可以使用格式 `"spec_{index}"`（如 `"spec_0"`, `"spec_1"`）
- **用途**: 用于创建订单时标识用户选择的规格

### 1.6 数据示例

#### 示例1：有规格的商品

```json
{
  "goods_id": "456",
  "description": "苹果手机",
  "price": 5999.00,
  "stock": 0,
  "spec_enabled": true,
  "specs": [
    {
      "spec_id": "101",
      "name": "128GB 黑色",
      "price": 5999.00,
      "stock": 10
    },
    {
      "spec_id": "102",
      "name": "256GB 黑色",
      "price": 6999.00,
      "stock": 5
    },
    {
      "spec_id": "103",
      "name": "128GB 白色",
      "price": 5999.00,
      "stock": 8
    }
  ]
}
```

#### 示例2：无规格的商品

```json
{
  "goods_id": "789",
  "description": "普通商品",
  "price": 99.99,
  "stock": 100,
  "spec_enabled": false,
  "specs": null
}
```

或者：

```json
{
  "goods_id": "789",
  "description": "普通商品",
  "price": 99.99,
  "stock": 100,
  "spec_enabled": false,
  "specs": []
}
```

### 1.7 前端处理逻辑

前端在接收到商品详情数据后，会进行以下处理：

1. **验证 `spec_enabled` 字段**:
   - 如果是数字 `1` 或字符串 `"1"`，转换为 `true`
   - 如果是数字 `0` 或字符串 `"0"`，转换为 `false`
   - 如果已经是布尔值，直接使用

2. **验证 `specs` 数组**:
   - 如果 `spec_enabled = true` 但 `specs` 为空或不存在，前端会将 `spec_enabled` 设置为 `false`
   - 确保 `specs` 是数组类型

3. **补充规格字段**:
   - 如果某个规格缺少 `spec_id`，前端会使用索引生成临时ID（格式：`spec_{index}`）
   - 确保每个规格都有 `name`, `price`, `stock` 字段

4. **数据类型转换**:
   - `price` 字段转换为数字类型（`parseFloat`）
   - `stock` 字段转换为整数类型（`parseInt`）

### 1.8 错误处理

#### 常见错误情况

1. **`spec_enabled = true` 但 `specs` 为空**:
   - 前端会自动将 `spec_enabled` 设置为 `false`
   - 商品将按无规格商品处理

2. **规格数据缺少必要字段**:
   - 缺少 `name`: 使用默认值 `"规格{index+1}"`
   - 缺少 `price`: 使用默认值 `0`
   - 缺少 `stock`: 使用默认值 `0`
   - 缺少 `spec_id`: 使用临时ID `"spec_{index}"`

3. **规格数据格式错误**:
   - `specs` 不是数组: 前端会将其转换为空数组，并将 `spec_enabled` 设置为 `false`

### 1.9 后端实现建议

#### 数据库设计建议

如果使用关系型数据库，建议的表结构：

```sql
-- 商品表
CREATE TABLE goods (
  goods_id INT PRIMARY KEY AUTO_INCREMENT,
  description VARCHAR(500),
  price DECIMAL(10, 2),
  stock INT,
  spec_enabled BOOLEAN DEFAULT FALSE,
  ...
);

-- 规格表
CREATE TABLE goods_specs (
  spec_id INT PRIMARY KEY AUTO_INCREMENT,
  goods_id INT NOT NULL,
  name VARCHAR(100) NOT NULL,
  price DECIMAL(10, 2) NOT NULL,
  stock INT NOT NULL DEFAULT 0,
  FOREIGN KEY (goods_id) REFERENCES goods(goods_id)
);
```

#### 接口返回数据构建

```python
# Python 示例
def get_goods_detail(goods_id):
    goods = get_goods_by_id(goods_id)
    specs = get_specs_by_goods_id(goods_id) if goods.spec_enabled else []
    
    return {
        "msg": "success",
        "data": {
            "goods": {
                "goods_id": goods.goods_id,
                "description": goods.description,
                "price": float(goods.price),
                "stock": goods.stock,
                "spec_enabled": bool(goods.spec_enabled),
                "specs": [
                    {
                        "spec_id": spec.spec_id,
                        "name": spec.name,
                        "price": float(spec.price),
                        "stock": spec.stock
                    }
                    for spec in specs
                ] if goods.spec_enabled else None,
                ...
            },
            ...
        }
    }
```

### 1.10 测试用例

#### 测试用例1：有规格的商品

**请求**:
```
GET /goods/detail?goods_id=456
```

**期望响应**:
```json
{
  "msg": "success",
  "data": {
    "goods": {
      "goods_id": "456",
      "spec_enabled": true,
      "specs": [
        {
          "spec_id": "101",
          "name": "红色",
          "price": 99.99,
          "stock": 10
        }
      ]
    }
  }
}
```

#### 测试用例2：无规格的商品

**请求**:
```
GET /goods/detail?goods_id=789
```

**期望响应**:
```json
{
  "msg": "success",
  "data": {
    "goods": {
      "goods_id": "789",
      "spec_enabled": false,
      "specs": null
    }
  }
}
```

### 1.11 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2024-01-29 | 1.0.0 | 初始版本，商品详情规格数据格式说明 |

---

## 2. 相关接口

### 2.1 发布商品接口（参考）

发布商品时，规格数据的格式应与商品详情接口返回的格式一致。

**发布商品时的规格数据格式**:
```json
{
  "specEnabled": true,
  "specs": [
    {
      "name": "规格名称",
      "price": 99.99,
      "stock": 10
    }
  ]
}
```

**注意**: 发布商品时不需要 `spec_id`，`spec_id` 由后端在保存时自动生成。

---

## 3. 联系方式

如有问题，请联系前端开发团队。


