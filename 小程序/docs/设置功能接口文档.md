# 设置功能接口文档

## 概述

本文档描述了小程序设置功能相关的接口规范，包括修改密码、地址管理、清除缓存、关于我们和隐私政策等功能。

---

## 1. 修改密码接口

### 接口信息

**接口地址：** `POST /user/changePassword`

**请求方法：** `POST`

**Content-Type：** `application/json`

---

### 请求参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | String/Number | 是 | 用户ID |
| old_password | String | 是 | 原密码 |
| new_password | String | 是 | 新密码（6-20个字符） |

### 请求示例

```json
{
  "user_id": "123",
  "old_password": "oldPassword123",
  "new_password": "newPassword456"
}
```

---

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "message": "密码修改成功"
  }
}
```

#### 错误响应

**原密码错误：**
```json
{
  "msg": "error",
  "error": "原密码错误"
}
```

**新密码格式不正确：**
```json
{
  "msg": "error",
  "error": "新密码长度应在6-20个字符之间"
}
```

**新密码与原密码相同：**
```json
{
  "msg": "error",
  "error": "新密码不能与原密码相同"
}
```

**用户不存在：**
```json
{
  "msg": "error",
  "error": "用户不存在"
}
```

---

### 字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态，"success" 表示成功，"error" 表示失败 |
| error | String | 错误信息（仅在失败时返回） |
| data | Object | 响应数据（仅在成功时返回） |

---

### 业务规则

1. **密码验证规则：**
   - 新密码长度必须在 6-20 个字符之间
   - 新密码不能与原密码相同
   - 原密码必须正确

2. **安全性要求：**
   - 原密码和新密码在传输过程中应进行加密处理
   - 后端应对新密码进行哈希加密存储
   - 建议记录密码修改操作日志

3. **错误处理：**
   - 如果原密码错误，返回 "原密码错误"
   - 如果新密码格式不正确，返回相应的错误提示
   - 如果新密码与原密码相同，返回 "新密码不能与原密码相同"
   - 如果用户不存在，返回 "用户不存在"

---

## 2. 关于我们接口

### 接口信息

**接口地址：** `GET /app/about`

**请求方法：** `GET`

**Content-Type：** `application/json`

---

### 请求参数

无需请求参数（或可选的查询参数）

### 请求示例

```javascript
// 前端调用
GET /app/about
```

---

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "app_name": "拼单商城",
    "app_version": "1.0.0",
    "content": "拼单商城是一个便捷的二手商品交易平台，致力于为用户提供安全、便捷的购物体验。我们专注于打造一个诚信、高效的交易环境，让闲置物品得到充分利用，让用户享受更优惠的购物体验。",
    "contact_info": {
      "email": "support@example.com",
      "phone": "400-123-4567",
      "address": "中国广东省深圳市南山区科技园"
    },
    "copyright_year": 2024
  }
}
```

#### 错误响应

```json
{
  "msg": "error",
  "error": "获取信息失败"
}
```

---

### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| msg | String | 是 | 响应状态，"success" 表示成功，"error" 表示失败 |
| data | Object | 否 | 响应数据（仅在成功时返回） |
| data.app_name | String | 否 | 应用名称 |
| data.app_version | String | 否 | 应用版本号 |
| data.content | String | 是 | 关于我们的内容（支持换行，使用 \n 或 HTML 标签） |
| data.contact_info | Object | 否 | 联系方式信息 |
| data.contact_info.email | String | 否 | 邮箱地址 |
| data.contact_info.phone | String | 否 | 联系电话 |
| data.contact_info.address | String | 否 | 联系地址 |
| data.copyright_year | Number | 否 | 版权年份 |
| error | String | 否 | 错误信息（仅在失败时返回） |

---

### 业务规则

1. **内容格式：**
   - `content` 字段支持换行符 `\n` 或 HTML 标签
   - 前端会使用 `white-space: pre-wrap` 显示，保留换行格式

2. **可选字段：**
   - 如果某些字段未提供，前端会使用默认值
   - `contact_info` 为可选，如果不存在则不显示联系方式部分

3. **缓存策略：**
   - 建议后端对关于我们内容进行缓存
   - 内容更新频率较低，可设置较长的缓存时间

---

## 3. 隐私政策接口

### 接口信息

**接口地址：** `GET /app/privacy`

**请求方法：** `GET`

**Content-Type：** `application/json`

---

### 请求参数

无需请求参数（或可选的查询参数）

### 请求示例

```javascript
// 前端调用
GET /app/privacy
```

---

### 响应格式

#### 成功响应

```json
{
  "msg": "success",
  "data": {
    "title": "隐私政策",
    "publish_date": "2024-01-01",
    "effective_date": "2024-01-01",
    "content": "我们非常重视您的隐私保护。在使用我们的服务时，我们会按照相关法律法规的要求，保护您的个人信息安全。\n\n一、信息收集\n我们可能收集以下信息：\n1. 账号信息：包括用户名、密码等\n2. 交易信息：包括订单信息、支付信息等\n\n二、信息使用\n我们使用收集的信息用于：\n1. 提供、维护和改进我们的服务\n2. 处理您的交易请求\n3. 发送重要通知和更新",
    "contact_info": {
      "email": "privacy@example.com",
      "phone": "400-123-4567",
      "address": "中国广东省深圳市南山区科技园"
    }
  }
}
```

#### 错误响应

```json
{
  "msg": "error",
  "error": "获取隐私政策失败"
}
```

---

### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| msg | String | 是 | 响应状态，"success" 表示成功，"error" 表示失败 |
| data | Object | 否 | 响应数据（仅在成功时返回） |
| data.title | String | 否 | 隐私政策标题，默认为"隐私政策" |
| data.publish_date | String | 否 | 发布日期，格式：YYYY-MM-DD |
| data.effective_date | String | 否 | 生效日期，格式：YYYY-MM-DD |
| data.content | String | 是 | 隐私政策内容（支持换行，使用 \n） |
| data.contact_info | Object | 否 | 联系方式信息 |
| data.contact_info.email | String | 否 | 邮箱地址 |
| data.contact_info.phone | String | 否 | 联系电话 |
| data.contact_info.address | String | 否 | 联系地址 |
| error | String | 否 | 错误信息（仅在失败时返回） |

---

### 业务规则

1. **内容格式：**
   - `content` 字段支持换行符 `\n`，前端会保留换行格式显示
   - 建议内容结构清晰，使用标题、段落等格式

2. **日期格式：**
   - `publish_date` 和 `effective_date` 使用 `YYYY-MM-DD` 格式
   - 如果未提供日期，前端不显示日期信息

3. **法律要求：**
   - 隐私政策内容应符合相关法律法规要求
   - 建议定期更新隐私政策内容
   - 重要更新时应通知用户

4. **缓存策略：**
   - 建议后端对隐私政策内容进行缓存
   - 内容更新频率较低，可设置较长的缓存时间

---

## 4. 地址管理接口

地址管理功能使用现有的地址相关接口，无需新增接口。相关接口如下：

### 4.1 获取地址列表

**接口地址：** `GET /address/list?user_id={user_id}`

**请求方法：** `GET`

**请求参数：**
- `user_id` (Query参数，必填): 用户ID

**响应格式：**
```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "address_id": 1,
        "contact_name": "张三",
        "phone": "13800138000",
        "region": "广东省深圳市南山区",
        "province": "广东省",
        "city": "深圳市",
        "district": "南山区",
        "street": "科技园",
        "detail_address": "科技园南区",
        "is_default": true
      }
    ]
  }
}
```

### 4.2 添加地址

**接口地址：** `POST /address/add`

**请求方法：** `POST`

**请求参数：**
```json
{
  "user_id": "123",
  "contact_name": "张三",
  "phone": "13800138000",
  "province": "广东省",
  "city": "深圳市",
  "district": "南山区",
  "street": "科技园",
  "detail_address": "科技园南区",
  "is_default": false
}
```

### 4.3 更新地址

**接口地址：** `POST /address/update`

**请求方法：** `POST`

**请求参数：**
```json
{
  "address_id": 1,
  "user_id": "123",
  "contact_name": "张三",
  "phone": "13800138000",
  "province": "广东省",
  "city": "深圳市",
  "district": "南山区",
  "street": "科技园",
  "detail_address": "科技园南区",
  "is_default": true
}
```

### 4.4 删除地址

**接口地址：** `POST /address/delete`

**请求方法：** `POST`

**请求参数：**
```json
{
  "address_id": 1,
  "user_id": "123"
}
```

### 4.5 获取地址详情

**接口地址：** `GET /address/detail?address_id={address_id}&user_id={user_id}`

**请求方法：** `GET`

**请求参数：**
- `address_id` (Query参数，必填): 地址ID
- `user_id` (Query参数，必填): 用户ID

---

## 5. 清除缓存

清除缓存功能为前端本地操作，**无需调用后端接口**。

### 功能说明

前端会清除所有本地存储数据，包括：
- `user_id`
- `userInfo`
- `wxlogin`
- 所有其他本地存储数据

### 操作流程

1. 用户点击"清除缓存"
2. 前端显示确认对话框
3. 用户确认后，调用 `wx.clearStorageSync()` 清除所有本地存储
4. 清除成功后，跳转到登录页面

### 注意事项

- 清除缓存后，用户需要重新登录
- 清除缓存会删除所有本地数据，包括用户信息、设置等
- 建议在清除前提示用户此操作不可恢复

---

## 6. 退出登录

退出登录功能为前端本地操作，**无需调用后端接口**。

### 功能说明

前端会清除登录相关的本地存储：
- `user_id`
- `userInfo`
- `wxlogin`

**注意：** 不清除 `userinfo_{user_id}`，以便下次登录该账号时可以恢复微信授权信息。

---

## 接口调用示例

### 前端调用修改密码接口（微信小程序）

```javascript
import { ajax } from '../../utils/index'

// 修改密码
async function changePassword(userId, oldPassword, newPassword) {
  try {
    const result = await ajax('/user/changePassword', 'POST', {
      user_id: userId,
      old_password: oldPassword,
      new_password: newPassword
    });
    
    if (result?.msg === 'success') {
      console.log('密码修改成功');
      return true;
    } else {
      console.error('密码修改失败:', result?.error);
      return false;
    }
  } catch (error) {
    console.error('网络请求失败:', error);
    return false;
  }
}
```

### 前端调用关于我们接口

```javascript
import { ajax } from '../../utils/index'

// 获取关于我们信息
async function getAboutInfo() {
  try {
    const result = await ajax('/app/about', 'GET', {});
    
    if (result?.msg === 'success') {
      const data = result.data || {};
      return {
        appName: data.app_name || '拼单商城',
        appVersion: data.app_version || '1.0.0',
        content: data.content || '',
        contactInfo: data.contact_info || null,
        copyrightYear: data.copyright_year || new Date().getFullYear()
      };
    } else {
      console.error('获取关于我们信息失败:', result?.error);
      return null;
    }
  } catch (error) {
    console.error('网络请求失败:', error);
    return null;
  }
}
```

### 前端调用隐私政策接口

```javascript
import { ajax } from '../../utils/index'

// 获取隐私政策内容
async function getPrivacyContent() {
  try {
    const result = await ajax('/app/privacy', 'GET', {});
    
    if (result?.msg === 'success') {
      const data = result.data || {};
      return {
        title: data.title || '隐私政策',
        publishDate: data.publish_date || '',
        effectiveDate: data.effective_date || '',
        content: data.content || '',
        contactInfo: data.contact_info || null
      };
    } else {
      console.error('获取隐私政策失败:', result?.error);
      return null;
    }
  } catch (error) {
    console.error('网络请求失败:', error);
    return null;
  }
}
```

---

## 错误码说明

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| 原密码错误 | 用户输入的原密码不正确 | 提示用户重新输入原密码 |
| 新密码长度应在6-20个字符之间 | 新密码长度不符合要求 | 提示用户输入符合长度要求的密码 |
| 新密码不能与原密码相同 | 新密码与原密码相同 | 提示用户输入不同的新密码 |
| 用户不存在 | 用户ID不存在 | 检查用户登录状态 |
| 获取信息失败 | 获取关于我们或隐私政策失败 | 使用默认内容或提示用户稍后重试 |
| 网络请求失败 | 网络连接问题 | 提示用户检查网络连接后重试 |

---

## 注意事项

1. **安全性：**
   - 所有密码相关操作应在 HTTPS 环境下进行
   - 后端应对密码进行哈希加密存储，不应存储明文密码
   - 建议对密码修改操作进行频率限制，防止暴力破解

2. **用户体验：**
   - 修改密码成功后，建议提示用户重新登录
   - 密码输入框应使用 `type="password"` 隐藏输入内容
   - 应提供密码强度提示
   - 关于我们和隐私政策页面支持下拉刷新

3. **数据验证：**
   - 前端应进行基础验证（长度、格式等）
   - 后端应进行完整验证和安全检查
   - 前后端验证规则应保持一致

4. **内容管理：**
   - 关于我们和隐私政策内容建议使用富文本编辑器管理
   - 内容更新后应及时通知用户
   - 建议对内容进行版本管理

5. **缓存策略：**
   - 关于我们和隐私政策内容更新频率较低，建议设置较长的缓存时间
   - 前端支持下拉刷新获取最新内容

---

## 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0.0 | 2024-XX-XX | 初始版本，添加修改密码接口文档 |
| 1.1.0 | 2024-XX-XX | 添加关于我们和隐私政策接口文档 |
| 1.2.0 | 2024-XX-XX | 添加清除缓存功能说明 |
