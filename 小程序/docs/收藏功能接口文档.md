## 一、功能概述

本接口用于支持以下前端需求：
- 商品详情页收藏图标在 `Collection.png` 与 `Collection_filled.png` 之间切换；
- 记录并返回某个商品的收藏总数；
- 用户在「我的收藏」页面看到自己已收藏的商品列表。

为此约定 3 个接口：
- `GET /favorite/getStatus`：获取某商品收藏总数及当前用户是否已收藏；
- `POST /favorite/toggle`：切换当前用户对某商品的收藏状态；
- `GET /favorite/list`：获取当前用户的收藏商品列表。

---

## 二、获取收藏状态与收藏数

### 1. 接口描述
- **URL**：`GET /favorite/getStatus`
- **说明**：
  - 返回指定 `goods_id` 的收藏总数；
  - 如果传入 `user_id`，同时返回该用户是否已收藏该商品。

### 2. 请求参数
- **Query 参数**
  - `goods_id` (number / string，必填)：商品 ID。
  - `user_id` (number / string，选填)：用户 ID。  
    - 前端在未登录情况下不传或传空，后端可视为“未登录用户”，此时只返回收藏总数 `count`，`is_favorited` 可固定为 `false` 或省略。

### 3. 返回参数
- **成功响应**
```json
{
  "msg": "success",
  "data": {
    "count": 12,
    "is_favorited": true
  }
}
```

- 字段说明
  - `count` (number)：该商品被收藏的总次数；
  - `is_favorited` (boolean)：当前 `user_id` 是否已收藏该商品（未登录或未传 `user_id` 时，可固定为 `false` 或不返回该字段）。

- **失败响应（示例）**
```json
{
  "msg": "error",
  "error": "goods not found"
}
```

### 4. 业务逻辑建议
1. 根据 `goods_id` 在收藏表中统计收藏数量：
   - 示例收藏表：`favorite(id, user_id, goods_id, created_at, deleted_at)`；
   - `count = 收藏表中 deleted_at IS NULL 且 goods_id = ? 的记录数量`。
2. 如果同时提供 `user_id`：
   - 查询是否存在 `user_id = ? AND goods_id = ? AND deleted_at IS NULL` 的记录；
   - 存在则 `is_favorited = true`，否则为 `false`。

---

## 三、切换收藏状态

### 1. 接口描述
- **URL**：`POST /favorite/toggle`
- **说明**：当前用户点击收藏图标时调用，后端根据当前状态决定“新增收藏”或“取消收藏”，并返回最新的收藏状态和收藏总数。

### 2. 请求参数
- **Body(JSON)**
```json
{
  "user_id": 123,
  "goods_id": 456
}
```

- 字段说明
  - `user_id` (number / string，必填)：当前登录用户 ID；
  - `goods_id` (number / string，必填)：商品 ID。

### 3. 返回参数
- **成功响应**
```json
{
  "msg": "success",
  "data": {
    "is_favorited": true,
    "count": 13
  }
}
```

- 字段说明
  - `is_favorited` (boolean)：操作完成后，当前用户是否为“已收藏”状态；
  - `count` (number)：操作完成后，最新的收藏总数。

- **失败响应（示例）**
```json
{
  "msg": "error",
  "error": "invalid user_id or goods_id"
}
```

### 4. 业务逻辑建议
1. 校验 `user_id`、`goods_id` 是否有效（存在且未被禁用 / 删除）。
2. 查询收藏表：
   - 若存在 `user_id = ? AND goods_id = ? AND deleted_at IS NULL`：
     - 表示当前为“已收藏”，本次操作应为“取消收藏”：
       - 可以选择**软删除**：更新 `deleted_at = NOW()`；
       - 或**物理删除**该记录；
       - 操作完成后 `is_favorited = false`。
   - 若不存在有效记录：
     - 新增一条收藏记录：`(user_id, goods_id, created_at = NOW(), deleted_at = NULL)`；
     - 操作完成后 `is_favorited = true`。
3. 再次统计该 `goods_id` 的收藏总数，返回 `count`。

---

## 四、获取“我的收藏”列表

### 1. 接口描述
- **URL**：`GET /favorite/list`
- **说明**：返回指定用户收藏的商品列表，用于「个人中心 - 我的收藏」页面。

### 2. 请求参数
- **Query 参数**
  - `user_id` (number / string，必填)：当前登录用户 ID；
  - `page` (number，选填，默认 1)：页码，从 1 开始；
  - `pageSize` (number，选填，默认 10)：每页条数。

### 3. 返回参数
- **成功响应**
```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "goods_id": 456,
        "description": "九成新 iPad 平板电脑",
        "price": 1999.00,
        "images": [
          "https://your-oss-domain.com/goods/456_1.jpg",
          "https://your-oss-domain.com/goods/456_2.jpg"
        ],
        "group_buy_enabled": true,
        "sales_count": 5,
        "seller": {
          "user_id": 123,
          "nickname": "小王",
          "name": "wang123"
        }
      }
    ],
    "total": 1
  }
}
```

- 字段说明
  - `list` (array)：当前页收藏的商品列表；
  - `total` (number)：该用户收藏商品的总数量，用于前端判断是否还有下一页。

- `list` 中每个 `商品对象` 字段建议与现有的商品列表接口保持一致（与 `/goodslist`、`/goods/myGoods` 返回结构相同），前端已按以下字段使用：
  - `goods_id`：商品 ID；
  - `description`：商品描述；
  - `price`：价格；
  - `images`：图片 URL 数组（可为空数组）；
  - `group_buy_enabled`：是否开启拼团（用于展示“拼团”角标）；
  - `sales_count`：销量（用于展示“已售 x”）；
  - `seller`：发布者信息对象，包含：
    - `user_id`：卖家 ID；
    - `nickname` / `name`：用于在列表中展示卖家昵称（优先用 `nickname`）。

### 4. 业务逻辑建议
1. 先从收藏表中过滤出当前用户有效的收藏记录：
   - `SELECT goods_id FROM favorite WHERE user_id = ? AND deleted_at IS NULL LIMIT ?, ?`
2. 再根据这些 `goods_id` 去商品表中查询商品详情，并按需要 `JOIN` 卖家信息表，组装为前端需要的结构。
3. 需同时返回 `total`：
   - `SELECT COUNT(*) FROM favorite WHERE user_id = ? AND deleted_at IS NULL`

---

## 五、与前端交互约定（实现说明）

### 1. 商品详情页
- 前端会在商品详情页：
  - 进入页面后调用：`GET /favorite/getStatus?goods_id=xxx&user_id=yyy`；
    - 用于设置：
      - `favoriteCount = data.count`
      - `isFavorited = data.is_favorited`
  - 用户点击收藏图标时调用：`POST /favorite/toggle`；
    - 根据返回：
      - `isFavorited = data.is_favorited`
      - `favoriteCount = data.count`

- 图标切换规则：
  - 未收藏：`/assets/Collection.png`
  - 已收藏：`/assets/Collection_filled.png`

### 2. 我的收藏页面
- 「个人中心 - 我的收藏」页面会调用：
  - `GET /favorite/list?user_id=xxx&page=1&pageSize=10`
  - 翻页时增加 `page`；
  - 根据返回的 `list` 渲染商品卡片，点击某项后跳转到：`/pages/goodsdetail/goodsdetail?goods_id=...`。








