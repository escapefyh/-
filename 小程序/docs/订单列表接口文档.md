# 订单列表接口文档

## 1. 获取订单列表接口

### 1.1 接口信息

- **接口路径**: `/order/list`
- **请求方法**: `GET`
- **接口描述**: 获取用户的订单列表，支持按订单状态筛选和分页

### 1.2 请求参数

#### Query 参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | string/number | 是 | 用户ID |
| status | string | 否 | 订单状态筛选（空字符串表示全部订单）<br>可选值：`pending`（待付款）、`paid`（待发货）、`shipped`（待收货）、`completed`（已完成）、`cancelled`（已取消）<br>如果为空字符串或不传，返回全部状态的订单 |
| page | number | 否 | 页码，从1开始，默认1 |
| pageSize | number | 否 | 每页数量，默认10 |

#### 请求示例

**获取全部订单（第一页）**
```
GET /order/list?user_id=123&page=1&pageSize=10
```

**获取待付款订单**
```
GET /order/list?user_id=123&status=pending&page=1&pageSize=10
```

**获取待收货订单**
```
GET /order/list?user_id=123&status=shipped&page=1&pageSize=10
```

### 1.3 响应参数

#### 成功响应

**状态码**: `200`

**响应体（JSON）**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | string | 响应消息，成功时为 "success" |
| data | object | 订单数据 |
| data.list | array | 订单列表 |
| data.list[].order_id | string/number | 订单ID |
| data.list[].order_no | string | 订单编号（唯一标识，用于显示给用户） |
| data.list[].user_id | string/number | 用户ID（购买者） |
| data.list[].goods_id | string/number | 商品ID |
| data.list[].goods_description | string | 商品描述（用于订单列表显示） |
| data.list[].goods_image | string/array | 商品图片（字符串或数组，如果是数组取第一个） |
| data.list[].spec_id | string/number | 规格ID（如果订单有规格） |
| data.list[].spec_name | string | 规格名称（如果订单有规格） |
| data.list[].quantity | number | 购买数量 |
| data.list[].total_price | number | 订单总价 |
| data.list[].status | string | 订单状态：`pending`（待付款）、`paid`（待发货）、`shipped`（待收货）、`completed`（已完成）、`cancelled`（已取消） |
| data.list[].is_group_buy | boolean | 是否为拼团订单 |
| data.list[].address_id | string/number | 收货地址ID |
| data.list[].create_time | string | 订单创建时间（ISO 8601格式，如：`2024-01-29T12:34:56.789Z`） |
| data.list[].update_time | string | 订单更新时间（ISO 8601格式） |
| data.total | number | 订单总数（用于分页） |

**响应示例**

```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "order_id": "1001",
        "order_no": "ORD20240129123456789",
        "user_id": "123",
        "goods_id": "456",
        "goods_description": "商品描述信息",
        "goods_image": "https://example.com/image1.jpg",
        "spec_id": "101",
        "spec_name": "红色",
        "quantity": 2,
        "total_price": 199.98,
        "status": "pending",
        "is_group_buy": false,
        "address_id": "789",
        "create_time": "2024-01-29T12:34:56.789Z",
        "update_time": "2024-01-29T12:34:56.789Z"
      },
      {
        "order_id": "1002",
        "order_no": "ORD20240129123456790",
        "user_id": "123",
        "goods_id": "457",
        "goods_description": "另一个商品",
        "goods_image": ["https://example.com/image2.jpg"],
        "spec_id": null,
        "spec_name": null,
        "quantity": 1,
        "total_price": 99.99,
        "status": "shipped",
        "is_group_buy": true,
        "address_id": "789",
        "create_time": "2024-01-28T10:20:30.456Z",
        "update_time": "2024-01-29T08:15:20.123Z"
      }
    ],
    "total": 25
  }
}
```

#### 错误响应

**状态码**: `400` 或 `500`

**响应体（JSON）**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | string | 响应消息，失败时为 "error" |
| error | string | 错误描述信息 |

**错误响应示例**

```json
{
  "msg": "error",
  "error": "用户不存在"
}
```

### 1.4 错误码说明

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 400 | 参数错误 | 请求参数缺失或格式不正确 |
| 400 | 用户不存在 | user_id 对应的用户不存在 |
| 401 | 未登录 | user_id 为空或用户未登录 |
| 500 | 服务器错误 | 服务器内部错误 |

### 1.5 业务逻辑说明

1. **状态筛选**
   - 如果 `status` 为空字符串或不传，返回该用户的所有订单
   - 如果 `status` 有值，只返回对应状态的订单
   - 订单状态必须严格匹配，不支持模糊查询

2. **分页逻辑**
   - 使用 `page` 和 `pageSize` 进行分页
   - 返回的数据按创建时间倒序排列（最新的在前）
   - `total` 字段表示符合条件的订单总数，用于前端计算总页数

3. **数据完整性**
   - 订单列表应包含足够的信息供前端展示
   - `goods_description` 和 `goods_image` 应从商品表关联获取，确保即使商品被删除也能显示历史订单信息
   - 建议在订单创建时保存商品快照信息，避免商品信息变更影响历史订单显示

4. **性能优化**
   - 建议对 `user_id` 和 `status` 字段建立索引
   - 对于大量订单的用户，建议使用分页加载，避免一次性返回过多数据

---

## 2. 取消订单接口

### 2.1 接口信息

- **接口路径**: `/order/cancel`
- **请求方法**: `POST`
- **接口描述**: 用户取消订单（仅支持待付款和待发货状态的订单）

### 2.2 请求参数

#### 请求头
```
Content-Type: application/json
```

#### 请求体（JSON）

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | string/number | 是 | 用户ID（订单所有者） |
| order_id | string/number | 是 | 订单ID |

#### 请求示例

```json
{
  "user_id": "123",
  "order_id": "1001"
}
```

### 2.3 响应参数

#### 成功响应

**状态码**: `200`

**响应体（JSON）**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | string | 响应消息，成功时为 "success" |
| data | object | 订单数据（可选） |
| data.order_id | string/number | 订单ID |
| data.status | string | 订单状态（应为 "cancelled"） |

**响应示例**

```json
{
  "msg": "success",
  "data": {
    "order_id": "1001",
    "status": "cancelled"
  }
}
```

#### 错误响应

**状态码**: `400` 或 `500`

**响应体（JSON）**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | string | 响应消息，失败时为 "error" |
| error | string | 错误描述信息 |

**错误响应示例**

```json
{
  "msg": "error",
  "error": "订单不存在或不属于当前用户"
}
```

### 2.4 错误码说明

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 400 | 参数错误 | 请求参数缺失或格式不正确 |
| 400 | 订单不存在 | order_id 对应的订单不存在 |
| 400 | 订单不属于当前用户 | 订单的 user_id 与请求的 user_id 不匹配 |
| 400 | 订单状态不允许取消 | 订单状态不是 `pending` 或 `paid` |
| 400 | 订单已发货 | 订单已发货，无法取消 |
| 500 | 服务器错误 | 服务器内部错误 |

### 2.5 业务逻辑说明

1. **权限验证**
   - 必须验证订单的 `user_id` 与请求的 `user_id` 一致
   - 防止用户取消他人的订单

2. **状态限制**
   - 只有 `pending`（待付款）和 `paid`（待发货）状态的订单可以取消
   - `shipped`（待收货）、`completed`（已完成）、`cancelled`（已取消）状态的订单不能取消

3. **库存恢复**
   - 取消订单后，应恢复商品或规格的库存
   - 如果是拼团订单，可能需要处理拼团组的逻辑

4. **订单状态更新**
   - 取消订单后，订单状态应更新为 `cancelled`
   - 更新 `update_time` 字段

---

## 3. 确认收货接口

### 3.1 接口信息

- **接口路径**: `/order/confirm`
- **请求方法**: `POST`
- **接口描述**: 用户确认收货（仅支持待收货状态的订单）

### 3.2 请求参数

#### 请求头
```
Content-Type: application/json
```

#### 请求体（JSON）

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | string/number | 是 | 用户ID（订单所有者） |
| order_id | string/number | 是 | 订单ID |

#### 请求示例

```json
{
  "user_id": "123",
  "order_id": "1001"
}
```

### 3.3 响应参数

#### 成功响应

**状态码**: `200`

**响应体（JSON）**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | string | 响应消息，成功时为 "success" |
| data | object | 订单数据（可选） |
| data.order_id | string/number | 订单ID |
| data.status | string | 订单状态（应为 "completed"） |

**响应示例**

```json
{
  "msg": "success",
  "data": {
    "order_id": "1001",
    "status": "completed"
  }
}
```

#### 错误响应

**状态码**: `400` 或 `500`

**响应体（JSON）**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | string | 响应消息，失败时为 "error" |
| error | string | 错误描述信息 |

**错误响应示例**

```json
{
  "msg": "error",
  "error": "订单状态不允许确认收货"
}
```

### 3.4 错误码说明

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 400 | 参数错误 | 请求参数缺失或格式不正确 |
| 400 | 订单不存在 | order_id 对应的订单不存在 |
| 400 | 订单不属于当前用户 | 订单的 user_id 与请求的 user_id 不匹配 |
| 400 | 订单状态不允许确认收货 | 订单状态不是 `shipped`（待收货） |
| 500 | 服务器错误 | 服务器内部错误 |

### 3.5 业务逻辑说明

1. **权限验证**
   - 必须验证订单的 `user_id` 与请求的 `user_id` 一致
   - 防止用户确认收货他人的订单

2. **状态限制**
   - 只有 `shipped`（待收货）状态的订单可以确认收货
   - 其他状态的订单不能确认收货

3. **订单状态更新**
   - 确认收货后，订单状态应更新为 `completed`（已完成）
   - 更新 `update_time` 字段
   - 可以记录确认收货时间（可选）

4. **后续处理**
   - 确认收货后，可以触发评价提醒（如果需要）
   - 可以更新商品的销量统计

---

## 4. 支付订单接口（可选）

### 4.1 接口信息

- **接口路径**: `/order/pay`
- **请求方法**: `POST`
- **接口描述**: 支付订单（仅支持待付款状态的订单）

### 4.2 请求参数

#### 请求头
```
Content-Type: application/json
```

#### 请求体（JSON）

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | string/number | 是 | 用户ID（订单所有者） |
| order_id | string/number | 是 | 订单ID |

#### 请求示例

```json
{
  "user_id": "123",
  "order_id": "1001"
}
```

### 4.3 响应参数

#### 成功响应

**状态码**: `200`

**响应体（JSON）**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | string | 响应消息，成功时为 "success" |
| data | object | 订单数据（可选） |
| data.order_id | string/number | 订单ID |
| data.status | string | 订单状态（应为 "paid"） |

**响应示例**

```json
{
  "msg": "success",
  "data": {
    "order_id": "1001",
    "status": "paid"
  }
}
```

#### 错误响应

**状态码**: `400` 或 `500`

**响应体（JSON）**

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | string | 响应消息，失败时为 "error" |
| error | string | 错误描述信息 |

**错误响应示例**

```json
{
  "msg": "error",
  "error": "订单状态不允许支付"
}
```

### 4.4 错误码说明

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 400 | 参数错误 | 请求参数缺失或格式不正确 |
| 400 | 订单不存在 | order_id 对应的订单不存在 |
| 400 | 订单不属于当前用户 | 订单的 user_id 与请求的 user_id 不匹配 |
| 400 | 订单状态不允许支付 | 订单状态不是 `pending`（待付款） |
| 500 | 服务器错误 | 服务器内部错误 |

### 4.5 业务逻辑说明

1. **权限验证**
   - 必须验证订单的 `user_id` 与请求的 `user_id` 一致
   - 防止用户支付他人的订单

2. **状态限制**
   - 只有 `pending`（待付款）状态的订单可以支付
   - 其他状态的订单不能支付

3. **支付处理**
   - 实际项目中，这里应该调用微信支付接口或其他支付渠道
   - 支付成功后，订单状态应更新为 `paid`（待发货）
   - 更新 `update_time` 字段
   - 可以记录支付时间（可选）

4. **支付失败处理**
   - 如果支付失败，订单状态保持为 `pending`
   - 返回相应的错误信息

---

## 5. 订单状态说明

### 5.1 订单状态流转

```
pending（待付款）
    ↓ [支付]
paid（待发货）
    ↓ [发货]
shipped（待收货）
    ↓ [确认收货]
completed（已完成）

pending（待付款） → [取消] → cancelled（已取消）
paid（待发货） → [取消] → cancelled（已取消）
```

### 5.2 订单状态说明

| 状态 | 说明 | 可执行操作 |
|------|------|------------|
| pending | 待付款 | 取消订单、去付款 |
| paid | 待发货 | 取消订单 |
| shipped | 待收货 | 确认收货 |
| completed | 已完成 | 无（可查看详情、评价） |
| cancelled | 已取消 | 无（可查看详情） |

---

## 6. 前端调用示例

### 6.1 获取订单列表

```javascript
// 获取全部订单
const result = await ajax(
  `/order/list?user_id=${user_id}&page=1&pageSize=10`,
  'GET',
  {}
);

// 获取待付款订单
const result = await ajax(
  `/order/list?user_id=${user_id}&status=pending&page=1&pageSize=10`,
  'GET',
  {}
);

if (result?.msg === 'success') {
  const orderList = result.data.list;
  const total = result.data.total;
  // 处理订单列表
}
```

### 6.2 取消订单

```javascript
const result = await ajax('/order/cancel', 'POST', {
  user_id: user_id,
  order_id: order_id
});

if (result?.msg === 'success') {
  // 取消成功，刷新订单列表
  this.loadOrderList(true);
} else {
  // 取消失败
  wx.showToast({
    title: result?.error || '取消订单失败',
    icon: 'none'
  });
}
```

### 6.3 确认收货

```javascript
const result = await ajax('/order/confirm', 'POST', {
  user_id: user_id,
  order_id: order_id
});

if (result?.msg === 'success') {
  // 确认收货成功，刷新订单列表
  this.loadOrderList(true);
} else {
  // 确认收货失败
  wx.showToast({
    title: result?.error || '确认收货失败',
    icon: 'none'
  });
}
```

### 6.4 支付订单

```javascript
const result = await ajax('/order/pay', 'POST', {
  user_id: user_id,
  order_id: order_id
});

if (result?.msg === 'success') {
  // 支付成功，刷新订单列表
  this.loadOrderList(true);
} else {
  // 支付失败
  wx.showToast({
    title: result?.error || '支付失败',
    icon: 'none'
  });
}
```

---

## 7. 注意事项

1. **数据安全**
   - 所有接口都必须验证 `user_id`，确保用户只能操作自己的订单
   - 订单状态变更必须符合业务逻辑，防止非法状态流转

2. **库存管理**
   - 取消订单时，应恢复商品或规格的库存
   - 确认收货后，可以更新商品的销量统计

3. **订单数据完整性**
   - 建议在订单创建时保存商品快照信息（商品描述、图片、价格等）
   - 避免商品信息变更影响历史订单显示

4. **性能优化**
   - 订单列表接口建议使用分页，避免一次性返回过多数据
   - 对常用查询字段（如 `user_id`、`status`）建立数据库索引

5. **错误处理**
   - 前端应妥善处理各种错误情况，给用户友好的提示
   - 建议对网络错误、参数错误、业务错误进行分类处理

---

## 8. 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2024-01-29 | 1.0.0 | 初始版本，订单列表、取消订单、确认收货、支付订单接口文档 |

---

## 9. 联系方式

如有问题，请联系后端开发团队。

