# 消息列表接口文档

## 概述

本文档描述了小程序消息列表页面的接口规范，包括获取聊天列表、处理聊天对象信息、头像显示等功能。

---

## 1. 获取聊天列表

### 接口地址
`GET /chat/list`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | Integer | 是 | 当前用户ID |

### 请求示例

```
GET /chat/list?user_id=123
```

### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态："success" 或错误信息 |
| data | Object | 响应数据 |
| data.list | Array | 聊天列表 |
| data.list[].chat_id | Integer | 聊天会话ID |
| data.list[].target_user | Object | **聊天对象用户信息（推荐）** |
| data.list[].target_user.user_id | Integer | 用户ID |
| data.list[].target_user.nickname | String | 用户昵称 |
| data.list[].target_user.avatar | String | 用户头像URL（完整HTTP/HTTPS URL） |
| data.list[].last_message | String | 最后一条消息内容 |
| data.list[].last_message_time | String | 最后一条消息时间（ISO 8601格式） |
| data.list[].unread_count | Integer | 未读消息数 |
| data.list[].goods_id | Integer | 关联的商品ID（可选） |

### 响应示例（推荐格式）

**成功：**
```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "chat_id": 501,
        "target_user": {
          "user_id": 456,
          "nickname": "商家A",
          "avatar": "https://example.com/avatar1.jpg"
        },
        "last_message": "好的，我明天发货",
        "last_message_time": "2024-01-15T14:30:00Z",
        "unread_count": 2,
        "goods_id": 789
      },
      {
        "chat_id": 502,
        "target_user": {
          "user_id": 789,
          "nickname": "用户B",
          "avatar": "https://example.com/avatar2.jpg"
        },
        "last_message": "谢谢！",
        "last_message_time": "2024-01-14T16:20:00Z",
        "unread_count": 0,
        "goods_id": null
      }
    ]
  }
}
```

### 兼容格式（如果后端返回其他字段名）

前端代码已经兼容以下格式：

#### 格式1：使用 `user` 和 `target_user`
```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "chat_id": 501,
        "user": {
          "user_id": 123,
          "nickname": "当前用户",
          "avatar": "https://example.com/avatar0.jpg"
        },
        "target_user": {
          "user_id": 456,
          "nickname": "商家A",
          "avatar": "https://example.com/avatar1.jpg"
        },
        "last_message": "好的，我明天发货",
        "last_message_time": "2024-01-15T14:30:00Z",
        "unread_count": 2,
        "goods_id": 789
      }
    ]
  }
}
```

#### 格式2：使用 `user1` 和 `user2`
```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "chat_id": 501,
        "user1": {
          "user_id": 123,
          "nickname": "用户A",
          "avatar": "https://example.com/avatar1.jpg"
        },
        "user2": {
          "user_id": 456,
          "nickname": "用户B",
          "avatar": "https://example.com/avatar2.jpg"
        },
        "last_message": "好的，我明天发货",
        "last_message_time": "2024-01-15T14:30:00Z",
        "unread_count": 2,
        "goods_id": 789
      }
    ]
  }
}
```

**失败：**
```json
{
  "msg": "error",
  "error": "用户不存在"
}
```

### 业务规则

1. **排序规则**：按 `last_message_time` 降序排列（最新的在前）。
2. **未读消息数**：统计当前用户作为接收者的未读消息数。
3. **聊天对象确定**：
   - **推荐**：后端直接返回 `target_user` 字段，包含聊天对象的信息
   - **兼容**：如果返回 `user` 和 `target_user`，前端会自动判断哪个是聊天对象
   - **兼容**：如果返回 `user1` 和 `user2`，前端会自动找到不是当前用户的那个
4. **头像URL要求**：
   - 必须是完整的HTTP/HTTPS URL
   - 不能是相对路径（如 `/avatar.jpg`）
   - 不能是示例URL（如 `your-domain.com`、`example.com`、`localhost`）
   - 如果头像为空、null、undefined或无效URL，前端会使用默认头像 `/assets/default_avatar.png`

---

## 2. 前端处理逻辑

### 聊天对象识别

前端会按以下优先级识别聊天对象：

1. **优先**：如果存在 `target_user`，直接使用
2. **其次**：如果存在 `user`，判断 `user.user_id` 是否等于当前 `user_id`
   - 如果等于，说明 `user` 是当前用户，需要找另一个用户（可能是 `user2` 或 `other_user`）
   - 如果不等于，说明 `user` 就是聊天对象
3. **再次**：如果存在 `user1` 和 `user2`，找到不是当前用户的那个
4. **默认**：如果都找不到，使用默认值（昵称："未设置昵称"，头像：默认头像）

### 头像URL处理

前端会对头像URL进行以下处理：

1. **检查无效URL**：如果头像URL包含 `your-domain.com`、`example.com`、`localhost`，使用默认头像
2. **检查空值**：如果头像URL为空字符串、`null`、`undefined`，使用默认头像
3. **加载失败处理**：如果头像加载失败，自动切换到默认头像

### 时间格式化

前端会将 `last_message_time` 格式化为易读的文本：

- 1分钟内：显示 "刚刚"
- 1小时内：显示 "X分钟前"
- 24小时内：显示 "X小时前"
- 7天内：显示 "X天前"
- 超过7天：显示 "M-D"（月-日）

---

## 3. 点击聊天项

### 前端处理

当用户点击聊天列表中的某一项时：

1. **获取参数**：从 `data-target-user-id` 和 `data-goods-id` 获取聊天对象ID和商品ID
2. **验证登录**：检查用户是否已登录
3. **验证聊天对象**：检查不能和自己聊天（`target_user_id != user_id`）
4. **跳转**：跳转到聊天详情页面 `/pages/chat/chat?target_user_id={target_user_id}&goods_id={goods_id}`

### 错误处理

- 如果 `target_user_id` 为空，提示"无法获取聊天对象信息"
- 如果未登录，提示"请先登录"并跳转到登录页面
- 如果尝试和自己聊天，提示"不能和自己聊天"

---

## 4. 下拉刷新

### 功能说明

消息列表页面支持下拉刷新，刷新时会重新调用 `GET /chat/list` 接口获取最新数据。

### 配置

在 `pages/message/message.json` 中已配置：

```json
{
  "enablePullDownRefresh": true,
  "backgroundTextStyle": "dark"
}
```

---

## 5. 数据库设计建议

### 聊天会话表（chat_sessions）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| chat_id | Integer | 主键，聊天会话ID |
| user1_id | Integer | 用户1的ID（较小的user_id） |
| user2_id | Integer | 用户2的ID（较大的user_id） |
| goods_id | Integer | 关联的商品ID（可选） |
| last_message_id | Integer | 最后一条消息ID |
| last_message_time | DateTime | 最后一条消息时间 |
| create_time | DateTime | 创建时间 |
| update_time | DateTime | 更新时间 |

**索引建议：**
- `(user1_id, user2_id)` 唯一索引
- `last_message_time` 索引（用于排序）

### 消息表（chat_messages）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| message_id | Integer | 主键，消息ID |
| chat_id | Integer | 聊天会话ID（外键） |
| sender_id | Integer | 发送者用户ID |
| receiver_id | Integer | 接收者用户ID |
| content | Text | 消息内容 |
| is_read | Boolean | 是否已读（默认false） |
| create_time | DateTime | 创建时间 |

**索引建议：**
- `chat_id` 索引
- `(sender_id, receiver_id)` 索引
- `create_time` 索引（用于排序）
- `is_read` 索引（用于统计未读数）

### SQL查询示例（获取聊天列表）

```sql
-- 获取用户123的所有聊天会话
SELECT 
  cs.chat_id,
  cs.goods_id,
  cs.last_message_time,
  cm.content AS last_message,
  -- 确定聊天对象（不是当前用户的那个）
  CASE 
    WHEN cs.user1_id = 123 THEN u2.user_id
    ELSE u1.user_id
  END AS target_user_id,
  CASE 
    WHEN cs.user1_id = 123 THEN u2.nickname
    ELSE u1.nickname
  END AS target_user_nickname,
  CASE 
    WHEN cs.user1_id = 123 THEN u2.avatar
    ELSE u1.avatar
  END AS target_user_avatar,
  -- 统计未读消息数
  (SELECT COUNT(*) 
   FROM chat_messages 
   WHERE chat_id = cs.chat_id 
     AND receiver_id = 123 
     AND is_read = false) AS unread_count
FROM chat_sessions cs
LEFT JOIN users u1 ON cs.user1_id = u1.user_id
LEFT JOIN users u2 ON cs.user2_id = u2.user_id
LEFT JOIN chat_messages cm ON cs.last_message_id = cm.message_id
WHERE cs.user1_id = 123 OR cs.user2_id = 123
ORDER BY cs.last_message_time DESC;
```

---

## 6. 注意事项

1. **推荐返回格式**：后端最好直接返回 `target_user` 字段，包含聊天对象的完整信息，这样前端处理更简单。
2. **头像URL格式**：确保返回的头像URL是完整的HTTP/HTTPS URL，不能是相对路径或示例URL。
3. **数据一致性**：确保 `target_user` 中的 `user_id`、`nickname`、`avatar` 与用户表中的数据一致。
4. **未读消息统计**：确保 `unread_count` 准确统计当前用户作为接收者的未读消息数。
5. **排序**：确保按 `last_message_time` 降序排列，最新的聊天会话在前。

---

## 7. 测试建议

1. **多账号测试**：
   - 账号A和账号B互相发送消息
   - 验证两个账号的聊天列表都能正确显示对方信息

2. **头像显示测试**：
   - 测试有效头像URL
   - 测试无效头像URL（示例URL、空值）
   - 验证默认头像是否正确显示

3. **点击功能测试**：
   - 测试点击聊天项是否能正确跳转
   - 测试未登录时的提示
   - 测试和自己聊天时的提示

4. **下拉刷新测试**：
   - 测试下拉刷新是否能正确加载最新数据

---

## 更新日志

- 2024-01-15：初始版本，包含获取聊天列表、处理聊天对象信息、头像显示等功能。




