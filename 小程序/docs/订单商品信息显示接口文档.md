# 订单商品信息显示接口文档

## 1. 概述

本文档说明订单列表接口需要返回的商品信息字段，确保订单页面能够正常显示商品图片、描述、规格等信息。

---

## 2. 问题描述

在我卖出的页面，商品信息（图片、描述等）不能正常显示。原因是订单列表接口返回的数据结构不完整或字段名不匹配。

---

## 3. 接口要求

### 3.1 我卖出的订单列表接口

**接口路径**: `/order/sold/list`  
**请求方法**: `GET`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | string/number | 是 | 卖家用户ID |
| status | string | 否 | 订单状态筛选 |
| page | number | 是 | 页码 |
| pageSize | number | 是 | 每页数量 |

#### 响应数据要求

**必须包含的商品信息字段**：

```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "order_id": 1,
        "order_no": "ORD202401290001",
        "buyer_id": 123,
        "seller_id": 456,
        "goods_id": 789,
        
        // ========== 商品信息字段（必须） ==========
        "goods_image": ["https://example.com/image1.jpg", "https://example.com/image2.jpg"],
        "goods_description": "商品描述信息",
        "spec_name": "规格名称",
        "quantity": 1,
        "total_price": "99.00",
        // ==========================================
        
        "status": "paid",
        "create_time": "2024-01-29 10:00:00",
        "pay_time": "2024-01-29 10:05:00",
        "ship_time": null,
        "receive_time": null,
        "complete_time": null
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 10
  }
}
```

### 3.2 我买到的订单列表接口

**接口路径**: `/order/bought/list`  
**请求方法**: `GET`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| user_id | string/number | 是 | 买家用户ID |
| status | string | 否 | 订单状态筛选 |
| page | number | 是 | 页码 |
| pageSize | number | 是 | 每页数量 |

#### 响应数据要求

**必须包含的商品信息字段**（与我卖出的接口相同）：

```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "order_id": 1,
        "order_no": "ORD202401290001",
        "buyer_id": 123,
        "seller_id": 456,
        "goods_id": 789,
        
        // ========== 商品信息字段（必须） ==========
        "goods_image": ["https://example.com/image1.jpg"],
        "goods_description": "商品描述信息",
        "spec_name": "规格名称",
        "quantity": 1,
        "total_price": "99.00",
        // ==========================================
        
        "status": "shipped",
        "create_time": "2024-01-29 10:00:00",
        "pay_time": "2024-01-29 10:05:00",
        "ship_time": "2024-01-29 11:00:00",
        "receive_time": null,
        "complete_time": null
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 10
  }
}
```

---

## 4. 字段说明

### 4.1 商品图片字段

**字段名**: `goods_image`  
**类型**: `array`（数组）  
**必填**: 是  
**说明**: 
- 必须是数组格式，即使只有一张图片也要放在数组中
- 数组元素为图片URL字符串
- 如果商品没有图片，返回空数组 `[]`
- 至少返回第一张图片，用于订单列表显示

**示例**：
```json
// 单张图片
"goods_image": ["https://example.com/image1.jpg"]

// 多张图片
"goods_image": ["https://example.com/image1.jpg", "https://example.com/image2.jpg"]

// 无图片
"goods_image": []
```

**错误示例**：
```json
// ❌ 错误：字符串格式
"goods_image": "https://example.com/image1.jpg"

// ❌ 错误：null
"goods_image": null
```

### 4.2 商品描述字段

**字段名**: `goods_description`  
**类型**: `string`（字符串）  
**必填**: 是  
**说明**: 
- 商品的描述信息，用于在订单列表中显示
- 如果商品没有描述，返回商品名称或默认值
- 建议长度不超过100个字符

**示例**：
```json
"goods_description": "新鲜水果 优质橘子 产地直发"
```

### 4.3 规格名称字段

**字段名**: `spec_name`  
**类型**: `string`（字符串）或 `null`  
**必填**: 否  
**说明**: 
- 商品的规格名称，如"大号"、"红色"、"500g"等
- 如果商品没有规格，返回 `null` 或不包含此字段
- 如果商品有规格，必须返回规格名称

**示例**：
```json
// 有规格
"spec_name": "橘子1"

// 无规格
"spec_name": null
```

### 4.4 数量字段

**字段名**: `quantity`  
**类型**: `number`（数字）  
**必填**: 是  
**说明**: 
- 订单中该商品的数量
- 必须大于0

**示例**：
```json
"quantity": 1
```

### 4.5 总价字段

**字段名**: `total_price`  
**类型**: `string`（字符串）或 `number`（数字）  
**必填**: 是  
**说明**: 
- 订单的总价
- 建议使用字符串格式，保留两位小数
- 如果使用数字格式，前端会自动格式化

**示例**：
```json
// 字符串格式（推荐）
"total_price": "99.00"

// 数字格式（也可接受）
"total_price": 99.00
```

---

## 5. 数据关联说明

### 5.1 商品信息获取方式

订单表应该关联商品表，获取商品信息。推荐两种方式：

#### 方式一：JOIN查询（推荐）

在查询订单列表时，通过 `JOIN` 关联商品表，直接获取商品信息：

```sql
SELECT 
  o.order_id,
  o.order_no,
  o.buyer_id,
  o.seller_id,
  o.goods_id,
  o.quantity,
  o.total_price,
  o.status,
  o.create_time,
  -- 商品信息
  g.images AS goods_image,
  g.description AS goods_description,
  s.name AS spec_name
FROM orders o
LEFT JOIN goods g ON o.goods_id = g.goods_id
LEFT JOIN goods_specs s ON o.spec_id = s.spec_id
WHERE o.seller_id = ?
ORDER BY o.create_time DESC
```

#### 方式二：关联查询

如果使用ORM框架，可以通过关联查询获取商品信息：

```javascript
// 示例：使用Sequelize
const orders = await Order.findAll({
  where: { seller_id: user_id },
  include: [
    {
      model: Goods,
      as: 'goods',
      attributes: ['images', 'description']
    },
    {
      model: GoodsSpec,
      as: 'spec',
      attributes: ['name']
    }
  ]
});

// 处理数据
const list = orders.map(order => ({
  order_id: order.order_id,
  goods_id: order.goods_id,
  goods_image: order.goods?.images || [],
  goods_description: order.goods?.description || '商品描述',
  spec_name: order.spec?.name || null,
  // ... 其他字段
}));
```

### 5.2 商品图片处理

如果商品表存储的图片是JSON字符串，需要解析为数组：

```javascript
// 示例：处理商品图片
let goodsImage = [];
if (goods.images) {
  if (typeof goods.images === 'string') {
    try {
      goodsImage = JSON.parse(goods.images);
    } catch (e) {
      goodsImage = [goods.images];
    }
  } else if (Array.isArray(goods.images)) {
    goodsImage = goods.images;
  }
}
```

---

## 6. 前端处理逻辑

前端已经增强了数据处理逻辑，支持以下兼容性处理：

### 6.1 字段名兼容

前端支持多种字段名：
- 商品图片：`goods_image`、`goods_img`、`image`、`images`
- 商品描述：`goods_description`、`description`、`goods_name`、`name`
- 规格名称：`spec_name`、`spec`、`specification`
- 数量：`quantity`、`qty`、`count`
- 价格：`total_price`、`price`、`amount`

### 6.2 图片格式兼容

前端会自动处理以下情况：
- 字符串格式的图片URL → 转换为数组
- JSON字符串格式的图片 → 解析为数组
- 数组格式的图片 → 直接使用
- 空值或null → 转换为空数组

### 6.3 商品信息补全

如果订单中没有商品信息，但有 `goods_id`，前端会尝试调用商品详情接口获取商品信息：

```javascript
// 如果订单中没有商品图片，但有goods_id
if (!goodsImage && order.goods_id) {
  const goodsResult = await ajax(`/goods/detail?goods_id=${order.goods_id}`, 'GET', {});
  if (goodsResult?.msg === 'success' && goodsResult.data) {
    const goods = goodsResult.data;
    goodsImage = goods.images || goods.image || goods.goods_image || null;
    order.goods_description = goods.description || goods.goods_description || goods.name || '商品描述';
  }
}
```

**注意**：这种方式会增加接口调用次数，建议后端直接返回完整的商品信息。

---

## 7. 接口对接要求

### 7.1 必须返回的字段

订单列表接口**必须**返回以下字段：

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `goods_image` | array | 是 | 商品图片数组 |
| `goods_description` | string | 是 | 商品描述 |
| `spec_name` | string/null | 否 | 规格名称 |
| `quantity` | number | 是 | 数量 |
| `total_price` | string/number | 是 | 总价 |

### 7.2 数据格式要求

1. **商品图片**：
   - 必须是数组格式
   - 至少返回第一张图片（如果有）
   - 如果没有图片，返回空数组 `[]`

2. **商品描述**：
   - 必须是字符串
   - 不能为空或null
   - 建议长度不超过100个字符

3. **规格名称**：
   - 如果有规格，返回规格名称字符串
   - 如果没有规格，返回 `null` 或不包含此字段

4. **数量**：
   - 必须是数字
   - 必须大于0

5. **总价**：
   - 建议使用字符串格式，保留两位小数
   - 例如：`"99.00"`

### 7.3 性能优化建议

1. **使用JOIN查询**：
   - 在查询订单列表时，通过JOIN关联商品表，一次性获取所有信息
   - 避免在循环中查询商品信息

2. **图片处理**：
   - 如果商品表存储的图片是JSON字符串，在查询时解析为数组
   - 只返回第一张图片（用于列表显示），减少数据传输量

3. **缓存**：
   - 商品信息变化不频繁，可以考虑缓存
   - 但订单信息需要实时，不建议缓存订单列表

---

## 8. 测试要点

### 8.1 功能测试

1. **商品图片显示**：
   - 测试有图片的订单是否正常显示
   - 测试无图片的订单是否显示默认图片
   - 测试多张图片的订单是否显示第一张

2. **商品描述显示**：
   - 测试商品描述是否正常显示
   - 测试描述过长时的截断效果

3. **规格信息显示**：
   - 测试有规格的订单是否显示规格名称
   - 测试无规格的订单是否不显示规格

4. **数量显示**：
   - 测试数量是否正确显示

5. **价格显示**：
   - 测试价格是否正确显示
   - 测试价格格式是否正确（保留两位小数）

### 8.2 边界测试

1. **空数据**：
   - 测试商品图片为空数组的情况
   - 测试商品描述为空字符串的情况
   - 测试规格名称为null的情况

2. **异常数据**：
   - 测试商品图片为null的情况
   - 测试商品描述为null的情况
   - 测试数量为0或负数的情况

3. **数据格式**：
   - 测试商品图片为字符串的情况（前端会自动转换）
   - 测试商品图片为JSON字符串的情况（前端会自动解析）

---

## 9. 错误处理

### 9.1 常见错误

1. **商品图片格式错误**：
   - 错误：返回字符串而不是数组
   - 处理：前端会自动转换为数组

2. **商品信息缺失**：
   - 错误：订单中没有商品信息
   - 处理：前端会尝试通过goods_id获取商品信息

3. **字段名不匹配**：
   - 错误：后端返回的字段名与前端期望的不一致
   - 处理：前端支持多种字段名兼容

### 9.2 建议

1. **统一字段名**：
   - 建议使用标准字段名：`goods_image`、`goods_description`、`spec_name`、`quantity`、`total_price`
   - 避免使用非标准字段名

2. **数据完整性**：
   - 确保订单列表接口返回完整的商品信息
   - 避免前端需要额外调用接口获取商品信息

---

## 10. 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2024-01-29 | 1.0.0 | 初始版本，订单商品信息显示接口文档 |

---

## 11. 联系方式

如有问题，请联系前端开发团队。

