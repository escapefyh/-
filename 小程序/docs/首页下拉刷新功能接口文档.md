# 首页下拉刷新功能接口文档

## 功能说明

在首页的三个标签页（关注、推荐、新发）中，用户可以通过下拉刷新来重新加载商品列表。

**刷新行为：**
- 当用户在**任意标签页**（关注、推荐、新发）下拉刷新时，**自动跳转到推荐标签页**并刷新推荐页面的内容
- 如果当前页面已经是推荐标签页，则直接刷新推荐页面的内容

## 刷新逻辑

### 刷新时的行为

1. **在"关注"标签页下拉刷新**
   - 自动切换到"推荐"标签页
   - 刷新推荐页面的商品列表

2. **在"新发"标签页下拉刷新**
   - 自动切换到"推荐"标签页
   - 刷新推荐页面的商品列表

3. **在"推荐"标签页下拉刷新**
   - 保持当前标签页（推荐）
   - 刷新推荐页面的商品列表

### 刷新时调用的接口

无论用户在哪个标签页下拉刷新，最终都会调用**推荐标签页的接口**：

**接口地址：** `GET /goods/list?page=1&pageSize=20`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | Integer | 是 | 页码，刷新时为 1 |
| pageSize | Integer | 是 | 每页数量，默认为 20 |

**请求示例：**

```
GET /goods/list?page=1&pageSize=20
```

**响应格式：**

```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "goods_id": "商品ID",
        "description": "商品描述",
        "price": 99.00,
        "images": ["图片URL1", "图片URL2"],
        "create_time": "2024-01-01T12:00:00.000Z",
        "seller": {
          "user_id": "卖家用户ID",
          "nickname": "卖家昵称",
          "avatar": "头像URL"
        },
        "group_buy_enabled": false,
        "group_buy_discount": null,
        "category_id": 1
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

**业务逻辑：**
- 返回所有上架的商品（或根据推荐算法返回推荐商品）
- 按默认排序规则排列（如：按创建时间倒序、按热度排序等）
- 支持分页查询

---

## 前端刷新逻辑

### 1. 下拉刷新触发

当用户在首页下拉时，会触发 `onPullDownRefresh` 生命周期函数。

### 2. 刷新流程

```javascript
onPullDownRefresh() {
  console.log('下拉刷新触发，当前标签页:', this.data.currentTab);
  
  if (this.data.isSearching && this.data.searchKeyword) {
    // 搜索状态下，刷新搜索结果
    this.searchGoods(this.data.searchKeyword, true).then(() => {
      wx.stopPullDownRefresh();
    });
  } else {
    // 普通状态下，刷新时自动跳转到推荐标签页
    // 如果当前已经是推荐标签页，则直接刷新
    if (this.data.currentTab !== 'recommend') {
      console.log('刷新时自动切换到推荐标签页');
      // 切换到推荐标签页
      this.setData({
        currentTab: 'recommend',
        page: 1,
        hasMore: true,
        goodsList: [] // 清空列表，确保刷新时显示新数据
      });
    } else {
      // 当前已经是推荐标签页，重置分页参数
      this.setData({
        page: 1,
        hasMore: true,
        goodsList: [] // 清空列表，确保刷新时显示新数据
      });
    }
    
    // 刷新推荐页面的数据
    // 传入 isRefresh = true，确保使用正确的分页参数
    this.loadGoodsList(true).then(() => {
      console.log('刷新完成，当前标签页:', this.data.currentTab);
      wx.stopPullDownRefresh();
    }).catch((error) => {
      console.error('刷新失败:', error);
      wx.stopPullDownRefresh();
    });
  }
}
```

### 3. 刷新时加载数据

刷新时，无论用户在哪个标签页，都会切换到推荐标签页，然后调用推荐接口：

```javascript
async loadGoodsList(isRefresh = false) {
  // ... 前置检查逻辑 ...
  
  // 刷新时使用 page = 1，否则使用当前页码
  const currentPage = isRefresh ? 1 : this.data.page;
  let requestUrl = '';
  
  // 刷新时，currentTab 已经被设置为 'recommend'
  // 所以这里会调用推荐接口
  if (this.data.currentTab === 'new') {
    requestUrl = `/goods/new?page=${currentPage}&pageSize=${this.data.pageSize}`;
  }
  else if (this.data.currentTab === 'follow') {
    const user_id = wx.getStorageSync('user_id');
    if (user_id) {
      requestUrl = `/goods/list?page=${currentPage}&pageSize=${this.data.pageSize}&follower_id=${user_id}`;
    } else {
      this.setData({ 
        goodsList: [],
        loading: false 
      });
      return;
    }
  }
  // 推荐标签（刷新时统一调用此接口）
  else {
    requestUrl = `/goods/list?page=${currentPage}&pageSize=${this.data.pageSize}`;
    console.log('刷新推荐页面，调用接口:', requestUrl);
  }
  
  // 调用接口获取数据
  const result = await ajax(requestUrl, 'GET', {});
  
  // ... 处理返回数据 ...
}
```

---

## 关键实现要点

### 1. 自动跳转到推荐标签页

- 下拉刷新时，如果当前不是推荐标签页，**会自动切换到推荐标签页**
- 刷新时，`currentTab` 会被设置为 `'recommend'`
- 确保无论用户在哪个标签页下拉刷新，最终都会刷新推荐页面的内容

### 2. 正确的分页参数

- **关键修复：** 刷新时使用 `currentPage = isRefresh ? 1 : this.data.page`，而不是直接使用 `this.data.page`
- 原因：`setData` 是异步的，在 `onPullDownRefresh` 中设置 `page: 1` 后立即调用 `loadGoodsList`，`this.data.page` 可能还是旧值
- 解决方案：在 `loadGoodsList` 中，当 `isRefresh = true` 时，直接使用 `page = 1` 来构建请求 URL

### 3. 清空列表重新加载

- 刷新时，会清空 `goodsList` 数组
- 重置分页参数：`page = 1`，`hasMore = true`
- 重新调用接口获取第一页数据

### 4. 错误处理

- 如果接口调用失败，会调用 `wx.stopPullDownRefresh()` 停止刷新动画
- 显示错误提示信息

### 5. 搜索状态处理

- 如果用户正在搜索状态，刷新时会刷新搜索结果，不会跳转到推荐标签页

---

## 接口要求

### 推荐标签页接口（刷新时统一调用）

**接口地址：** `GET /goods/list?page=1&pageSize=20`

**要求：**
- **这是下拉刷新时唯一调用的接口**
- 必须支持分页参数 `page` 和 `pageSize`
- 返回所有商品列表（或推荐商品列表）
- 按默认排序规则排列

**数据库查询逻辑：**

```sql
-- 查询所有商品（或推荐商品）
SELECT 
  g.goods_id,
  g.description,
  g.price,
  g.images,
  g.create_time,
  g.group_buy_enabled,
  g.group_buy_discount,
  g.category_id,
  u.user_id AS seller_user_id,
  u.nickname AS seller_nickname,
  u.avatar AS seller_avatar
FROM goods g
LEFT JOIN users u ON g.seller_id = u.user_id
WHERE g.status = 'active'  -- 只查询上架的商品
ORDER BY g.create_time DESC  -- 或其他排序规则
LIMIT ? OFFSET ?;
```

**注意事项：**
- 下拉刷新时，无论用户在哪个标签页，都会调用此接口
- 刷新时，`page` 参数始终为 `1`
- 返回的数据格式必须包含 `list`（商品数组）和 `total`（总数）

---

## 测试场景

### 测试场景1：在"推荐"标签页下拉刷新

**步骤：**
1. 打开首页，默认在"推荐"标签页
2. 下拉刷新

**预期结果：**
- 调用 `GET /goods/list?page=1&pageSize=20`
- 刷新后显示推荐商品列表（所有商品）
- 标签页仍为"推荐"
- 控制台输出：`刷新推荐页面，调用接口: /goods/list?page=1&pageSize=20`

---

### 测试场景2：在"关注"标签页下拉刷新

**步骤：**
1. 打开首页，切换到"关注"标签页
2. 下拉刷新

**预期结果：**
- **自动切换到"推荐"标签页**
- 调用 `GET /goods/list?page=1&pageSize=20`（推荐接口）
- 刷新后显示推荐商品列表（所有商品）
- 标签页变为"推荐"
- 控制台输出：`刷新时自动切换到推荐标签页`，`刷新推荐页面，调用接口: /goods/list?page=1&pageSize=20`

---

### 测试场景3：在"新发"标签页下拉刷新

**步骤：**
1. 打开首页，切换到"新发"标签页
2. 下拉刷新

**预期结果：**
- **自动切换到"推荐"标签页**
- 调用 `GET /goods/list?page=1&pageSize=20`（推荐接口）
- 刷新后显示推荐商品列表（所有商品）
- 标签页变为"推荐"
- 控制台输出：`刷新时自动切换到推荐标签页`，`刷新推荐页面，调用接口: /goods/list?page=1&pageSize=20`

---

### 测试场景4：验证分页参数

**步骤：**
1. 在任意标签页下拉刷新
2. 查看网络请求

**预期结果：**
- 请求 URL 中的 `page` 参数必须是 `1`
- 不应该出现 `page=2` 或其他值
- 无论从哪个标签页刷新，都调用推荐接口

---

### 测试场景5：搜索状态下刷新

**步骤：**
1. 在首页搜索商品
2. 在搜索结果页面下拉刷新

**预期结果：**
- 刷新搜索结果，不会跳转到推荐标签页
- 保持搜索状态

---

## 常见问题

### Q1: 下拉刷新时，标签页会切换吗？

**A:** 会的。下拉刷新时，如果当前不是推荐标签页，**会自动切换到推荐标签页**。如果当前已经是推荐标签页，则保持不变。

### Q2: 为什么刷新后显示的是推荐页面的内容？

**A:** 这是**设计需求**。无论用户在哪个标签页下拉刷新，都会自动跳转到推荐标签页并刷新推荐页面的内容。

### Q3: 下拉刷新时，会清空商品列表吗？

**A:** 会的。刷新时会先清空 `goodsList`，然后重新加载第一页数据，确保显示的是最新数据。

### Q4: 下拉刷新时，分页参数会重置吗？

**A:** 会的。刷新时会重置 `page = 1`，`hasMore = true`，从第一页开始重新加载。

### Q5: 在"关注"或"新发"标签页下拉刷新会怎样？

**A:** 会自动切换到"推荐"标签页，然后刷新推荐页面的内容。

### Q6: 如何验证刷新功能是否正常？

**A:** 
1. 打开浏览器开发者工具（或微信开发者工具的控制台）
2. 切换到不同的标签页（关注、推荐、新发）
3. 下拉刷新
4. 查看控制台日志，确认是否切换到推荐标签页
5. 查看网络请求，确认调用的是推荐接口 `GET /goods/list?page=1&pageSize=20`
6. 确认页面显示的是推荐商品列表

### Q7: 如果我想刷新"关注"或"新发"标签页的内容怎么办？

**A:** 目前的设计是刷新时统一跳转到推荐标签页。如果需要刷新其他标签页的内容，需要：
1. 先切换到对应的标签页
2. 然后通过其他方式（如点击刷新按钮）来刷新，而不是下拉刷新

---

## 调试建议

### 1. 查看控制台日志

刷新时，控制台会输出：
- `下拉刷新触发，当前标签页: {currentTab}`
- `刷新时自动切换到推荐标签页`（如果不是推荐标签页）
- `刷新推荐页面，调用接口: /goods/list?page=1&pageSize=20`
- `刷新完成，当前标签页: recommend`

### 2. 检查网络请求

在开发者工具的网络面板中，检查：
- 请求 URL 是否正确：`/goods/list?page=1&pageSize=20`
- 请求参数是否正确（特别是 `page` 必须为 `1`）
- 响应数据是否符合预期

### 3. 检查数据状态

在控制台中输入：
```javascript
// 查看当前标签页
getCurrentPages()[0].data.currentTab

// 查看商品列表
getCurrentPages()[0].data.goodsList
```

---

## 版本信息

- **文档版本：** v2.0
- **创建日期：** 2024-01-01
- **最后更新：** 2024-01-01
- **更新说明：** 
  - v2.0: 修改刷新逻辑，刷新时自动跳转到推荐标签页
  - v1.0: 初始版本，刷新时保持当前标签页状态

---

## 相关文档

- 《首页关注功能接口文档.md》
- 《新发页面接口文档.md》
- 《商品列表接口文档.md》

---

## 联系方式

如有疑问，请联系前端开发人员。
