# 分类商品搜索接口文档

## 概述

本文档描述了在分类页面中搜索该分类下商品的功能接口规范。当用户在分类页面进行搜索时，搜索结果将限定在该分类下的商品。

---

## 接口信息

### 获取商品列表（支持分类和搜索）

**接口地址：** `GET /goods/list`

**请求方法：** `GET`

**Content-Type：** `application/json`

---

## 请求参数

### Query 参数

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | Number | 是 | 页码，从1开始 |
| pageSize | Number | 是 | 每页显示数量 |
| category_id | Number | 否 | 分类ID（当在分类页面时必填） |
| keyword | String | 否 | 搜索关键词（当进行搜索时必填） |

### 参数说明

1. **分类搜索场景：**
   - 当用户在分类页面进行搜索时，`category_id` 和 `keyword` 参数同时存在
   - 后端需要返回该分类下且商品描述包含关键词的商品

2. **仅分类场景：**
   - 当用户在分类页面但未进行搜索时，只有 `category_id` 参数
   - 后端返回该分类下的所有商品

3. **仅搜索场景：**
   - 当用户在首页进行搜索时，只有 `keyword` 参数
   - 后端返回所有分类中包含关键词的商品

4. **无限制场景：**
   - 当 `category_id` 和 `keyword` 都不存在时，返回所有商品

---

## 请求示例

### 示例1：分类页面搜索商品

```http
GET /goods/list?page=1&pageSize=10&category_id=1&keyword=苹果
```

**说明：** 搜索分类ID为1（水果蔬菜）下，商品描述包含"苹果"的商品

### 示例2：分类页面浏览商品（不搜索）

```http
GET /goods/list?page=1&pageSize=10&category_id=1
```

**说明：** 获取分类ID为1（水果蔬菜）下的所有商品

### 示例3：首页搜索商品

```http
GET /goods/list?page=1&pageSize=10&keyword=苹果
```

**说明：** 搜索所有分类中，商品描述包含"苹果"的商品

### 示例4：获取所有商品

```http
GET /goods/list?page=1&pageSize=10
```

**说明：** 获取所有商品（不限定分类和关键词）

---

## 响应格式

### 成功响应

```json
{
  "msg": "success",
  "data": {
    "list": [
      {
        "goods_id": 1,
        "user_id": 123,
        "description": "新鲜苹果 5斤装",
        "price": 29.90,
        "category_id": 1,
        "images": [
          "https://example.com/image1.jpg",
          "https://example.com/image2.jpg"
        ],
        "group_buy_enabled": false,
        "group_buy_count": null,
        "group_buy_discount": null,
        "spec_enabled": false,
        "specs": null,
        "sales_count": 10,
        "create_time": "2024-01-01 10:00:00",
        "seller": {
          "user_id": 123,
          "nickname": "张三",
          "avatar": "https://example.com/avatar.jpg"
        }
      }
    ],
    "total": 50
  }
}
```

### 错误响应

```json
{
  "msg": "error",
  "error": "获取商品列表失败"
}
```

---

## 字段说明

### 请求参数

| 字段名 | 类型 | 说明 |
|--------|------|------|
| page | Number | 当前页码，从1开始 |
| pageSize | Number | 每页显示的商品数量 |
| category_id | Number | 商品分类ID（可选） |
| keyword | String | 搜索关键词，用于匹配商品描述（可选） |

### 响应字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| msg | String | 响应状态，"success" 表示成功，"error" 表示失败 |
| data | Object | 响应数据（仅在成功时返回） |
| data.list | Array | 商品列表数组 |
| data.total | Number | 符合条件的商品总数 |
| error | String | 错误信息（仅在失败时返回） |

### 商品对象字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| goods_id | Number | 商品ID |
| user_id | Number | 卖家用户ID |
| description | String | 商品描述（搜索时匹配此字段） |
| price | Number | 商品价格 |
| category_id | Number | 商品分类ID |
| images | Array | 商品图片URL数组 |
| group_buy_enabled | Boolean | 是否开启拼团 |
| group_buy_count | Number | 拼团人数（如果开启拼团） |
| group_buy_discount | Number | 拼团折扣（如果开启拼团） |
| spec_enabled | Boolean | 是否开启规格 |
| specs | Array | 规格选项数组（如果开启规格） |
| sales_count | Number | 销量 |
| create_time | String | 创建时间 |
| seller | Object | 卖家信息 |
| seller.user_id | Number | 卖家用户ID |
| seller.nickname | String | 卖家昵称 |
| seller.avatar | String | 卖家头像URL |

---

## 业务规则

### 1. 搜索匹配规则

- **搜索字段：** 搜索关键词应匹配商品的 `description`（商品描述）字段
- **匹配方式：** 建议使用模糊匹配（LIKE查询），支持部分匹配
- **大小写：** 建议不区分大小写
- **空格处理：** 关键词前后空格应被忽略，但关键词中间的空格应保留

### 2. 分类筛选规则

- 当提供 `category_id` 时，只返回该分类下的商品
- 分类ID必须有效，如果分类不存在，应返回空列表或错误信息

### 3. 组合查询规则

- 当同时提供 `category_id` 和 `keyword` 时：
  - 先按 `category_id` 筛选分类
  - 再在筛选结果中按 `keyword` 搜索商品描述
  - 返回同时满足两个条件的商品

### 4. 分页规则

- 分页从第1页开始
- 每页返回的商品数量由 `pageSize` 决定
- 返回的 `total` 字段表示符合条件的商品总数（不受分页影响）
- 前端根据 `total` 和当前已加载数量判断是否还有更多数据

### 5. 排序规则

- 建议按商品创建时间倒序排列（最新的在前）
- 或者按销量、价格等字段排序（根据业务需求）

---

## 前端调用示例

### 微信小程序调用示例

```javascript
import { ajax } from '../../utils/index'

// 在分类页面搜索商品
async function searchGoodsInCategory(categoryId, keyword, page = 1, pageSize = 10) {
  try {
    let url = `/goods/list?page=${page}&pageSize=${pageSize}`;
    
    // 添加分类ID参数
    if (categoryId) {
      url += `&category_id=${categoryId}`;
    }
    
    // 添加搜索关键词参数
    if (keyword && keyword.trim()) {
      url += `&keyword=${encodeURIComponent(keyword.trim())}`;
    }
    
    const result = await ajax(url, 'GET', {});
    
    if (result?.msg === 'success') {
      return {
        list: result.data?.list || [],
        total: result.data?.total || 0
      };
    } else {
      console.error('获取商品列表失败:', result?.error);
      return null;
    }
  } catch (error) {
    console.error('网络请求失败:', error);
    return null;
  }
}

// 使用示例
// 1. 在分类页面搜索
const result1 = await searchGoodsInCategory(1, '苹果', 1, 10);
// 请求: GET /goods/list?page=1&pageSize=10&category_id=1&keyword=苹果

// 2. 在分类页面浏览（不搜索）
const result2 = await searchGoodsInCategory(1, '', 1, 10);
// 请求: GET /goods/list?page=1&pageSize=10&category_id=1

// 3. 清除搜索，重新加载分类商品
const result3 = await searchGoodsInCategory(1, null, 1, 10);
// 请求: GET /goods/list?page=1&pageSize=10&category_id=1
```

---

## 错误处理

### 常见错误情况

1. **参数错误：**
   - `page` 或 `pageSize` 未提供或格式错误
   - `category_id` 格式错误（应为数字）

2. **分类不存在：**
   - 提供的 `category_id` 不存在
   - 建议返回空列表，而不是错误

3. **搜索无结果：**
   - 关键词在指定分类下无匹配商品
   - 应返回空列表，`total` 为 0

4. **网络错误：**
   - 网络连接失败
   - 服务器错误

### 错误响应格式

```json
{
  "msg": "error",
  "error": "错误描述信息"
}
```

---

## 性能优化建议

1. **数据库索引：**
   - 建议在 `category_id` 字段上建立索引
   - 建议在 `description` 字段上建立全文索引（如果数据库支持）

2. **缓存策略：**
   - 热门分类的商品列表可以适当缓存
   - 搜索结果不建议缓存（实时性要求高）

3. **分页优化：**
   - 建议限制 `pageSize` 的最大值（如不超过50）
   - 使用数据库的 LIMIT 和 OFFSET 进行分页

4. **搜索优化：**
   - 如果数据量大，建议使用全文搜索引擎（如 Elasticsearch）
   - 对搜索关键词进行预处理（去除空格、特殊字符等）

---

## 测试用例

### 测试用例1：分类搜索

**请求：**
```
GET /goods/list?page=1&pageSize=10&category_id=1&keyword=苹果
```

**预期结果：**
- 返回分类ID为1且描述包含"苹果"的商品
- 如果无匹配商品，返回空列表

### 测试用例2：仅分类

**请求：**
```
GET /goods/list?page=1&pageSize=10&category_id=1
```

**预期结果：**
- 返回分类ID为1的所有商品
- 按创建时间倒序排列

### 测试用例3：仅搜索

**请求：**
```
GET /goods/list?page=1&pageSize=10&keyword=苹果
```

**预期结果：**
- 返回所有分类中描述包含"苹果"的商品
- 不限定分类

### 测试用例4：无参数

**请求：**
```
GET /goods/list?page=1&pageSize=10
```

**预期结果：**
- 返回所有商品
- 按创建时间倒序排列

### 测试用例5：无效分类ID

**请求：**
```
GET /goods/list?page=1&pageSize=10&category_id=999
```

**预期结果：**
- 返回空列表（分类不存在）
- `total` 为 0

---

## 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| 1.0.0 | 2024-XX-XX | 初始版本，添加分类商品搜索接口文档 |

---

## 注意事项

1. **URL编码：**
   - 搜索关键词应进行 URL 编码（使用 `encodeURIComponent`）
   - 后端需要对关键词进行 URL 解码

2. **SQL注入防护：**
   - 后端应对所有参数进行验证和转义
   - 使用参数化查询，避免 SQL 注入

3. **性能考虑：**
   - 如果商品数据量大，建议对搜索结果进行限制
   - 考虑使用分页加载，避免一次性返回过多数据

4. **用户体验：**
   - 搜索时显示加载状态
   - 无搜索结果时显示友好提示
   - 支持清除搜索，恢复显示所有分类商品





