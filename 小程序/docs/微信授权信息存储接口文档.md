# 微信授权信息存储接口文档

## 概述

本文档描述了小程序中微信授权信息（头像、昵称）的存储机制。前端使用按 `user_id` 区分存储的方式，确保不同账号的微信授权信息互不干扰。

---

## 存储机制说明

### 前端存储方式

微信授权信息（`userinfo`）按 `user_id` 存储，使用 key 格式：`userinfo_{user_id}`

**示例：**
- 账号A（user_id=123）的微信授权信息存储在：`userinfo_123`
- 账号B（user_id=456）的微信授权信息存储在：`userinfo_456`

### 数据结构

```javascript
{
  avatar: "https://example.com/avatar.jpg",  // 用户头像URL（完整HTTP/HTTPS URL）
  nickname: "用户昵称"                        // 用户昵称
}
```

---

## 功能流程

### 1. 登录时恢复微信授权信息

**流程：**
1. 用户登录成功，获取 `user_id`
2. 前端根据 `user_id` 从 `userinfo_{user_id}` 中读取该账号的微信授权信息
3. 如果存在，自动恢复微信授权状态（`wxlogin = true`）
4. 如果不存在，显示"微信授权"提示

**代码示例：**
```javascript
// 登录成功后
const user_id = userInfo.user_id;
const savedUserinfo = getUserinfo(user_id); // 从 userinfo_{user_id} 读取

if (savedUserinfo && savedUserinfo.avatar && savedUserinfo.nickname) {
  // 自动恢复微信授权信息
  userInfo.nickname = savedUserinfo.nickname;
  wx.setStorageSync('wxlogin', true);
}
```

---

### 2. 退出登录时保留微信授权信息

**流程：**
1. 用户点击"退出登录"
2. 清除登录相关存储：`user_id`、`userInfo`、`wxlogin`
3. **不清除** `userinfo_{user_id}`（保留该账号的微信授权信息）
4. 跳转到登录页面

**代码示例：**
```javascript
// 退出登录时
const currentUserId = wx.getStorageSync('user_id');

// 清除登录相关信息
wx.removeStorageSync('user_id');
wx.removeStorageSync('userInfo');
wx.removeStorageSync('wxlogin');

// 注意：不清除 userinfo_{currentUserId}，这样下次登录该账号时可以恢复
```

---

### 3. 保存微信授权信息

**流程：**
1. 用户在"用户信息"页面设置头像和昵称
2. 上传头像到OSS（如果选择新头像）
3. 调用后端接口更新头像和昵称到数据库
4. 保存到本地存储：`setUserinfo(user_id, userinfo)`

**代码示例：**
```javascript
// 保存微信授权信息
const userinfo = {
  avatar: avatarUrl || '/assets/default_avatar.png',
  nickname: nickname.trim()
};
setUserinfo(user_id, userinfo); // 保存到 userinfo_{user_id}
wx.setStorageSync('wxlogin', true);
```

---

## 工具函数

前端提供了统一的工具函数来管理按 `user_id` 存储的微信授权信息：

### `getUserinfo(user_id)`

获取指定用户的微信授权信息。

**参数：**
- `user_id` (string|number): 用户ID

**返回值：**
- `Object|null`: 用户信息对象，包含 `avatar` 和 `nickname`，如果不存在则返回 `null`

**示例：**
```javascript
import { getUserinfo } from '../../utils/index'

const user_id = wx.getStorageSync('user_id');
const userinfo = getUserinfo(user_id);
if (userinfo) {
  console.log('头像:', userinfo.avatar);
  console.log('昵称:', userinfo.nickname);
}
```

---

### `setUserinfo(user_id, userinfo)`

保存指定用户的微信授权信息。

**参数：**
- `user_id` (string|number): 用户ID
- `userinfo` (Object): 用户信息对象，包含 `avatar` 和 `nickname`

**示例：**
```javascript
import { setUserinfo } from '../../utils/index'

const userinfo = {
  avatar: 'https://example.com/avatar.jpg',
  nickname: '用户昵称'
};
setUserinfo(user_id, userinfo);
```

---

### `removeUserinfo(user_id)`

删除指定用户的微信授权信息（通常不需要调用，退出登录时不清除）。

**参数：**
- `user_id` (string|number): 用户ID

**示例：**
```javascript
import { removeUserinfo } from '../../utils/index'

removeUserinfo(user_id);
```

---

## 后端接口（已存在，无需修改）

以下接口已存在，前端会调用这些接口将微信授权信息同步到数据库：

### 1. 更新用户头像

**接口地址：** `POST /user/updateAvatar`

**请求参数：**
```json
{
  "user_id": 123,
  "avatar": "https://example.com/avatar.jpg"
}
```

**响应：**
```json
{
  "msg": "success"
}
```

---

### 2. 更新用户昵称

**接口地址：** `POST /user/updateNickname`

**请求参数：**
```json
{
  "user_id": 123,
  "nickname": "用户昵称"
}
```

**响应：**
```json
{
  "msg": "success"
}
```

---

## 使用场景

### 场景1：账号A登录 → 设置微信授权 → 退出 → 账号B登录 → 账号A再次登录

**流程：**
1. 账号A登录，设置头像和昵称
   - 保存到：`userinfo_123`（假设账号A的user_id=123）
2. 账号A退出登录
   - 清除：`user_id`、`userInfo`、`wxlogin`
   - 保留：`userinfo_123`
3. 账号B登录
   - 检查：`userinfo_456`（假设账号B的user_id=456）
   - 如果不存在，显示"微信授权"
4. 账号A再次登录
   - 自动从 `userinfo_123` 恢复头像和昵称
   - 自动设置 `wxlogin = true`

---

### 场景2：多账号切换

**流程：**
1. 账号A登录并设置微信授权 → 保存到 `userinfo_123`
2. 账号A退出，账号B登录并设置微信授权 → 保存到 `userinfo_456`
3. 账号B退出，账号A再次登录 → 自动恢复账号A的微信授权信息
4. 账号A退出，账号B再次登录 → 自动恢复账号B的微信授权信息

---

## 注意事项

1. **存储隔离**：不同账号的微信授权信息完全隔离，互不干扰。
2. **退出登录不清除**：退出登录时不清除 `userinfo_{user_id}`，确保下次登录可以恢复。
3. **头像URL格式**：头像URL必须是完整的HTTP/HTTPS URL，不能是相对路径或示例URL。
4. **数据同步**：前端本地存储和数据库都会保存微信授权信息，确保数据一致性。
5. **工具函数**：统一使用工具函数 `getUserinfo`、`setUserinfo` 来管理微信授权信息，避免直接使用 `wx.getStorageSync('userinfo')`。

---

## 测试建议

1. **多账号测试**：
   - 账号A登录 → 设置头像和昵称 → 退出
   - 账号B登录 → 设置头像和昵称 → 退出
   - 账号A再次登录 → 验证是否恢复账号A的头像和昵称
   - 账号B再次登录 → 验证是否恢复账号B的头像和昵称

2. **数据隔离测试**：
   - 验证账号A的微信授权信息不会影响账号B
   - 验证账号B的微信授权信息不会影响账号A

3. **退出登录测试**：
   - 验证退出登录后，微信授权信息仍然保留
   - 验证再次登录时，微信授权信息可以恢复

---

## 更新日志

- 2024-01-15：初始版本，实现按 `user_id` 区分存储微信授权信息的功能。





